"use strict";function ui(){this._init();this.SIZE=core.__SIZE__;this.HSIZE=core.__HALF_SIZE__;this.LAST=this.SIZE-1;this.PIXEL=core.__PIXELS__;this.HPIXEL=this.PIXEL/2}ui.prototype._init=function(){this.uidata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.ui};ui.prototype.getContextByName=function(b){var a=b;if(typeof b=="string"){if(core.canvas[b]){a=core.canvas[b]}else{if(core.dymCanvas[b]){a=core.dymCanvas[b]}}}if(a&&a.canvas){return a}return null};ui.prototype._createUIEvent=function(){if(main.mode=="editor"){return}if(!core.dymCanvas.uievent){core.createCanvas("uievent",0,0,this.PIXEL,this.PIXEL,135)}};ui.prototype.clearMap=function(d,f,g,e,b){if(d=="all"){for(var c in core.canvas){core.canvas[c].clearRect(0,0,core.bigmap.width*32,core.bigmap.height*32)}core.dom.gif.innerHTML="";core.removeGlobalAnimate()}else{var a=this.getContextByName(d);if(a){a.clearRect(f||0,g||0,e||a.canvas.width,b||a.canvas.height)}}};ui.prototype._uievent_clearMap=function(a){if(main.mode!="editor"&&(a.x==null||a.y==null||a.width==null||a.height==null)){this.deleteCanvas("uievent");return}this._createUIEvent();this.clearMap("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height))};ui.prototype.fillText=function(d,f,g,h,e,b,c){if(e){core.setFillStyle(d,e)}if(b){core.setFont(d,b)}var a=this.getContextByName(d);if(a){if(c!=null){this._fillTextWithMaxWidth(a,f,g,h,c)}else{a.fillText(f,g,h)}}};ui.prototype._uievent_fillText=function(a){this._createUIEvent();this.fillText("uievent",core.replaceText(a.text),core.calValue(a.x),core.calValue(a.y),a.style,a.font,a.maxWidth)};ui.prototype._fillTextWithMaxWidth=function(a,e,g,h,d){var b=a.font,f=/(\d+)px/.exec(b);if(f==null){return a.fillText(e,g,h)}for(var c=parseInt(f[1]);c>=8;c--){a.font=b.replace(/(\d+)px/,c+"px");if(a.measureText(e).width<=d){break}}a.fillText(e,g,h);a.font=b};ui.prototype.fillBoldText=function(c,e,f,g,d,b){var a=this.getContextByName(c);if(!a){return}if(b){a.font=b}if(!d){d=a.fillStyle}if(d instanceof Array){d=core.arrayToRGBA(d)}a.fillStyle="#000000";a.fillText(e,f-1,g-1);a.fillText(e,f-1,g+1);a.fillText(e,f+1,g-1);a.fillText(e,f+1,g+1);a.fillStyle=d;a.fillText(e,f,g)};ui.prototype._uievent_fillBoldText=function(a){this._createUIEvent();this.fillBoldText("uievent",core.replaceText(a.text),core.calValue(a.x),core.calValue(a.y),a.style,a.font)};ui.prototype.fillRect=function(c,f,g,e,b,d){if(d){core.setFillStyle(c,d)}var a=this.getContextByName(c);if(a){a.fillRect(f,g,e,b)}};ui.prototype._uievent_fillRect=function(a){this._createUIEvent();this.fillRect("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height),a.style)};ui.prototype.fillPolygon=function(c,d,e){if(e){core.setFillStyle(c,e)}var a=this.getContextByName(c);if(!a){return}if(!d||d.length<3){return}a.beginPath();for(var b=0;b<d.length;++b){var f=core.calValue(d[b][0]),g=core.calValue(d[b][1]);if(b==0){a.moveTo(f,g)}else{a.lineTo(f,g)}}a.closePath();a.fill()};ui.prototype._uievent_fillPolygon=function(a){this._createUIEvent();this.fillPolygon("uievent",a.nodes,a.style)};ui.prototype.strokeRect=function(d,g,h,f,b,e,c){if(e){core.setStrokeStyle(d,e)}if(c){core.setLineWidth(d,c)}var a=this.getContextByName(d);if(a){a.strokeRect(g,h,f,b)}};ui.prototype._uievent_strokeRect=function(a){this._createUIEvent();this.strokeRect("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height),a.style,a.lineWidth)};ui.prototype.strokePolygon=function(d,e,f,c){if(f){core.setStrokeStyle(d,f)}if(c){core.setLineWidth(d,c)}var a=this.getContextByName(d);if(!a){return}if(!e||e.length<3){return}a.beginPath();for(var b=0;b<e.length;++b){var g=core.calValue(e[b][0]),h=core.calValue(e[b][1]);if(b==0){a.moveTo(g,h)}else{a.lineTo(g,h)}}a.closePath();a.stroke()};ui.prototype._uievent_strokePolygon=function(a){this._createUIEvent();this.strokePolygon("uievent",a.nodes,a.style,a.lineWidth)};ui.prototype.fillCircle=function(b,e,f,c,d){if(d){core.setFillStyle(b,d)}var a=this.getContextByName(b);if(!a){return}a.beginPath();a.arc(e,f,c,0,2*Math.PI);a.fill()};ui.prototype._uievent_fillCircle=function(a){this._createUIEvent();this.fillCircle("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.r),a.style)};ui.prototype.strokeCircle=function(c,f,g,d,e,b){if(e){core.setStrokeStyle(c,e)}if(b){core.setLineWidth(c,b)}var a=this.getContextByName(c);if(!a){return}a.beginPath();a.arc(f,g,d,0,2*Math.PI);a.stroke()};ui.prototype._uievent_strokeCircle=function(a){this._createUIEvent();this.strokeCircle("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.r),a.style,a.lineWidth)};ui.prototype.drawLine=function(c,e,g,f,h,d,b){if(d){core.setStrokeStyle(c,d)}if(b!=null){core.setLineWidth(c,b)}var a=this.getContextByName(c);if(!a){return}a.beginPath();a.moveTo(e,g);a.lineTo(f,h);a.stroke()};ui.prototype._uievent_drawLine=function(a){this._createUIEvent();this.drawLine("uievent",core.calValue(a.x1),core.calValue(a.y1),core.calValue(a.x2),core.calValue(a.y2),a.style,a.lineWidth)};ui.prototype.drawArrow=function(g,i,k,j,l,h,f){if(i==j&&k==l){return}if(h){core.setStrokeStyle(g,h)}if(f!=null){core.setLineWidth(g,f)}var b=this.getContextByName(g);if(!b){return}var e=10;var c=j-i,d=l-k;var a=Math.atan2(d,c);b.beginPath();b.moveTo(i,k);b.lineTo(j,l);b.lineTo(j-e*Math.cos(a-Math.PI/6),l-e*Math.sin(a-Math.PI/6));b.moveTo(j,l);b.lineTo(j-e*Math.cos(a+Math.PI/6),l-e*Math.sin(a+Math.PI/6));b.stroke()};ui.prototype._uievent_drawArrow=function(a){this._createUIEvent();this.drawArrow("uievent",core.calValue(a.x1),core.calValue(a.y1),core.calValue(a.x2),core.calValue(a.y2),a.style,a.lineWidth)};ui.prototype.setFont=function(c,b){var a=this.getContextByName(c);if(a){a.font=b}};ui.prototype.setLineWidth=function(c,b){var a=this.getContextByName(c);if(a){a.lineWidth=b}};ui.prototype.saveCanvas=function(b){var a=this.getContextByName(b);if(a){a.save()}};ui.prototype.loadCanvas=function(b){var a=this.getContextByName(b);if(a){a.restore()}};ui.prototype.setAlpha=function(c,a){var b=this.getContextByName(c);if(b){b.globalAlpha=a}};ui.prototype.setOpacity=function(b,c){var a=this.getContextByName(b);if(a){a.canvas.style.opacity=c}};ui.prototype.setFillStyle=function(b,c){var a=this.getContextByName(b);if(c instanceof Array){c=core.arrayToRGBA(c)}if(a){a.fillStyle=c}};ui.prototype.setStrokeStyle=function(b,c){var a=this.getContextByName(b);if(c instanceof Array){c=core.arrayToRGBA(c)}if(a){a.strokeStyle=c}};ui.prototype.setTextAlign=function(c,a){var b=this.getContextByName(c);if(b){b.textAlign=a}};ui.prototype.setTextBaseline=function(c,a){var b=this.getContextByName(c);if(b){b.textBaseline=a}};ui.prototype._uievent_setAttribute=function(a){this._createUIEvent();if(a.font){this.setFont("uievent",a.font)}if(a.lineWidth){this.setLineWidth("uievent",a.lineWidth)}if(a.alpha!=null){this.setAlpha("uievent",a.alpha)}if(a.fillStyle){this.setFillStyle("uievent",a.fillStyle)}if(a.strokeStyle){this.setStrokeStyle("uievent",a.strokeStyle)}if(a.align){this.setTextAlign("uievent",a.align)}if(a.baseline){this.setTextBaseline("uievent",a.baseline)}if(a.z!=null&&main.mode!="editor"){var b=parseInt(a.z)||135;core.dymCanvas.uievent.canvas.style.zIndex=b;if(core.dymCanvas._uievent_selector){core.dymCanvas._uievent_selector.canvas.style.zIndex=b+1}}};ui.prototype.calWidth=function(c,d,b){var a=this.getContextByName(c);if(a){if(b){a.font=b}return a.measureText(d).width}return 0};ui.prototype.splitLines=function(g,h,f,c){var b=this.getContextByName(g);if(!b){return[h]}if(c){core.setFont(g,c)}var a=[];var e=0;for(var d=0;d<h.length;d++){if(h.charAt(d)=="\n"){a.push(h.substring(e,d));e=d+1}else{if(h.charAt(d)=="\\"&&h.charAt(d+1)=="n"){a.push(h.substring(e,d));e=d+2}else{var j=h.substring(e,d+1);var k=core.calWidth(g,j);if(f&&k>f){a.push(h.substring(e,d));e=d}}}}a.push(h.substring(e));return a};ui.prototype.drawImage=function(e,d,i,k,f,b,j,l,g,c){var a=this.getContextByName(e);if(!a){return}if(typeof d=="string"){d=core.getMappedName(d);d=core.material.images.images[d];if(!d){return}}if(i!=null&&k!=null){if(f!=null&&b!=null){if(j!=null&&l!=null&&g!=null&&c!=null){a.drawImage(d,i,k,f,b,j,l,g,c);return}a.drawImage(d,i,k,f,b);return}a.drawImage(d,i,k);return}};ui.prototype._uievent_drawImage=function(a){this._createUIEvent();this.drawImage("uievent",a.image,core.calValue(a.x),core.calValue(a.y),core.calValue(a.w),core.calValue(a.h),core.calValue(a.x1),core.calValue(a.y1),core.calValue(a.w1),core.calValue(a.h1))};ui.prototype.drawIcon=function(e,c,g,i,f,b){var a=this.getContextByName(e);if(!a){return}var d=core.getBlockInfo(c);if(!d){if(core.statusBar.icons[c] instanceof Image){d={image:core.statusBar.icons[c],posX:0,posY:0,height:32}}else{return}}a.drawImage(d.image,32*d.posX,d.height*d.posY,32,d.height,g,i,f||32,b||d.height)};ui.prototype._uievent_drawIcon=function(a){this._createUIEvent();var c;try{c=core.calValue(a.id);if(typeof c!=="string"){c=a.id}}catch(b){c=a.id}this.drawIcon("uievent",c,core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height))};ui.prototype.closePanel=function(){this.clearUI();core.maps.generateGroundPattern();core.updateStatusBar(true);core.unLockControl();core.status.event.data=null;core.status.event.id=null;core.status.event.selection=null;core.status.event.ui=null;core.status.event.interval=null};ui.prototype.clearUI=function(){core.status.boxAnimateObjs=[];if(core.dymCanvas._selector){core.deleteCanvas("_selector")}main.dom.next.style.display="none";core.clearMap("ui");core.setAlpha("ui",1)};ui.prototype.drawTip=function(e,b,a){this.clearTip();var d={text:e,textX:21,width:26+core.calWidth("data",e,"16px Arial"),opacity:0.1,stage:1,time:0};if(b!=null){var c=core.getBlockInfo(b);if(c==null||!c.image){if(core.statusBar.icons[b] instanceof Image){b={image:core.statusBar.icons[b],posX:0,posY:0,height:32}}else{c=null}}if(c!=null){d.image=c.image;d.posX=c.posX;d.posY=c.posY;d.height=c.height;d.textX+=24;d.width+=24}}core.animateFrame.tips.list.push(d);if(core.animateFrame.tips.list.length>3){core.animateFrame.tips.list.shift()}};ui.prototype._drawTip_drawOne=function(b,a){core.setAlpha("data",b.opacity);core.fillRect("data",5,a+5,b.width,42,"#000000");if(b.image){core.drawImage("data",b.image,b.posX*32,b.posY*b.height,32,32,10,a+10,32,32)}core.fillText("data",b.text,b.textX,a+33,"#FFFFFF");core.setAlpha("data",1)};ui.prototype.clearTip=function(){core.animateFrame.tips.list=[];core.animateFrame.tips.offset=0;core.animateFrame.tips.lastSize=0};ui.prototype.drawText=function(b,a){if(b!=null){return this._drawText_setContent(b,a)}if(core.status.event.data.list.length==0){var a=core.status.event.data.callback;core.ui.closePanel(false);if(a){a()}return}var c=core.status.event.data.list.shift();if(typeof c=="string"){core.ui.drawTextBox(c)}else{core.ui.drawTextBox(c.content,c.id)}};ui.prototype._drawText_setContent=function(b,a){if((core.status.event&&core.status.event.id=="action")||(!core.hasFlag("__replayText__")&&core.isReplaying())){core.insertAction(b,null,null,a);return}if(!(b instanceof Array)){b=[b]}core.status.event={id:"text",data:{list:b,callback:a}};core.lockControl();core.waitHeroToStop(core.drawText);return};ui.prototype._getTitleAndIcon=function(b){var f=null,e=null,d=null,c=32,a=1;b=b.replace(/(\t|\\t)\[(([^\],]+),)?([^\],]+)\]/g,function(h,i,j,k,l){if(l){if(l=="hero"){f=core.status.hero.name;e=core.material.images.hero;d=0;var m=core.material.icons.hero.width||32;c=32*core.material.icons.hero.height/m}else{if(l.endsWith(".png")){l=core.getMappedName(l);e=core.material.images.images[l]}else{var g=core.getBlockInfo(l);if(g!=null){if(g.name){f=g.name}e=g.image;d=g.posY;c=g.height;a=g.animate}else{f=l}}}}if(k!=null){f=k;if(f=="null"){f=null}}return""});return{content:b,title:f,image:e,icon:d,height:c,animate:a}};ui.prototype._getPosition=function(a){var c=null,d=null,e=null,b=false;if(core.status.event.id=="action"){d=core.status.event.data.x;e=core.status.event.data.y}a=a.replace("\b","\\b").replace(/\\b\[(up|center|down|hero|null)(,(hero|null|\d+,\d+|\d+))?]/g,function(g,h,i,j){c=h;if(j=="hero"||h=="hero"&&!j){d=core.status.hero.loc.x;e=core.status.hero.loc.y}else{if(j=="null"){d=e=null}else{if(j){var k=j.split(",");d=e=null;if(k.length==1){var f=(core.status.hero.followers||[])[parseInt(k[0])-1];if(f){d=f.x;e=f.y}}else{d=parseInt(k[0]);e=parseInt(k[1]);b=core.getBlockId(d,e)==null}}}}if(c=="hero"||c=="null"){c=e==null?"center":(e>=core.__HALF_SIZE__?"up":"down")}return""});return{content:a,position:c,px:d,py:e,noPeak:b}};ui.prototype.drawWindowSelector=function(a,e,f,d,c){d=Math.round(d),c=Math.round(c);var b=core.ui.createCanvas("_selector",e,f,d,c,165);this._drawSelector(b,a,d,c)};ui.prototype._uievent_drawSelector=function(d){var b="_uievent_selector_"+(d.code||0);if(d.image==null){return core.deleteCanvas(b)}var a=d.image||core.status.textAttribute.background;if(typeof a!="string"){return}var g=core.calValue(d.x),i=core.calValue(d.y),f=core.calValue(d.width),e=core.calValue(d.height);f=Math.round(f);e=Math.round(e);if(main.mode=="editor"){this._drawSelector("uievent",a,f,e,g,i);return}var j=136;if(core.dymCanvas.uievent){j=(parseInt(core.dymCanvas.uievent.canvas.style.zIndex)||135)+1}var c=core.createCanvas(b,g,i,f,e,j);c.canvas.classList.add("_uievent_selector");this._drawSelector(c,a,f,e)};ui.prototype._drawSelector=function(b,a,f,c,d,e){d=d||0;e=e||0;b=this.getContextByName(b);if(!b){return}if(typeof a=="string"){a=core.material.images.images[a]}if(!(a instanceof Image)){return}b.drawImage(a,130,66,28,28,d+2,e+2,f-4,c-4);b.drawImage(a,128,64,2,2,d,e,2,2);b.drawImage(a,158,64,2,2,d+f-2,e,2,2);b.drawImage(a,128,94,2,2,d,e+c-2,2,2);b.drawImage(a,158,94,2,2,d+f-2,e+c-2,2,2);b.drawImage(a,130,64,28,2,d+2,e,f-4,2);b.drawImage(a,130,94,28,2,d+2,e+c-2,f-4,2);b.drawImage(a,128,66,2,28,d,e+2,2,c-4);b.drawImage(a,158,66,2,28,d+f-2,e+2,2,c-4)};ui.prototype.drawWindowSkin=function(a,d,n,o,m,j,e,k,l){a=a||core.status.textAttribute.background;if(typeof a=="string"){a=core.getMappedName(a);a=core.material.images.images[a]}var f=core.getContextByName(d);if(!f){return}f.drawImage(a,0,0,128,128,n+2,o+2,m-4,j-4);f.drawImage(a,128,0,16,16,n,o,16,16);for(var g=0;g<m-64;g+=32){f.drawImage(a,144,0,32,16,n+g+16,o,32,16);f.drawImage(a,144,48,32,16,n+g+16,o+j-16,32,16)}f.drawImage(a,144,0,m-g-32,16,n+g+16,o,m-g-32,16);f.drawImage(a,144,48,m-g-32,16,n+g+16,o+j-16,m-g-32,16);f.drawImage(a,176,0,16,16,n+m-16,o,16,16);for(var i=0;i<j-64;i+=32){f.drawImage(a,128,16,16,32,n,o+i+16,16,32);f.drawImage(a,176,16,16,32,n+m-16,o+i+16,16,32)}f.drawImage(a,128,16,16,j-i-32,n,o+i+16,16,j-i-32);f.drawImage(a,176,16,16,j-i-32,n+m-16,o+i+16,16,j-i-32);f.drawImage(a,128,48,16,16,n,o+j-16,16,16);f.drawImage(a,176,48,16,16,n+m-16,o+j-16,16,16);if(k!=null&&l!=null){if(e=="up"){f.drawImage(a,128,96,32,32,k,o+j-3,32,32)}else{if(e=="down"){f.drawImage(a,160,96,32,32,k,o-29,32,32)}}}var b=parseInt(m/2);f.drawImage(a,160,90,16,6,n+b-8,o,16,6)};ui.prototype.drawBackground=function(c,h,g,b,d){d=d||{};var e=d.px==null||d.noPeak?null:d.px*32-core.bigmap.offsetX;var f=d.py==null||d.noPeak?null:d.py*32-core.bigmap.offsetY;var i=d.xoffset||0,j=d.yoffset||0;var a=core.status.textAttribute.background;if(this._drawBackground_drawWindowSkin(a,c,h,g,b,d.position,e,f)){return true}if(typeof a=="string"){a=core.initStatus.textAttribute.background}this._drawBackground_drawColor(a,c,h,g,b,d.position,e,f,i,j);return false};ui.prototype._uievent_drawBackground=function(b){this._createUIEvent();var a=b.background||core.status.textAttribute.background;var e=core.calValue(b.x),f=core.calValue(b.y),d=core.calValue(b.width),c=core.calValue(b.height);if(typeof a=="string"){this.drawWindowSkin(a,"uievent",e,f,d,c)}else{if(a instanceof Array){this.fillRect("uievent",e,f,d,c,core.arrayToRGBA(a));this.strokeRect("uievent",e,f,d,c)}}};ui.prototype._drawWindowSkin_getOpacity=function(){return core.getFlag("__winskin_opacity__",0.85)};ui.prototype._drawBackground_drawWindowSkin=function(a,d,i,h,b,e,f,g){if(typeof a=="string"&&core.material.images.images[a]){var c=core.material.images.images[a];if(c.width==192&&c.height==128){core.setAlpha("ui",this._drawWindowSkin_getOpacity());this.drawWindowSkin(c,"ui",d,i,h-d,b-i,e,f,g);core.setAlpha("ui",1);return true}}return false};ui.prototype._drawBackground_drawColor=function(b,e,j,i,c,f,g,h,k,l){var a=b[3];core.setAlpha("ui",a);core.setStrokeStyle("ui",core.status.globalAttribute.borderColor);core.setFillStyle("ui",core.arrayToRGB(b));core.setLineWidth("ui",2);var d=core.canvas.ui;d.beginPath();d.moveTo(e,j);if(f=="down"&&g!=null&&h!=null){d.lineTo(g+k,j);d.lineTo(g+16,j-l);d.lineTo(g+32-k,j)}d.lineTo(i,j);d.lineTo(i,c);if(f=="up"&&g!=null&&h!=null){d.lineTo(g+32-k,c);d.lineTo(g+16,c+l);d.lineTo(g+k,c)}d.lineTo(e,c);d.closePath();d.fill();d.stroke();core.setAlpha("ui",1)};ui.prototype._calTextBoxWidth=function(c,b,f,e,d){var a=core.splitLines(c,b,null,d);if(a.length==1){var g=core.calWidth(c,a[0])+10;if(g<f*2.3){return core.clamp(g/1.4,f,e)}if(g<e*2.2){return core.clamp(g/2.4,f,e)}return core.clamp(g/3.4,f,e)}else{return core.clamp(a.reduce(function(i,h){return Math.max(i,core.calWidth(c,h)+10)},0),f,e)}};ui.prototype._getDrawableIconInfo=function(b){if(b&&b.indexOf("flag:")===0){b=core.getFlag(b.substring(5),b)}var c=null,a=null;["terrains","animates","items","npcs","enemys"].forEach(function(d){if(core.material.icons[d][b]!=null){c=core.material.images[d];a=core.material.icons[d][b]}});if(c==null&&b in core.statusBar.icons){c=core.statusBar.icons[b];a=0}return[c,a]};ui.prototype._buildFont=function(b,a,d){var e=core.status.textAttribute||core.initStatus.textAttribute,c=core.status.globalAttribute||core.initStatus.globalAttribute;if(a==null){a=e.bold}return(a?"bold ":"")+(d?"italic ":"")+(b||e.textfont)+"px "+c.font};ui.prototype.drawTextContent=function(c,b,a){c=core.getContextByName(c);var e=core.status.textAttribute||core.initStatus.textAttribute;a=core.clone(a||{});a.left=a.left||0;a.right=a.left+(a.maxWidth==null?(c!=null?c.canvas.width:core.__PIXELS__):a.maxWidth);a.top=a.top||0;a.color=a.color||e.text;if(a.color instanceof Array){a.color=core.arrayToRGBA(a.color)}if(a.bold==null){a.bold=e.bold}a.italic=false;a.align=a.align||e.align||"left";a.fontSize=a.fontSize||e.textfont;a.lineHeight=a.lineHeight||(a.fontSize*1.3);a.time=a.time||0;a.interval=a.interval==null?(e.interval||0):a.interval;a.index=0;a.currcolor=a.color;a.currfont=a.fontSize;a.lineMargin=Math.max(0,a.lineHeight-a.fontSize);a.topMargin=parseInt(a.lineMargin/2);a.lineMaxHeight=a.lineMargin+a.fontSize;a.offsetX=0;a.offsetY=0;a.line=0;a.blocks=[];var d=core.createCanvas("__temp__",0,0,c==null?1:c.canvas.width,c==null?1:c.canvas.height,-1);d.textBaseline="top";d.font=this._buildFont(a.fontSize,a.bold,a.italic);d.fillStyle=a.color;a=this._drawTextContent_draw(c,d,b,a);core.deleteCanvas("__temp__");return a};ui.prototype._uievent_drawTextContent=function(a){this._createUIEvent();a.left=core.calValue(a.left);a.top=core.calValue(a.top);this.drawTextContent("uievent",core.replaceText(a.text),a)};ui.prototype._drawTextContent_draw=function(d,e,c,b){while(this._drawTextContent_next(e,c,b)){}if(d==null){return b}b.index=0;var a=function(){if(b.index>=b.blocks.length){return false}var f=b.blocks[b.index++];d.drawImage(e.canvas,f.left,f.top,f.width,f.height,b.left+f.left+f.marginLeft,b.top+f.top+f.marginTop,f.width,f.height);return true};if(b.time==0){while(a()){}}else{core.status.event.interval=setInterval(function(){if(!a()){clearInterval(core.status.event.interval);core.status.event.interval=null}},b.time)}return b};ui.prototype._drawTextContent_next=function(d,c,b){if(b.index>=c.length){this._drawTextContent_newLine(d,b);return false}var a=c.charAt(b.index++);return this._drawTextContent_drawChar(d,c,b,a)};ui.prototype._drawTextContent_drawChar=function(h,f,e,b){if(b=="\n"||(b=="\\"&&f.charAt(e.index)=="n")){this._drawTextContent_newLine(h,e);if(b=="\\"){e.index++}return this._drawTextContent_next(h,f,e)}if(b=="\r"||(b=="\\"&&f.charAt(e.index)=="r")){if(b=="\\"){e.index++}return this._drawTextContent_changeColor(h,f,e)}if(b=="\\"){var a=f.charAt(e.index);if(a=="i"){return this._drawTextContent_drawIcon(h,f,e)}if(a=="c"){return this._drawTextContent_changeFont(h,f,e)}if(a=="d"||a=="e"){e.index++;if(a=="d"){e.bold=!e.bold}if(a=="e"){e.italic=!e.italic}h.font=this._buildFont(e.currfont,e.bold,e.italic);return true}}if(b=="\\"&&f.charAt(e.index)=="e"){e.italic=!e.italic;h.font=this._buildFont(e.fontSize,e.bold,e.italic)}var d=core.calWidth(h,b)+e.interval;if(e.maxWidth!=null&&e.offsetX+d>e.maxWidth){this._drawTextContent_newLine(h,e);e.index--;return this._drawTextContent_next(h,f,e)}var g=e.offsetX,i=e.offsetY+e.topMargin;core.fillText(h,b,g,i);e.blocks.push({left:e.offsetX,top:e.offsetY,width:d,height:e.currfont+e.lineMargin,line:e.line,marginLeft:0});e.offsetX+=d;return true};ui.prototype._drawTextContent_newLine=function(c,a){var e=a.offsetX,d=a.right-a.left;var b=0;if(a.align=="center"){b=(d-e)/2}else{if(a.align=="right"){b=d-e}}a.blocks.forEach(function(f){if(f.line==a.line){f.marginLeft=b;f.marginTop=(a.lineMaxHeight-f.height)/2}});a.offsetX=0;a.offsetY+=a.lineMaxHeight;a.lineMaxHeight=a.currfont+a.lineMargin;a.line++};ui.prototype._drawTextContent_changeColor=function(f,b,a){var c=a.index,d;if(b.charAt(c)=="["&&((d=b.indexOf("]",c))>=0)){var e=b.substring(c+1,d);if(e==""){f.fillStyle=a.color}else{f.fillStyle=e}a.index=d+1}else{f.fillStyle=a.color}return this._drawTextContent_next(f,b,a)};ui.prototype._drawTextContent_changeFont=function(f,b,a){a.index++;var c=a.index,d;if(b.charAt(c)=="["&&((d=b.indexOf("]",c))>=0)){var e=b.substring(c+1,d);if(!/^\d+$/.test(e)){a.currfont=a.fontSize}else{a.currfont=parseInt(e)}a.index=d+1}else{a.currfont=a.fontSize}a.lineMaxHeight=Math.max(a.lineMaxHeight,a.currfont+a.lineMargin);f.font=this._buildFont(a.currfont,a.bold,a.italic);return this._drawTextContent_next(f,b,a)};ui.prototype._drawTextContent_drawIcon=function(j,b,a){var f=a.index,g;if(b.charAt(a.index+1)=="["&&((g=b.indexOf("]",f+1))>=0)){var i=b.substring(f+2,g);var d=core.ui._getDrawableIconInfo(i),e=d[0],c=d[1];if(e==null){return this._drawTextContent_next(j,b,a)}var l=a.currfont+2,h=a.offsetX+2,k=a.offsetY+a.topMargin-1;if(a.maxWidth!=null&&h+l>a.maxWidth){this._drawTextContent_newLine(j,a);a.index--;return this._drawTextContent_next(j,b,a)}core.drawImage(j,e,0,32*c,32,32,h,k,l,l);a.blocks.push({left:h,top:a.offsetY,width:l,height:l+a.lineMargin,line:a.line,marginLeft:0});a.offsetX+=l+6;a.index=g+1;return true}return this._drawTextContent_next(j,b,a)};ui.prototype.getTextContentHeight=function(b,a){return this.drawTextContent(null,b,a).offsetY};ui.prototype._getRealContent=function(a){return a.replace(/(\r|\\(r|c|d|e))(\[.*?])?/g,"").replace(/(\\i)(\[.*?])?/g,"占1")};ui.prototype.drawTextBox=function(c,j){if(core.status.event&&core.status.event.id=="action"){core.status.event.ui=c}this.clearUI();c=core.replaceText(c);var k=core.status.textAttribute;var l=this._getTitleAndIcon(c);var i=this._getPosition(l.content);if(i.position!="up"&&i.position!="down"){i.px=i.py=null}if(!i.position){i.position=k.position}c=this._drawTextBox_drawImages(i.content);var e=this._drawTextBox_getHorizontalPosition(c,l,i);var m=this._drawTextBox_getVerticalPosition(c,l,i,e.validWidth);var h=core.clone(i);h.xoffset=e.xoffset;h.yoffset=m.yoffset-4;var f=this.drawBackground(e.left,m.top,e.right,m.bottom,h);var a=f?this._drawWindowSkin_getOpacity():k.background[3];var d=this._drawTextBox_drawTitleAndIcon(l,e,m,a);var b=this.drawTextContent("ui",c,{left:e.content_left,top:d,maxWidth:e.validWidth,lineHeight:m.lineHeight,time:(j||k.time<=0||core.status.event.id!="action")?0:k.time});main.dom.next.style.display="block";main.dom.next.style.borderRightColor=main.dom.next.style.borderBottomColor=core.arrayToRGB(k.text);main.dom.next.style.top=(m.bottom-20)*core.domStyle.scale+"px";var g=(e.left+e.right)/2;if(h.position=="up"&&!h.noPeak&&h.px!=null&&Math.abs(h.px*32+16-g)<50){g=e.right-64}main.dom.next.style.left=g*core.domStyle.scale+"px";return b};ui.prototype._drawTextBox_drawImages=function(a){return a.replace(/(\f|\\f)\[(.*?)]/g,function(f,e,d){var c=d.split(",");if(c.length!=3&&c.length!=5&&c.length!=9){return""}c[0]=core.getMappedName(c[0]);var b=core.material.images.images[c[0]];if(!b){return""}if(c.length==3){core.drawImage("ui",b,parseFloat(c[1]),parseFloat(c[2]))}else{if(c.length==5){core.drawImage("ui",b,0,0,b.width,b.height,parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]),parseFloat(c[4]))}else{if(c.length==9||c.length==10){if(c.length==10){core.setAlpha("ui",parseFloat(c[9]))}core.drawImage("ui",b,parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]),parseFloat(c[4]),parseFloat(c[5]),parseFloat(c[6]),parseFloat(c[7]),parseFloat(c[8]));core.setAlpha("ui",1)}}}return""})};ui.prototype._drawTextBox_getHorizontalPosition=function(a,j,g){var h=this._getRealContent(a);var e=25,f=12;if(g.px!=null&&g.py!=null){e=20}if(j.icon!=null){e=62}else{if(j.image){e=90}}var b=7+3*(this.HSIZE-6),i=this.PIXEL-b,l=i-b,k=l-e-f;if(g.px!=null&&g.py!=null){var d=220-e,c=k;if(j.image==null){d=160}k=this._calTextBoxWidth("ui",h,d,c,this._buildFont());l=k+e+f;b=core.clamp(32*g.px+16-l/2-core.bigmap.offsetX,b,i-l);i=b+l}return{left:b,right:i,width:l,validWidth:k,xoffset:11,content_left:b+e}};ui.prototype._drawTextBox_getVerticalPosition=function(a,f,d,h){var e=core.status.textAttribute||core.initStatus.textAttribute;var c=e.textfont+6;var b=45+this.getTextContentHeight(a,{lineHeight:c,maxWidth:h});if(f.title){b+=e.titlefont+5}if(f.icon!=null){if(f.title){b=Math.max(b,f.height+50)}else{b=Math.max(b,f.height+30)}}else{if(f.image){b=Math.max(b,90)}}var i=16;var g=parseInt((this.PIXEL-b)/2);switch(d.position){case"center":g=parseInt((this.PIXEL-b)/2);break;case"up":if(d.px==null||d.py==null){g=5+e.offset}else{g=32*d.py-b-(f.height-32)-i-core.bigmap.offsetY}break;case"down":if(d.px==null||d.py==null){g=this.PIXEL-b-5-e.offset}else{g=32*d.py+32+i-core.bigmap.offsetY}}return{top:g,height:b,bottom:g+b,yoffset:i,lineHeight:c}};ui.prototype._drawTextBox_drawTitleAndIcon=function(i,c,j,a){core.setTextAlign("ui","left");var e=core.status.textAttribute;var b=j.top+15;var d=j.top+15;if(i.title!=null){var h=e.titlefont;b+=h+5;d=j.top+40;core.setFillStyle("ui",core.arrayToRGB(e.title));core.setStrokeStyle("ui",core.arrayToRGB(e.title));var g=core.calWidth("ui",i.title,this._buildFont(h,true));var f=c.content_left;if(e.align=="center"){f=c.left+(c.width-g)/2}else{if(e.align=="right"){f=c.right-g-12}}core.fillText("ui",i.title,f,j.top+8+h)}if(i.icon!=null){core.setAlpha("ui",a);core.strokeRect("ui",c.left+15-1,d-1,34,i.height+2,null,2);core.setAlpha("ui",1);core.status.boxAnimateObjs=[];if(i.image==core.material.images.hero){core.clearMap("ui",c.left+15,d,32,i.height);core.fillRect("ui",c.left+15,d,32,i.height,core.material.groundPattern);core.drawImage("ui",i.image,0,0,core.material.icons.hero.width||32,core.material.icons.hero.height,c.left+15,d,32,i.height)}else{core.status.boxAnimateObjs.push({bgx:c.left+15,bgy:d,bgWidth:32,bgHeight:i.height,x:c.left+15,y:d,height:i.height,animate:i.animate,image:i.image,pos:i.icon*i.height})}core.drawBoxAnimate()}if(i.image!=null&&i.icon==null){core.drawImage("ui",i.image,0,0,i.image.width,i.image.height,c.left+10,j.top+10,70,70)}return b};ui.prototype._createTextCanvas=function(a,d){var e=this.PIXEL,c=30+this.getTextContentHeight(a,{lineHeight:d});var b=document.createElement("canvas").getContext("2d");b.canvas.width=e;b.canvas.height=c;b.clearRect(0,0,e,c);return b};ui.prototype.drawScrollText=function(b,g,d,a){b=core.replaceText(b||"");d=d||1.4;g=g||5000;this.clearUI();var f=core.status.textAttribute.offset||15;d*=core.status.textAttribute.textfont;var c=this._createTextCanvas(b,d);var e={align:core.status.textAttribute.align,lineHeight:d};if(e.align=="right"){e.left=this.PIXEL-f}else{if(e.align!="center"){e.left=f}}this.drawTextContent(c,b,e);this._drawScrollText_animate(c,g,a)};ui.prototype._drawScrollText_animate=function(c,h,b){h/=Math.max(core.status.replay.speed,1);var f=1,e=c.canvas.height,g=h*f/(this.PIXEL+e);var d=this.PIXEL;core.drawImage("ui",c.canvas,0,d);var a=setInterval(function(){core.clearMap("ui");d-=f;if(d<-e){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}return}core.drawImage("ui",c.canvas,0,d)},g);core.animateFrame.asyncId[a]=true};ui.prototype.textImage=function(a,c){a=core.replaceText(a||"");c=c||1.4;c*=core.status.textAttribute.textfont;var b=this._createTextCanvas(a,c);this.drawTextContent(b,a,{align:core.status.textAttribute.align,lineHeight:c});return b.canvas};ui.prototype.drawChoices=function(b,a){a=core.clone(a||[]);core.status.event.ui={text:b,choices:a};this.clearUI();b=core.replaceText(b||"");var e=this._getTitleAndIcon(b);e.content=this._drawTextBox_drawImages(e.content);var c=this._drawChoices_getHorizontalPosition(e,a);var f=this._drawChoices_getVerticalPosition(e,a,c);core.status.event.ui.offset=f.offset;var d=this.drawBackground(c.left,f.top,c.right,f.bottom);this._drawChoices_drawTitle(e,c,f);this._drawChoices_drawChoices(a,d,c,f)};ui.prototype._drawChoices_getHorizontalPosition=function(f,a){var h=246;core.setFont("ui",this._buildFont(17,true));for(var c=0;c<a.length;c++){if(typeof a[c]==="string"){a[c]={text:a[c]}}a[c].text=core.replaceText(a[c].text);a[c].width=core.calWidth("ui",core.replaceText(a[c].text));if(a[c].icon!=null){a[c].width+=28}h=Math.max(h,a[c].width+30)}var d=(this.PIXEL-h)/2,e=d+h;var b=d+(f.icon==null?15:60),g=e-b-10;return{left:d,right:e,width:h,content_left:b,validWidth:g}};ui.prototype._drawChoices_getVerticalPosition=function(i,c,f){var g=c.length;var e=32*(g+2),a=this.HPIXEL+e/2;if(g%2==0){a+=16}var h=0;var b=a-e+56;if(i.content){var d=0;if(i.title){d+=25}d+=this.getTextContentHeight(i.content,{lineHeight:20,maxWidth:f.validWidth,fontSize:15,bold:true});e+=d;if(a-e<=32){h=Math.floor(d/64);a+=32*h;b+=32*h}}return{top:a-e,height:e,bottom:a,choice_top:b,offset:h}};ui.prototype._drawChoices_drawTitle=function(d,b,e){if(!d.content){return}var a=e.top+21;if(d.title!=null){core.setTextAlign("ui","center");a=e.top+41;var c=b.left+b.width/2;if(d.icon!=null){c+=12;core.strokeRect("ui",b.left+15-1,e.top+30-1,34,d.height+2,"#DDDDDD",2);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:b.left+15,bgy:e.top+30,bgWidth:32,bgHeight:d.height,x:b.left+15,y:e.top+30,height:d.height,animate:d.animate,image:d.image,pos:d.icon*d.height});core.drawBoxAnimate()}core.fillText("ui",d.title,c,e.top+27,core.arrayToRGBA(core.status.textAttribute.title),this._buildFont(19,true))}core.setTextAlign("ui","left");this.drawTextContent("ui",d.content,{left:b.content_left,top:a,maxWidth:b.validWidth,fontSize:15,lineHeight:20,bold:true})};ui.prototype._drawChoices_drawChoices=function(a,h,c,l){core.setTextAlign("ui","center");core.setFont("ui",this._buildFont(17,true));for(var d=0;d<a.length;d++){var b=a[d].color||core.status.textAttribute.text;if(b instanceof Array){b=core.arrayToRGBA(b)}core.setFillStyle("ui",b);var k=this.HPIXEL;if(a[d].icon){var f=this._getDrawableIconInfo(a[d].icon),g=f[0],e=f[1];if(g!=null){core.drawImage("ui",g,0,32*e,32,32,this.HPIXEL-a[d].width/2,l.choice_top+32*d-17,22,22);k+=14}}core.fillText("ui",a[d].text,k,l.choice_top+32*d,b)}if(a.length>0){core.status.event.selection=core.status.event.selection||0;while(core.status.event.selection<0){core.status.event.selection+=a.length}while(core.status.event.selection>=a.length){core.status.event.selection-=a.length}var j=a[core.status.event.selection].width;if(h){this.drawWindowSelector(core.status.textAttribute.background,this.HPIXEL-j/2-5,l.choice_top+32*core.status.event.selection-20,j+10,28)}else{core.strokeRect("ui",this.HPIXEL-j/2-5,l.choice_top+32*core.status.event.selection-20,j+10,28,"#FFD700",2)}}};ui.prototype.drawConfirmBox=function(h,j,e){core.lockControl();h=core.replaceText(h||"");if(core.status.event.id!="action"){core.status.event.id="confirmBox";core.status.event.ui=h;core.status.event.data={yes:j,no:e}}if(core.status.event.selection!=0){core.status.event.selection=1}this.clearUI();core.setFont("ui",this._buildFont(19,true));var a=h.split("\n");var f=this._drawConfirmBox_getRect(a);var c=this.drawBackground(f.left,f.top,f.right,f.bottom);core.setTextAlign("ui","center");core.setFillStyle("ui",core.arrayToRGBA(core.status.textAttribute.text));for(var b in a){core.fillText("ui",a[b],this.HPIXEL,f.top+50+b*30)}core.fillText("ui","确定",this.HPIXEL-38,f.bottom-35,null,this._buildFont(17,true));core.fillText("ui","取消",this.HPIXEL+38,f.bottom-35);var d=core.calWidth("ui","确定");var g=this.HPIXEL+(76*core.status.event.selection-38)-parseInt(d/2)-5;if(c){this.drawWindowSelector(core.status.textAttribute.background,g,f.bottom-35-20,d+10,28)}else{core.strokeRect("ui",g,f.bottom-35-20,d+10,28,"#FFD700",2)}};ui.prototype._drawConfirmBox_getRect=function(b){var d=b.reduce(function(h,g){return Math.max(h,core.calWidth("ui",g))},0);var c=Math.min(this.HPIXEL-40-parseInt(d/2),100),e=this.PIXEL-c;var f=this.HPIXEL-68-(b.length-1)*30,a=this.HPIXEL+68;return{top:f,left:c,bottom:a,right:e,width:e-c,height:a-f}};ui.prototype.drawWaiting=function(e){core.lockControl();core.status.event.id="waiting";core.clearUI();e=core.replaceText(e||"");var f=core.calWidth("ui",e,this._buildFont(19,true));var h=Math.max(f+80,220),c=this.HPIXEL-parseInt(h/2),d=c+h;var g=this.HPIXEL-48,b=96,a=g+b;this.drawBackground(c,g,d,a);core.setTextAlign("ui","center");core.fillText("ui",e,this.HPIXEL,g+56,core.arrayToRGBA(core.status.textAttribute.text))};ui.prototype.drawSwitchs=function(){core.status.event.id="switchs";var a=["背景音乐： "+(core.musicStatus.bgmStatus?"[ON]":"[OFF]"),"背景音效： "+(core.musicStatus.soundStatus?"[ON]":"[OFF]")," <     音量："+Math.round(Math.sqrt(100*core.musicStatus.userVolume))+"     > "," <   步时："+core.values.moveSpeed+"   > ","怪物显伤： "+(core.flags.displayEnemyDamage?"[ON]":"[OFF]"),"临界显伤： "+(core.flags.displayCritical?"[ON]":"[OFF]"),"领域显伤： "+(core.flags.displayExtraDamage?"[ON]":"[OFF]"),"新版存档： "+(core.platform.useLocalForage?"[ON]":"[OFF]"),"单击瞬移： "+(!core.hasFlag("__noClickMove__")?"[ON]":"[OFF]"),"返回主菜单"];this.drawChoices(null,a)};ui.prototype.drawSettings=function(){core.status.event.id="settings";this.drawChoices(null,["系统设置","虚拟键盘","浏览地图","绘图模式","同步存档","游戏信息","返回标题","返回游戏"])};ui.prototype.drawQuickShop=function(){core.status.event.id="selectShop";var c=core.status.shops,b=Object.keys(c).filter(function(d){return c[d].visited||!c[d].mustEnable});var a=b.map(function(d){return{text:c[d].textInList,color:c[d].visited?null:"#999999"}});a.push("返回游戏");this.drawChoices(null,a)};ui.prototype.drawSyncSave=function(){core.status.event.id="syncSave";this.drawChoices(null,["同步存档到服务器","从服务器加载存档","存档至本地文件","从本地文件读档","回放和下载录像","清空本地存档","返回主菜单"])};ui.prototype.drawSyncSelect=function(){core.status.event.id="syncSelect";this.drawChoices(null,["同步本地所有存档","只同步当前单存档","返回上级菜单"])};ui.prototype.drawLocalSaveSelect=function(){core.status.event.id="localSaveSelect";this.drawChoices(null,["下载所有存档","只下载当前单存档","返回上级菜单"])};ui.prototype.drawStorageRemove=function(){core.status.event.id="storageRemove";this.drawChoices(null,["清空全部塔的存档","只清空当前塔的存档","返回上级菜单"])};ui.prototype.drawReplay=function(){core.lockControl();core.status.event.id="replay";this.drawChoices(null,["从头回放录像","从存档开始回放","接续播放剩余录像","选择录像文件","下载当前录像","返回游戏"])};ui.prototype.drawGameInfo=function(){core.status.event.id="gameInfo";this.drawChoices(null,["数据统计","查看工程","游戏主页","操作帮助","关于本塔","下载离线版本","返回主菜单"])};ui.prototype.drawPagination=function(b,c,d){if(c<0){if(d==null){d=this.LAST}core.setFillStyle("ui","#DDDDDD");var a=core.calWidth("ui",b+" / "+b,this._buildFont(15,true));core.setTextAlign("ui","center");core.fillText("ui",b,this.HPIXEL,d*32+19);if(b>1){core.fillText("ui","上一页",this.HPIXEL-48,d*32+19)}if(b<-c){core.fillText("ui","下一页",this.HPIXEL+48,d*32+19)}}if(c<=1){return}if(d==null){d=this.LAST}core.setFillStyle("ui","#DDDDDD");var a=core.calWidth("ui",b+" / "+b,this._buildFont(15,true));core.setTextAlign("ui","left");core.fillText("ui",b+" / "+c,parseInt((this.PIXEL-a)/2),d*32+19);core.setTextAlign("ui","center");if(b>1){core.fillText("ui","上一页",this.HPIXEL-80,d*32+19)}if(b<c){core.fillText("ui","下一页",this.HPIXEL+80,d*32+19)}};ui.prototype.drawCursor=function(){var a=core.status.automaticRoute;if(a.cursorX==null){a.cursorX=core.getHeroLoc("x")}if(a.cursorY==null){a.cursorY=core.getHeroLoc("y")}a.cursorX=core.clamp(a.cursorX,0,this.LAST);core.status.event.id="cursor";core.lockControl();core.clearUI();var b=4;core.strokeRect("ui",32*a.cursorX+b/2,32*a.cursorY+b/2,32-b,32-b,"#FFD700",b)};ui.prototype.drawBook=function(d){var b=core.floorIds[(core.status.event.ui||{}).index]||core.status.floorId;var a=core.enemys.getCurrentEnemys(b);core.clearUI();core.clearMap("data");core.maps.generateGroundPattern(b);this._drawBook_drawBackground();core.setAlpha("ui",1);if(a.length==0){core.setTextAlign("ui","center");core.fillText("ui","本层无怪物",this.HPIXEL,this.HPIXEL+14,"#999999",this._buildFont(50,true));core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13,"#DDDDDD",this._buildFont(15,true));return}d=core.clamp(d,0,a.length-1);core.status.event.data=d;var f=this._drawBook_pageinfo();var g=f.per_page,e=parseInt(d/g)+1,j=Math.ceil(a.length/g);var h=(e-1)*g;a=a.slice(h,e*g);for(var c=0;c<a.length;c++){this._drawBook_drawOne(b,c,a[c],f,d==h+c)}core.drawBoxAnimate();this.drawPagination(e,j);core.setTextAlign("ui","center");core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13,"#DDDDDD",this._buildFont(15,true))};ui.prototype._drawBook_pageinfo=function(){var c=this.HSIZE;var a=12;var b=(this.PIXEL-32-a)/c;return{per_page:c,padding_top:a,per_height:b}};ui.prototype._drawBook_drawBackground=function(){core.setAlpha("ui",1);core.setFillStyle("ui",core.material.groundPattern);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL);core.setAlpha("ui",0.6);core.setFillStyle("ui","#000000");core.fillRect("ui",0,0,this.PIXEL,this.PIXEL)};ui.prototype._drawBook_drawOne=function(b,c,a,f,g){var h=f.per_height*c+f.padding_top;this._drawBook_drawBox(c,a,h,f);var d=64,i=this.PIXEL-d;var e=i*10/35;this._drawBook_drawName(c,a,h,d,e);this._drawBook_drawContent(c,a,h,d+e);if(g){core.strokeRect("ui",10,h+1,this.PIXEL-10*2,f.per_height,"#FFD700")}};ui.prototype._drawBook_drawBox=function(g,d,i,h){var c=i+(h.per_height-42)/2,b=22;var f=c+5,e=b+5;core.strokeRect("ui",22,c,42,42,"#DDDDDD",2);var a=core.getBlockInfo(d.id);core.status.boxAnimateObjs.push({bgx:b,bgy:c,bgWidth:42,bgHeight:42,x:e,y:f,height:32,animate:a.animate,image:a.image,pos:a.posY*a.height})};ui.prototype._drawBook_drawName=function(b,a,d,c,e){core.setTextAlign("ui","center");if(a.specialText==""){core.fillText("ui",a.name,c+e/2,d+35,"#DDDDDD",this._buildFont(17,true),e)}else{core.fillText("ui",a.name,c+e/2,d+28,"#DDDDDD",this._buildFont(17,true),e);core.fillText("ui",a.specialText,c+e/2,d+50,"#FF6A6A",this._buildFont(15,true),e)}};ui.prototype._drawBook_drawContent=function(b,a,d,c){var e=this.PIXEL-c;this._drawBook_drawRow1(b,a,d,c,e,d+20);this._drawBook_drawRow2(b,a,d,c,e,d+38);this._drawBook_drawRow3(b,a,d,c,e,d+56)};ui.prototype._drawBook_drawRow1=function(g,e,j,h,k,i){core.setTextAlign("ui","left");var a=this._buildFont(13,true),f=this._buildFont(13,false);var b=h,c=h+k*9/25,d=h+k*17/25;core.fillText("ui","生命",b,i,"#DDDDDD",f);core.fillText("ui",core.formatBigNumber(e.hp||0),b+30,i,null,a);core.fillText("ui","攻击",c,i,null,f);core.fillText("ui",core.formatBigNumber(e.atk||0),c+30,i,null,a);core.fillText("ui","防御",d,i,null,f);core.fillText("ui",core.formatBigNumber(e.def||0),d+30,i,null,a)};ui.prototype._drawBook_drawRow2=function(h,f,m,i,n,k){core.setTextAlign("ui","left");var a=this._buildFont(13,true),g=this._buildFont(13,false);var b=i,c=i+n*9/25,d=i+n*17/25;var l=[];if(core.flags.enableMoney){l.push(["金币",core.formatBigNumber(f.money||0)])}if(core.flags.enableAddPoint){l.push(["加点",core.formatBigNumber(f.point||0)])}if(core.flags.enableExperience){l.push(["经验",core.formatBigNumber(f.experience||0)])}var e=b+(this.PIXEL-b)/2-12;if(l.length>0){var j=l.shift();core.fillText("ui",j[0],b,k,"#DDDDDD",g);core.fillText("ui",j[1],b+30,k,null,a);e=c+(this.PIXEL-c)/2-12}if(l.length>0){var j=l.shift();core.fillText("ui",j[0],c,k,"#DDDDDD",g);core.fillText("ui",j[1],c+30,k,null,a);e=d+(this.PIXEL-d)/2-12}this._drawBook_drawDamage(h,f,e,k)};ui.prototype._drawBook_drawRow3=function(g,e,j,h,k,i){core.setTextAlign("ui","left");var a=this._buildFont(13,true),f=this._buildFont(13,false);var b=h,c=h+k*9/25,d=h+k*17/25;core.fillText("ui","临界",b,i,"#DDDDDD",f);core.fillText("ui",core.formatBigNumber(e.critical||0),b+30,i,null,a);core.fillText("ui","减伤",c,i,null,f);core.fillText("ui",core.formatBigNumber(e.criticalDamage||0),c+30,i,null,a);core.fillText("ui","1防",d,i,null,f);core.fillText("ui",core.formatBigNumber(e.defDamage||0),d+30,i,null,a)};ui.prototype._drawBook_drawDamage=function(d,c,e,f){core.setTextAlign("ui","center");var b=c.damage,a="#FFFF00";if(b==null){b="无法战斗";a="#FF0000"}else{if(b>=core.status.hero.hp){a="#FF0000"}if(b<=0){a="#00FF00"}b=core.formatBigNumber(b);if(core.enemys.hasSpecial(c,19)){b+="+"}if(core.enemys.hasSpecial(c,21)){b+="-"}if(core.enemys.hasSpecial(c,11)){b+="^"}}if(c.notBomb){b+="[b]"}core.fillText("ui",b,e,f,a,this._buildFont(13,true))};ui.prototype.drawBookDetail=function(g){var h=this._drawBookDetail_getInfo(g),e=h[0];if(!e){return}var b=h[1].join("\n");core.status.event.id="book-detail";core.clearTip();core.clearMap("data");var i=10,m=this.PIXEL-2*i,j=i+m;var c=i+25,l=j-c-13;var d=core.splitLines("data",b,l,this._buildFont(16,false));var f=Math.max(24*d.length+55,80),k=(this.PIXEL-f)/2,a=k+f;core.setAlpha("data",0.9);core.fillRect("data",i,k,m,f,"#000000");core.setAlpha("data",1);core.strokeRect("data",i-1,k-1,m+1,f+1,core.status.globalAttribute.borderColor,2);this._drawBookDetail_drawContent(e,d,{top:k,content_left:c,bottom:a})};ui.prototype._drawBookDetail_getInfo=function(e){var d=core.floorIds[(core.status.event.ui||{}).index]||core.status.floorId;var c=core.enemys.getCurrentEnemys(d);if(c.length==0){return[]}e=core.clamp(e,0,c.length-1);var a=c[e],b=a.id;var f=core.enemys.getSpecialHint(b);if(f.length==0){f.push("该怪物无特殊属性。")}f.push("");this._drawBookDetail_getTexts(a,d,f);return[a,f]};ui.prototype._drawBookDetail_getTexts=function(a,b,c){this._drawBookDetail_mofang(a,c);this._drawBookDetail_vampire(a,c);this._drawBookDetail_hatred(a,c);this._drawBookDetail_turnAndCriticals(a,b,c)};ui.prototype._drawBookDetail_mofang=function(b,d){if(core.enemys.hasSpecial(b.special,10)){var c=b.hp;var a=core.status.hero.atk-core.status.hero.def;if(a<c&&c<=10000&&c>0){d.push("模仿临界计算器：（当前攻防差"+core.formatBigNumber(a)+"）");var e=[];this._drawBookDetail_mofang_getArray(c).forEach(function(f){if(e.length<20){e.push(f)}else{if(Math.abs(f[0]-a)<Math.abs(e[0][0]-a)){e.shift();e.push(f)}}});d.push(JSON.stringify(e.map(function(f){return core.formatBigNumber(f[0])+":"+f[1]})))}}};ui.prototype._drawBookDetail_mofang_getArray=function(b){var a=[];var d=0,f=0;for(var c=1;c<b;c++){var e=parseInt((b-1)/c);if(e!=d){if(d!=0){a.push([f,d+"x"])}d=e;f=c}}if(d!=0){a.push([f,"1x"]);a.push([b,"0"])}return a};ui.prototype._drawBookDetail_vampire=function(c,g){if(core.enemys.hasSpecial(c.special,11)){var a=core.getDamage(c.id);if(a!=null){var f=1,b=100*a;var e=core.status.hero.hp;while(f<b){var d=Math.floor((f+b)/2);core.status.hero.hp=d;if(core.canBattle(c.id)){b=d}else{f=d+1}}core.status.hero.hp=f;if(core.canBattle(c.id)){g.push("打死该怪物最低需要生命值："+core.formatBigNumber(f))}core.status.hero.hp=e}}};ui.prototype._drawBookDetail_hatred=function(a,b){if(core.enemys.hasSpecial(a.special,17)){b.push("当前仇恨伤害值："+core.getFlag("hatred",0))}};ui.prototype._drawBookDetail_turnAndCriticals=function(c,d,f){var b=core.getDamageInfo(c,null,null,null,d);f.push("战斗回合数："+((b||{}).turn||0));var a=core.enemys.nextCriticals(c,8,null,null,d).map(function(g){return core.formatBigNumber(g[0])+":"+core.formatBigNumber(g[1])});while(a[0]=="0:0"){a.shift()}f.push("临界表："+JSON.stringify(a));var e=core.getDamageInfo(c,{atk:core.status.hero.atk-1},null,null,d);if(e!=null&&b!=null){if(b.damage!=null){b=b.damage}if(e.damage!=null){e=e.damage}if(e>b){f.push("（当前攻击力正位于临界点上）")}}};ui.prototype._drawBookDetail_drawContent=function(c,b,g){core.setTextAlign("data","left");core.fillText("data",c.name,g.content_left,g.top+30,"#FFD700",this._buildFont(22,true));var a=g.top+57;for(var d=0;d<b.length;d++){var h=b[d];var e=h.indexOf("：");if(e>=0){var j=h.substring(0,e+1);core.fillText("data",j,g.content_left,a,"#FF6A6A",this._buildFont(16,true));var f=core.calWidth("data",j);core.fillText("data",h.substring(e+1),g.content_left+f,a,"#FFFFFF",this._buildFont(16,false))}else{core.fillText("data",b[d],g.content_left,a,"#FFFFFF",this._buildFont(16,false))}a+=24}};ui.prototype.drawFly=function(e){core.status.event.data=e;var a=core.floorIds[e];var h=core.status.maps[a].title;core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#000000");core.setAlpha("ui",1);core.setTextAlign("ui","center");core.fillText("ui","楼层跳跃",this.HPIXEL,60,"#FFFFFF",this._buildFont(28,true));core.fillText("ui","返回游戏",this.HPIXEL,this.PIXEL-13,null,this._buildFont(15,true));var d=this.HPIXEL+39;var c=core.splitLines("ui",h,120,this._buildFont(19,true));var g=d-(c.length-1)*11;for(var b in c){core.fillText("ui",c[b],this.PIXEL-60,g);g+=22}if(core.actions._getNextFlyFloor(1)!=e){core.fillText("ui","▲",this.PIXEL-60,d-64,null,this._buildFont(17,false));core.fillText("ui","▲",this.PIXEL-60,d-96);core.fillText("ui","▲",this.PIXEL-60,d-96-7)}if(core.actions._getNextFlyFloor(-1)!=e){core.fillText("ui","▼",this.PIXEL-60,d+64,null,this._buildFont(17,false));core.fillText("ui","▼",this.PIXEL-60,d+96);core.fillText("ui","▼",this.PIXEL-60,d+96+7)}var f=this.PIXEL-143;core.strokeRect("ui",20,100,f,f,"#FFFFFF",2);core.drawThumbnail(a,null,null,{ctx:"ui",x:20,y:100,size:f})};ui.prototype.drawCenterFly=function(){core.lockControl();core.status.event.id="centerFly";var a="rgba(255,0,0,0.5)";if(core.canUseItem("centerFly")){a="rgba(0,255,0,0.5)"}var d=core.bigmap.width-1-core.getHeroLoc("x"),e=core.bigmap.height-1-core.getHeroLoc("y");core.drawThumbnail(null,null,{heroLoc:core.status.hero.loc,heroIcon:core.getFlag("heroIcon","hero.png")},{ctx:"ui",centerX:d,centerY:e});var b=1,c=1;core.fillRect("ui",(d-b)*32,(e-c)*32,32,32,a);core.status.event.data={x:d,y:e,posX:d-b,posY:e-c};core.drawTip("请确认当前中心对称飞行器的位置");return};ui.prototype.drawShop=function(k){var j=core.status.shops[k];var a=[],e=(core.status.event.data||{}).fromList,h=core.status.event.selection;if(core.status.event.data&&core.status.event.data.actions){a=core.status.event.data.actions}core.ui.closePanel();core.lockControl();core.status.event.id="shop";core.status.event.data={id:k,shop:j,actions:a,fromList:e};core.status.event.selection=h;var m=j.times,g=core.calValue(j.need,null,null,m);var d="\t["+j.name+","+j.icon+"]"+core.replaceText(j.text,g,m);var n=j.use=="experience"?"经验":"金币";var c=[];for(var f=0;f<j.choices.length;f++){var b=j.choices[f];var l=core.replaceText(b.text,g,m);if(b.need!=null){l+="（"+core.calValue(b.need,null,null,m)+n+"）"}c.push({text:l,color:j.visited?null:"#999999"})}c.push("离开");core.ui.drawChoices(d,c)};ui.prototype.drawMaps=function(c,k,l){core.lockControl();core.status.event.id="viewMaps";this.clearUI();if(c==null){return this._drawMaps_drawHint()}core.clearTip();core.status.checkBlock.cache={};var a=this._drawMaps_buildData(c,k,l);core.drawThumbnail(a.floorId,null,{damage:a.damage},{ctx:"ui",centerX:a.x,centerY:a.y,all:a.all});if(a.paint){var d=32*(a.x-this.HSIZE),e=32*(a.y-this.HSIZE);var i=core.paint[a.floorId];if(i){i=lzw_decode(i).split(",")}core.utils._decodeCanvas(i,32*a.mw,32*a.mh);core.drawImage("ui",core.bigmap.tempCanvas.canvas,d*32,e*32,this.PIXEL,this.PIXEL,0,0,this.PIXEL,this.PIXEL)}core.clearMap("data");core.setTextAlign("data","left");core.setFont("data","16px Arial");var f=core.status.maps[a.floorId].title;if(!a.all&&(a.mw>this.SIZE||a.mh>this.SIZE)){f+=" ["+(a.x-this.HSIZE)+","+(a.y-this.HSIZE)+"]"}var g=16,h=18,j=g+core.calWidth("data",f)+16,b=42;core.fillRect("data",5,5,j,b,"rgba(0,0,0,0.4)");core.fillText("data",f,g+5,h+15,"rgba(255,255,255,0.6)")};ui.prototype._drawMaps_drawHint=function(){core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"rgba(0,0,0,0.4)");core.setTextAlign("ui","center");var g=function(k,m,n,j,i,l){core.strokeRect("ui",k*32+2,m*32+2,n*32-4,j*32-4,i,l)};var d=this.HSIZE-4;g(d,0,9,d,"#FFD700",4);g(0,d,d,9);g(d,this.SIZE-d,9,d);g(this.SIZE-d,d,d,9);g(d,d,9,3);g(d,this.SIZE-d-3,9,3);g(0,0,d-1,d-1);g(this.SIZE-(d-1),0,d-1,d-1);g(0,this.SIZE-(d-1),d-1,d-1);core.setTextBaseline("ui","middle");core.fillText("ui","上移地图 [W]",this.HPIXEL,d*16,"#FFD700","20px Arial");core.fillText("ui","下移地图 [S]",this.HPIXEL,this.PIXEL-d*16);core.fillText("ui","V",(d-1)*16,(d-1)*16);core.fillText("ui","Z",this.PIXEL-(d-1)*16,(d-1)*16);core.fillText("ui","M",(d-1)*16,this.PIXEL-(d-1)*16);var h=this.HPIXEL-66,b=d*16,e=this.PIXEL-b;var c=["左","移","地","图","[A]"],f=["右","移","地","图","[D]"];for(var a=0;a<5;++a){core.fillText("ui",c[a],b,h+32*a);core.fillText("ui",f[a],e,h+32*a)}core.fillText("ui","前张地图 [▲ / PGUP]",this.HPIXEL,32*d+48);core.fillText("ui","后张地图 [▼ / PGDN]",this.HPIXEL,this.PIXEL-(32*d+48));core.fillText("ui","退出 [ESC / ENTER]",this.HPIXEL,this.HPIXEL);core.fillText("ui","[X] 可查看怪物手册",this.HPIXEL+77,this.HPIXEL+32,null,"13px Arial");core.setTextBaseline("ui","alphabetic")};ui.prototype._drawMaps_buildData=function(d,h,i){var b=(core.status.event.data||{}).damage;var g=(core.status.event.data||{}).paint;var a=(core.status.event.data||{all:true}).all;if(d.damage!=null){b=d.damage}if(d.paint!=null){g=d.paint}if(d.all!=null){a=d.all}if(d.index!=null){h=d.x;i=d.y;d=d.index}d=core.clamp(d,0,core.floorIds.length-1);if(b==null){b=true}var c=core.floorIds[d],f=core.floors[c].width,e=core.floors[c].height;if(h==null){h=parseInt(f/2)}if(i==null){i=parseInt(e/2)}h=core.clamp(h,this.HSIZE,f-this.HSIZE-1);i=core.clamp(i,this.HSIZE,e-this.HSIZE-1);core.status.event.data={index:d,x:h,y:i,floorId:c,mw:f,mh:e,damage:b,paint:g,all:a};return core.status.event.data};ui.prototype.drawToolbox=function(a){var b=this._drawToolbox_getInfo(a);this._drawToolbox_drawBackground();core.setAlpha("ui",1);core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;core.setTextAlign("ui","right");var c=this.PIXEL-306;this._drawToolbox_drawLine(c,"消耗道具");var d=this.PIXEL-146;this._drawToolbox_drawLine(d,"永久道具");this._drawToolbox_drawDescription(b,c);this._drawToolbox_drawContent(b,c,b.tools,b.toolsPage,true);this.drawPagination(b.toolsPage,b.toolsTotalPage,this.LAST-5);this._drawToolbox_drawContent(b,d,b.constants,b.constantsPage);this.drawPagination(b.constantsPage,b.constantsTotalPage);core.setTextAlign("ui","center");core.fillText("ui","[装备栏]",this.PIXEL-46,25,"#DDDDDD",this._buildFont(15,true));core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13)};ui.prototype._drawToolbox_getInfo=function(d){if(!core.status.event.data||core.status.event.data.toolsPage==null){core.status.event.data={toolsPage:1,constantsPage:1,selectId:null}}var g=Object.keys(core.status.hero.items.tools).sort();var a=Object.keys(core.status.hero.items.constants).sort();var h=core.status.event.data.toolsPage;var b=core.status.event.data.constantsPage;var i=Math.ceil(g.length/this.LAST);var c=Math.ceil(a.length/this.LAST);if(d==null){d=g.length==0&&a.length>0?this.LAST:0}core.status.event.selection=d;var e,f;if(d<this.LAST){e=d+(h-1)*this.LAST;if(e>=g.length){e=Math.max(0,g.length-1)}f=g[e]}else{e=d%this.LAST+(b-1)*this.LAST;if(e>=a.length){e=Math.max(0,a.length-1)}f=a[e]}if(!core.hasItem(f)){f=null}core.status.event.data.selectId=f;return{index:d,tools:g,constants:a,toolsPage:h,constantsPage:b,toolsTotalPage:i,constantsTotalPage:c,selectId:f}};ui.prototype._drawToolbox_drawBackground=function(){core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#000000")};ui.prototype._drawToolbox_drawLine=function(b,a){core.setFillStyle("ui","#DDDDDD");core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,b);core.canvas.ui.lineTo(this.PIXEL,b);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(this.PIXEL,b-1);core.canvas.ui.lineTo(this.PIXEL,b-25);core.canvas.ui.lineTo(this.PIXEL-72,b-25);core.canvas.ui.lineTo(this.PIXEL-102,b-1);core.canvas.ui.fill();core.fillText("ui",a,this.PIXEL-5,b-6,"#333333",this._buildFont(16,true))};ui.prototype._drawToolbox_drawDescription=function(f,k){core.setTextAlign("ui","left");if(!f.selectId){return}var g=core.material.items[f.selectId];core.fillText("ui",g.name,10,32,"#FFD700",this._buildFont(20,true));var l=g.text||"该道具暂无描述。";try{l=core.replaceText(l)}catch(b){}for(var c=17;c>=14;c-=3){var j=core.splitLines("ui",l,this.PIXEL-15,this._buildFont(c,false));var h=parseInt(c*1.4),a=37+h;if(a+j.length*h<k){break}}core.setFillStyle("ui","#FFFFFF");for(var d=0;d<j.length;++d){core.fillText("ui",j[d],10,a);a+=h;if(a>=k){break}}if(a<k){core.fillText("ui","<继续点击该道具即可进行使用>",10,a,"#CCCCCC",this._buildFont(14,false))}};ui.prototype._drawToolbox_drawContent=function(e,h,g,j,a){core.setTextAlign("ui","right");for(var b=0;b<this.LAST;b++){var f=g[this.LAST*(j-1)+b];if(!f){continue}var k=h+54*Math.floor(b/this.HSIZE)+19;var c=core.material.icons.items[f],d=core.material.images.items;core.drawImage("ui",d,0,32*c,32,32,64*(b%this.HSIZE)+21,k,32,32);if(a){core.fillText("ui",core.itemCount(f),64*(b%this.HSIZE)+56,k+33,"#FFFFFF",this._buildFont(14,true))}if(e.selectId==f){core.strokeRect("ui",64*(b%this.HSIZE)+17,k-4,40,40,"#FFD700")}}};ui.prototype.drawEquipbox=function(a){var b=this._drawEquipbox_getInfo(a);this._drawToolbox_drawBackground();core.setAlpha("ui",1);core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;core.setTextAlign("ui","right");var c=this.PIXEL-306;this._drawToolbox_drawLine(c,"当前装备");var d=this.PIXEL-146;this._drawToolbox_drawLine(d,"拥有装备");this._drawEquipbox_description(b,c);this._drawEquipbox_drawEquiped(b,c);this._drawToolbox_drawContent(b,d,b.ownEquipment,b.page,true);this.drawPagination(b.page,b.totalPage);core.setTextAlign("ui","center");core.fillText("ui","[道具栏]",this.PIXEL-46,25,"#DDDDDD",this._buildFont(15,true));core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13)};ui.prototype._drawEquipbox_getInfo=function(d){if(!core.status.event.data||core.status.event.data.page==null){core.status.event.data={page:1,selectId:null}}var a=core.status.globalAttribute.equipName;var c=a.length;if(!core.status.hero.equipment){core.status.hero.equipment=[]}var b=core.status.hero.equipment;var e=Object.keys(core.status.hero.items.equips).sort();var f=core.status.event.data.page;var h=Math.ceil(e.length/this.LAST);if(d==null){if(c>0&&b[0]){d=0}else{if(e.length>0){d=this.LAST}else{d=0}}}if(d>=this.LAST&&e.length==0){d=0}var g=null;if(d<this.LAST){if(d>=c){d=Math.max(0,c-1)}g=b[d]||null}else{if(f==h){d=Math.min(d,(e.length+this.LAST-1)%this.LAST+this.LAST)}g=e[d-this.LAST+(f-1)*this.LAST];if(!core.hasItem(g)){g=null}}core.status.event.selection=d;core.status.event.data.selectId=g;return{index:d,selectId:g,page:f,totalPage:h,allEquips:a,equipLength:c,equipEquipment:b,ownEquipment:e}};ui.prototype._drawEquipbox_description=function(j,m){core.setTextAlign("ui","left");if(!j.selectId){return}var c=core.material.items[j.selectId];if(!c.equip){c.equip={type:0}}var f=c.equip.type,d;if(typeof f==="string"){d=f||"未知部位";f=core.items.getEquipTypeByName(f)}else{d=j.allEquips[f]||"未知部位"}core.fillText("ui",c.name+"（"+d+"）",10,32,"#FFD700",this._buildFont(20,true));var n=c.text||"该装备暂无描述。";try{n=core.replaceText(n)}catch(b){}for(var g=17;g>=11;g-=3){var l=core.splitLines("ui",n,this.PIXEL-15,this._buildFont(g,false));var k=parseInt(g*1.4),a=37+k;if(a+l.length*k<m){break}}core.setFillStyle("ui","#FFFFFF");for(var h=0;h<l.length;++h){core.fillText("ui",l[h],10,a);a+=k;if(a>=m){break}}if(a>=m){return}this._drawEquipbox_drawStatusChanged(j,a,c,f)};ui.prototype._drawEquipbox_getStatusChanged=function(e,c,d,g){var a,b=null;if(e.index<this.LAST){a=core.compareEquipment(null,e.selectId)}else{if(d<0){b="<当前没有该装备的空位，请先卸下装备>"}else{var f=core.material.items[e.equipEquipment[d]]||{};if(f.equip&&(f.equip.percentage||false)!=(c.equip.percentage||false)){b="<数值和比例模式之间的切换不显示属性变化>"}else{a=core.compareEquipment(e.selectId,e.equipEquipment[d])}}}if(b!=null){core.fillText("ui",b,10,g,"#CCCCCC",this._buildFont(14,false));return}return a};ui.prototype._drawEquipbox_drawStatusChanged=function(e,m,b,c){var a=this._drawEquipbox_getStatusChanged(e,b,c,m);if(a==null){return}var k={drawOffset:10,y:m};core.setFont("ui",this._buildFont(14,true));for(var f in a){var d=core.statusBar.icons[f];var l=core.getStatusName(f);if(d&&core.flags.iconInEquipbox){core.drawImage("ui",d,0,0,32,32,k.drawOffset,k.y-13,16,16);k.drawOffset+=20}else{this._drawEquipbox_drawStatusChanged_draw(l+" ","#CCCCCC",k)}var j=core.getStatus(f)*core.getBuff(f),h=(core.getStatus(f)+a[f])*core.getBuff(f);if(b.equip.percentage){var i=core.getBuff(f),g=i+a[f]/100;j=Math.floor(i*core.getStatus(f));h=Math.floor(g*core.getStatus(f))}j=core.formatBigNumber(j);h=core.formatBigNumber(h);this._drawEquipbox_drawStatusChanged_draw(j+"->","#CCCCCC",k);this._drawEquipbox_drawStatusChanged_draw(h,a[f]>0?"#00FF00":"#FF0000",k);k.drawOffset+=8}};ui.prototype._drawEquipbox_drawStatusChanged_draw=function(d,a,c){var b=core.calWidth("ui",d);if(c.drawOffset+b>=core.__PIXELS__){c.y+=19;c.drawOffset=10}core.fillText("ui",d,c.drawOffset,c.y,a);c.drawOffset+=b};ui.prototype._drawEquipbox_drawEquiped=function(d,e){core.setTextAlign("ui","center");var h=this.HSIZE-3,j=Math.floor(this.PIXEL/(h+0.25));for(var b=0;b<d.equipLength;b++){var a=d.equipEquipment[b]||null;var f=j*(b%h)+j*2/3;var g=f-(j-32)/2;var k=e+54*Math.floor(b/h)+19;if(a){var c=core.material.icons.items[a];core.drawImage("ui",core.material.images.items,0,32*c,32,32,f,k,32,32)}core.fillText("ui",d.allEquips[b]||"未知",g,k+27,"#FFFFFF",this._buildFont(16,true));core.strokeRect("ui",f-4,k-4,40,40,d.index==b?"#FFD700":"#FFFFFF")}};ui.prototype.drawSLPanel=function(a,g){core.control._loadFavoriteSaves();if(a==null){a=1}if(a<0){a=0}var f=parseInt(a/10),e=a%10;var c=main.savePages||30;if(core.status.event.data&&core.status.event.data.mode=="fav"){c=Math.ceil((core.saves.favorite||[]).length/5)}if(f>=c){f=c-1}if(e>5){e=5}if(core.status.event.data&&core.status.event.data.mode=="fav"&&f==c-1){e=Math.min(e,(core.saves.favorite||[]).length-5*f)}var b=-1;var d="all";if(core.status.event.data){b=core.status.event.data.page;d=core.status.event.data.mode}core.status.event.data={page:f,offset:e,mode:d};core.status.event.ui=core.status.event.ui||[];if(g||f!=b){core.status.event.ui=[];this._drawSLPanel_loadSave(f,function(){core.ui._drawSLPanel_draw(f,c)})}else{this._drawSLPanel_draw(f,c)}};ui.prototype._drawSLPanel_draw=function(c,b){this._drawSLPanel_drawBackground();core.ui.drawPagination(c+1,-b);core.setTextAlign("ui","center");var a=this.PIXEL-13;core.fillText("ui","返回游戏",this.PIXEL-48,a,"#DDDDDD",this._buildFont(15,true));if(core.status.event.selection){core.setFillStyle("ui","#FF6A6A")}if(core.status.event.id=="save"){core.fillText("ui","删除模式",48,a)}else{if(core.status.event.data.mode=="all"){core.fillText("ui","[E]显示收藏",52,a)}else{core.fillText("ui","[E]显示全部",52,a)}}this._drawSLPanel_drawRecords()};ui.prototype._drawSLPanel_drawBackground=function(){core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#000000");core.setAlpha("ui",1)};ui.prototype._drawSLPanel_loadSave=function(e,a){var d=[0];for(var b=1;b<=5;++b){var c=5*e+b;if(core.status.event.data.mode=="fav"){c=core.saves.favorite[c-1]}d.push(c)}core.getSaves(d,function(f){for(var g=1;g<d.length;++g){core.status.event.ui[g]=f[g]}core.status.event.ui[0]=f[0]==null?null:f[0][f[0].length-1];a()})};ui.prototype._drawSLPanel_drawRecord=function(f,b,i,j,d,a,c){var e="#FFD700";if(core.status.event.selection){e="#FF6A6A"}if(!b||!b.floorId){c=false}core.fillText("ui",f,i,j,c?"#FFD700":"#FFFFFF",this._buildFont(17,true));core.strokeRect("ui",i-d/2,j+15,d,d,a?e:"#FFFFFF",a?6:2);if(b&&b.floorId){core.drawThumbnail(b.floorId,core.maps.loadMap(b.maps,b.floorId).blocks,{heroLoc:b.hero.loc,heroIcon:b.hero.flags.heroIcon,flags:b.hero.flags},{ctx:"ui",x:i-d/2,y:j+15,size:d,centerX:b.hero.loc.x,centerY:b.hero.loc.y});if(core.isPlaying()&&core.getFlag("hard")!=b.hero.flags.hard){core.fillRect("ui",i-d/2,j+15,d,d,[0,0,0,0.4],2);core.fillText("ui",b.hard,i,parseInt(j+22+d/2),core.dom.hard.style.color,this._buildFont(30,true))}var g=core.formatBigNumber(b.hero.hp,true)+"/"+core.formatBigNumber(b.hero.atk,true)+"/"+core.formatBigNumber(b.hero.def,true);var h="/"+core.formatBigNumber(b.hero.money,true);if(core.calWidth("ui",g+h,this._buildFont(10,false))<=d){g+=h}core.fillText("ui",g,i,j+30+d,"#FFD700");core.fillText("ui",core.formatDate(new Date(b.time)),i,j+43+d,b.hero.flags.__consoleOpened__||b.hero.flags.debug?"#FF6A6A":"#FFFFFF")}else{core.fillRect("ui",i-d/2,j+15,d,d,"#333333",2);core.fillText("ui","空",i,parseInt(j+22+d/2),"#FFFFFF",this._buildFont(30,true))}};ui.prototype._drawSLPanel_drawRecords=function(f){var j=core.status.event.data.page;var h=core.status.event.data.offset;var p=Math.floor(this.PIXEL/6),l=Math.floor(this.PIXEL/3-20);var g=core.status.event.id=="save"?"存档":core.status.event.id=="load"?"读档":"回放";for(var d=0;d<(f||6);d++){var b=core.status.event.ui[d];var e=5*j+d;var c=(d>0&&core.saves.favorite.indexOf(e)>=0)||core.status.event.data.mode=="fav";var m=(c?"★ ":"☆ ")+(core.saves.favoriteName[e]||(g+e));if(d!=0&&core.status.event.data.mode=="fav"){if(!b){break}var k=core.saves.favorite[e-1];m=(core.saves.favoriteName[k]||(g+k))+" ?"}var a=32;var o=parseInt((this.PIXEL-a-2*(a*2+l))/3);var q=o+parseInt(a/2)+8;var r=q+a*2+l+o;if(d<3){this._drawSLPanel_drawRecord(d==0?"自动存档":m,b,(2*d+1)*p,q,l,d==h,c)}else{this._drawSLPanel_drawRecord(m,b,(2*d-5)*p,r,l,d==h,c)}}};ui.prototype.drawKeyBoard=function(){core.lockControl();core.status.event.id="keyBoard";core.clearUI();var i=384,b=320;var d=(this.PIXEL-i)/2,g=d+i;var h=(this.PIXEL-b)/2,a=h+b;var c=this.drawBackground(d,h,g,a);core.setTextAlign("ui","center");core.setFillStyle("ui",core.arrayToRGBA(core.status.textAttribute.title));core.fillText("ui","虚拟键盘",this.HPIXEL,h+35,null,this._buildFont(22,true));core.setFont("ui",this._buildFont(17,false));core.setFillStyle("ui",core.arrayToRGBA(core.status.textAttribute.text));var f=this.HPIXEL-89;var e=[["F1","F2","F3","F4","F5","F6","F7","F8","F9","10","11"],["1","2","3","4","5","6","7","8","9","0"],["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],["-","=","[","]","\\",";","'",",",".","/","`"],["ES","TA","CA","SH","CT","AL","SP","BS","EN","DE"]];e.forEach(function(k){for(var j=0;j<k.length;j++){core.fillText("ui",k[j],core.ui.HPIXEL+32*(j-5),f)}f+=32});core.fillText("ui","返回游戏",this.HPIXEL+128,f-3,"#FFFFFF",this._buildFont(15,true));if(c){this.drawWindowSelector(core.status.textAttribute.background,this.HPIXEL+92,f-22,72,27)}else{core.strokeRect("ui",this.HPIXEL+92,f-22,72,27,"#FFD700",2)}};ui.prototype.drawStatusBar=function(){this.uidata.drawStatusBar()};ui.prototype.drawStatistics=function(a){var b=this._drawStatistics_buildObj();if(typeof a=="string"){a=[a]}(a||core.floorIds).forEach(function(d){core.ui._drawStatistics_floorId(d,b)});var c=core.status.hero.statistics;core.setFlag("__replayText__",true);core.drawText([this._drawStatistics_generateText(b,"全塔",b.total),this._drawStatistics_generateText(b,"当前",b.current),"当前总步数："+core.status.hero.steps+"，当前游戏时长："+core.formatTime(c.currTime)+"，总游戏时长"+core.formatTime(c.totalTime)+"。\n瞬间移动次数："+c.moveDirectly+"，共计少走"+c.ignoreSteps+"步。\n\n总计通过血瓶恢复生命值为"+core.formatBigNumber(c.hp)+"点。\n\n总计打死了"+c.battle+"个怪物，得到了"+core.formatBigNumber(c.money)+"金币，"+core.formatBigNumber(c.experience)+"点经验。\n\n受到的总伤害为"+core.formatBigNumber(c.battleDamage+c.poisonDamage+c.extraDamage)+"，其中战斗伤害"+core.formatBigNumber(c.battleDamage)+"点"+(core.flags.enableDebuff?("，中毒伤害"+core.formatBigNumber(c.poisonDamage)+"点"):"")+"，领域/夹击/阻击/血网伤害"+core.formatBigNumber(c.extraDamage)+"点。","\t[说明]1. 地图数据统计的效果仅模拟当前立刻获得该道具的效果。\n2. 不会计算“不可被浏览地图”的隐藏层的数据。\n3. 不会计算任何通过事件得到的道具（显示事件、改变图块、或直接增加道具等）。\n4. 在自定义道具（例如其他宝石）后，需在脚本编辑的drawStatistics中注册，不然不会进行统计。\n5. 所有统计信息仅供参考，如有错误，概不负责。"]);core.removeFlag("__replayText__")};ui.prototype._drawStatistics_buildObj=function(){var g=this.uidata.drawStatistics();var d=g.filter(function(h){return h.endsWith("Door")||core.material.items[h]});var b={},a={},c={};d.forEach(function(h){if(h.endsWith("Door")){a[h]="doors"}else{a[h]=core.material.items[h].cls}b[h]=0});var f=["doors","keys","items","tools","constants","equips"];d.sort(function(h,i){var j=f.indexOf(a[h]),k=f.indexOf(a[i]);if(j==k){return g.indexOf(h)-g.indexOf(i)}return j-k});var e={monster:{count:0,money:0,experience:0,point:0,},count:b,add:{hp:0,atk:0,def:0,mdef:0}};return{ids:d,cls:a,ext:c,total:core.clone(e),current:core.clone(e)}};ui.prototype._drawStatistics_add=function(a,b,d,e,c){b.total[d][e]+=c||0;if(a==core.status.floorId){b.current[d][e]+=c||0}};ui.prototype._drawStatistics_floorId=function(c,d){var b=core.status.maps[c],a=b.blocks;if(b.cannotViewMap&&c!=core.status.floorId){return}a.forEach(function(e){if(e.disable){return}var f=e.event;if(f.cls.indexOf("enemy")==0){core.ui._drawStatistics_enemy(c,f.id,d)}else{var g=f.id;if(d.total.count[g]!=null){core.ui._drawStatistics_items(c,b,g,d)}}})};ui.prototype._drawStatistics_enemy=function(b,c,d){var a=core.material.enemys[c];this._drawStatistics_add(b,d,"monster","money",a.money);this._drawStatistics_add(b,d,"monster","experience",a.experience);this._drawStatistics_add(b,d,"monster","point",a.point);this._drawStatistics_add(b,d,"monster","count",1)};ui.prototype._drawStatistics_items=function(floorId,floor,id,obj){var hp=0,atk=0,def=0,mdef=0;if(obj.cls[id]=="items"&&id!="superPotion"){var temp=core.clone(core.status.hero);core.setFlag("__statistics__",true);var ratio=floor.item_ratio||1;try{eval(core.items.itemEffect[id])}catch(e){}hp=core.status.hero.hp-temp.hp;atk=core.status.hero.atk-temp.atk;def=core.status.hero.def-temp.def;mdef=core.status.hero.mdef-temp.mdef;core.status.hero=temp}else{if(obj.cls[id]=="equips"){var values=core.material.items[id].equip||{};atk=values.atk||0;def=values.def||0;mdef=values.mdef||0}}if(id.indexOf("sword")==0||id.indexOf("shield")==0||obj.cls[id]=="equips"){var t="";if(atk>0){t+=atk+"攻"}if(def>0){t+=def+"防"}if(mdef>0){t+=mdef+"魔防"}if(t!=""){obj.ext[id]=t}}this._drawStatistics_add(floorId,obj,"count",id,1);this._drawStatistics_add(floorId,obj,"add","hp",hp);this._drawStatistics_add(floorId,obj,"add","atk",atk);this._drawStatistics_add(floorId,obj,"add","def",def);this._drawStatistics_add(floorId,obj,"add","mdef",mdef)};ui.prototype._drawStatistics_generateText=function(b,e,a){var d=e+"地图中：\n";d+="共有怪物"+a.monster.count+"个";if(core.flags.enableMoney){d+="，总金币数"+a.monster.money}if(core.flags.enableExperience){d+="，总经验数"+a.monster.experience}if(core.flags.enableAddPoint){d+="，总加点数"+a.monster.point}d+="。\n";var c="";b.ids.forEach(function(f){var g=a.count[f];if(g==0){return}if(b.cls[f]!=c){if(c!=""){d+="。"}d+="\n"}else{d+="，"}c=b.cls[f];d+=core.ui._drawStatistics_getName(f)+g+"个";if(b.ext[f]){d+="("+b.ext[f]+")"}});if(c!=""){d+="。"}d+="\n\n";d+="共加生命值"+core.formatBigNumber(a.add.hp)+"点，攻击"+core.formatBigNumber(a.add.atk)+"点，防御"+core.formatBigNumber(a.add.def)+"点，魔防"+core.formatBigNumber(a.add.mdef)+"点。";return d};ui.prototype._drawStatistics_getName=function(a){return{yellowDoor:"黄门",blueDoor:"蓝门",redDoor:"红门",greenDoor:"绿门",steelDoor:"铁门"}[a]||core.material.items[a].name};ui.prototype.drawAbout=function(){return this.uidata.drawAbout()};ui.prototype.drawPaint=function(){core.drawText("\t[进入绘图模式]你可以在此页面上任意进行绘图和标记操作。\nM键可以进入或退出此模式。\n\n绘图的内容会自动保存，且以页面为生命周期，和存读档无关，重新开始游戏或读档后绘制的内容仍有效，但刷新页面就会消失。\n你可以将绘制内容保存到文件，也可以从文件读取保存的绘制内容。\n浏览地图页面可以按楼传按钮或M键来开启/关闭该层的绘图显示。\n\n更多功能请详见文档-元件-绘图模式。",this._drawPaint_draw)};ui.prototype._drawPaint_draw=function(){core.drawTip("打开绘图模式，现在可以任意在界面上绘图标记");core.lockControl();core.status.event.id="paint";core.status.event.data={x:null,y:null,erase:false};core.clearUI();core.createCanvas("paint",-core.bigmap.offsetX,-core.bigmap.offsetY,32*core.bigmap.width,32*core.bigmap.height,95);var a=core.paint[core.status.floorId];if(a){a=lzw_decode(a).split(",")}core.utils._decodeCanvas(a,32*core.bigmap.width,32*core.bigmap.height);core.drawImage("paint",core.bigmap.tempCanvas.canvas,0,0);core.setLineWidth("paint",3);core.setStrokeStyle("paint","#FF0000");core.statusBar.image.keyboard.style.opacity=0;core.statusBar.image.shop.style.opacity=0;core.statusBar.image.book.src=core.statusBar.icons.paint.src;core.statusBar.image.fly.src=core.statusBar.icons.erase.src;core.statusBar.image.toolbox.src=core.statusBar.icons.empty.src;core.statusBar.image.settings.src=core.statusBar.icons.exit.src;core.statusBar.image.book.style.opacity=1;core.statusBar.image.fly.style.opacity=1};ui.prototype.drawHelp=function(){core.clearUI();if(core.material.images.keyboard){core.status.event.id="help";core.lockControl();core.setAlpha("ui",1);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#FFFFFF");core.drawImage("ui",core.material.images.keyboard,0,0,416,416,0,0,352,352)}else{core.drawText(["\t[键盘快捷键列表][CTRL] 跳过对话   [Z] 转向\n[X] 怪物手册   [G] 楼层传送\n[A] 读取自动存档   [S/D] 存读档页面\n[V] 快捷商店   [ESC] 系统菜单\n[T] 道具页面   [Q] 装备页面\n[B] 数据统计   [H] 帮助页面\n[R] 回放录像   [E] 显示光标\n[SPACE] 轻按   [M] 绘图模式\n[N] 返回标题页面   [P] 游戏主页\n[O] 查看工程   [F7] 打开debug穿墙模式\n[PgUp/PgDn] 浏览地图\n[1~4] 快捷使用破炸飞和其他道具\n[Alt+0~9] 快捷换装","\t[鼠标操作]点状态栏中图标： 进行对应的操作\n点任意块： 寻路并移动\n点任意块并拖动： 指定寻路路线\n双击空地： 瞬间移动\n单击勇士： 转向\n双击勇士： 轻按（仅在轻按开关打开时有效）\n长按任意位置：跳过剧情对话或打开虚拟键盘"])}};ui.prototype.createCanvas=function(b,e,f,d,a,g){if(core.dymCanvas[b]){this.relocateCanvas(b,e,f);this.resizeCanvas(b,d,a);core.dymCanvas[b].canvas.style.zIndex=g;return core.dymCanvas[b]}var c=document.createElement("canvas");c.id=b;c.style.display="block";c.width=d;c.height=a;c.setAttribute("_left",e);c.setAttribute("_top",f);c.style.width=d*core.domStyle.scale+"px";c.style.height=a*core.domStyle.scale+"px";c.style.left=e*core.domStyle.scale+"px";c.style.top=f*core.domStyle.scale+"px";c.style.zIndex=g;c.style.position="absolute";core.dymCanvas[b]=c.getContext("2d");core.dom.gameDraw.appendChild(c);return core.dymCanvas[b]};ui.prototype.relocateCanvas=function(b,c,d){var a=core.getContextByName(b);if(!a){return null}if(c!=null){a.canvas.style.left=c*core.domStyle.scale+"px";a.canvas.setAttribute("_left",c)}if(d!=null){a.canvas.style.top=d*core.domStyle.scale+"px";a.canvas.setAttribute("_top",d)}return a};ui.prototype.resizeCanvas=function(c,e,b,d){var a=core.getContextByName(c);if(!a){return null}if(e!=null){if(!d){a.canvas.width=e}a.canvas.style.width=e*core.domStyle.scale+"px"}if(b!=null){if(!d){a.canvas.height=b}a.canvas.style.height=b*core.domStyle.scale+"px"}return a};ui.prototype.deleteCanvas=function(a){if(!core.dymCanvas[a]){return null}core.dom.gameDraw.removeChild(core.dymCanvas[a].canvas);delete core.dymCanvas[a]};ui.prototype.deleteAllCanvas=function(){Object.keys(core.dymCanvas).forEach(function(a){core.dom.gameDraw.removeChild(core.dymCanvas[a].canvas);delete core.dymCanvas[a]})};ui.prototype.statusBar=(function(){function a(){this.itemMx=[["book","wand","fly"],["cross","superPotion","pickaxe"],["bomb","centerFly","upFly"],["downFly","knife","snow"],["bigKey","earthquake","coin"],]}a.prototype.init=function(){var c=document.getElementById("outerBackground").getContext("2d");var b=core.material.images.images["statusBackground.jpg"];c.drawImage(b,0,0,640,400);c.fillStyle="#676767";c.fillRect(0,400,640,22);core.setTextAlign("outerUI","center");this.toolbarAction=[[main.core.openKeyBoard,main.core.openQuickShop,function(){core.insertAction([{type:"insert",name:"回收钥匙商店"}])}],[main.core.save,main.core.load,main.core.openSettings]];this.replayAction=[[core.triggerReplay,core.stopReplay,core.rewindReplay],[core.speedDownReplay,core.speedUpReplay,core.saveReplay]]};a.prototype.update=function(){this._update_props();this._update_items();this._update_equips();this._update_keys();this._update_infoWindow()};a.prototype._update_props=function(){core.clearMap("outerUI",10,40,105,130);var d="#E1E1E1";core.setFont("outerUI","bold 16px Verdana");if(core.status.floorId){core.fillText("outerUI",core.status.maps[core.status.floorId].title,62,61,d)}var c=["hp","atk","def","money"];var b=93;core.setTextAlign("outerUI","right");c.forEach(function(e){core.status.hero[e]=Math.round(core.status.hero[e]);core.fillText("outerUI",core.getRealStatus(e),110,b,d);b+=24});core.setTextAlign("outerUI","center")};a.prototype._update_items=function(){core.clearMap("outerUI",10,180,105,185);for(var b=0;b<this.itemMx.length;b++){for(var f=0;f<this.itemMx[b].length;f++){var e=this.itemMx[b][f];if(core.hasItem(e)){var c=core.material.icons.items[e],d=core.material.images.items;var g=13+f*33,h=190+b*32;core.drawImage("outerUI",d,0,32*c,32,32,g,h,32,32);if(e=="centerFly"){core.fillText("outerUI",core.itemCount(e),g+25,h+28,"#FFFFFF","bold 12px Verdana")}}}}};a.prototype._update_equips=function(){core.clearMap("outerUI",525,40,105,95);core.setFont("outerUI","bold 16px Verdana");var b=function(d,e,h,f,c){if(!h){core.fillText("outerUI",c,d+50,e+22,f)}else{core.fillText("outerUI",core.material.items[h].name,d+32,e+22,f);var g=core.material.icons.items[h];core.drawImage("outerUI",core.material.images.items,0,32*g,32,32,d+64,e,32,32)}};b(525,48,core.getFlag("nowWeapon"),"#FFCFAE","无武器");b(525,96,core.getFlag("nowShield"),"#D1CEFF","无防具")};a.prototype._update_keys=function(){core.clearMap("outerUI",525,140,105,75);var g=[],f=["yellowKey","blueKey","redKey"];f.forEach(function(j,h){g[h]=core.itemCount(j)});var b=528,c=142,e=2,d=0;while(e>=0&&d<28){if(g[e]){this.drawKey(f[e],b+(d%7)*14,c+parseInt(d/7)*17);g[e]--,d++}else{e--}}};a.prototype.drawKey=function(b,e,f){var c=3,d=0;if(b=="blueKey"){c+=16}else{if(b=="yellowKey"){d+=16}}core.drawImage("outerUI",core.statusBar.icons.keys,c,d,10,16,e,f,10,16)};a.prototype._update_infoWindow=function(){core.clearMap("outerUI",525,220,105,100);this.selectedItem=null};a.prototype.showInfo=function(c){core.clearMap("outerUI",525,220,105,100);var b=core.material.icons.items[c];core.fillText("outerUI",core.material.items[c].name,525+32,220+25,"#D1CEFF");core.drawImage("outerUI",core.material.images.items,0,32*b,32,32,525+64,224,32,32);core.ui.drawTextContent("outerUI",core.material.items[c].text,{left:526,top:256,maxWidth:105,color:"#D1CEFF"});this.selectedItem=c};a.prototype._update_toolBox=function(){core.clearMap("outerUI",520,310,115,80);var d=[];if(core.isReplaying()){d=[[core.status.replay.pausing?"play":"pause","stop","rewind"],["speedDown","speedUp","save"],]}else{d=[["keyboard","shop","help"],["save","load","settings"],]}for(var b=0;b<d.length;b++){for(var c=0;c<d[b].length;c++){core.drawImage("outerUI",core.statusBar.icons[d[b][c]],0,0,32,32,525+c*34,318+b*34,32,32)}}};a.prototype.isInGameDraw=function(b){var c=b.x/core.domStyle.scale,d=b.y/core.domStyle.scale;return c>=144&&c<=496&&d>=24&&d<=376};a.prototype.fixEventLoc=function(b){b=core.clone(b);b.x-=144*core.domStyle.scale,b.y-=24*core.domStyle.scale;return b};a.prototype.onclick=function(e,f){if(e<=112&&e>=13&&f<=350&&f>=190){if(core.isReplaying()||core.status.lockControl||core.isMoving()){return}var c=this.itemMx[parseInt((f-190)/32)][parseInt((e-13)/33)];if(!core.hasItem(c)){return}if(core.material.items[c].cls=="constants"){switch(c){case"book":core.openBook(true);break;case"fly":core.useFly(true);break;case"wand":core.insertAction({type:"useItem",id:c});break;case"snow":core.useItem("snow");break;default:this.showInfo(c)}}else{if(c!=this.selectedItem){this.showInfo(c)}else{switch(c){case"centerFly":core.ui.drawCenterFly();break;default:core.useItem(c)}}}return}if(e<=625&&e>=525&&f<=382&&f>=317){var d=parseInt((e-525)/32),b=parseInt((f-317)/32);if(core.isReplaying()){this.replayAction[b][d].call(core)}else{if(core.isPlaying()){this.toolbarAction[b][d].call(core,true)}}return}};a.prototype.print=function(d,c){if(!d){var b=this;setTimeout(function(){if(!b.infocnt){core.clearMap("outerUI",0,400,640,22)}},200);this.infocnt=0;return}core.clearMap("outerUI",0,400,640,22);core.setFont("outerUI","bold 16px Verdana");core.setTextAlign("outerUI","left");core.fillText("outerUI",d,10,416,"#E1E1E1");core.setTextAlign("outerUI","center");this.infocnt=c||1};a.prototype.infoRules=[{id:"lava",text:"岩浆好热啊!"},{id:"upFloor",text:"你看到了楼梯"},{id:"downFloor",text:"你看到了楼梯"},{id:"blueShop",text:"你看到了一个祭坛"},{id:"man",text:"你看到了一个老人"},{id:"woman",text:"你看到了一个商人"},{id:"fairy",text:"你看到了一个商人"},{id:"thief",text:"你看到了一个小偷"},];a.prototype.printEnvironmentInfo=function(){if(!this.infocnt){var d=[];for(var c in core.status.thisMap.blocks){var b=core.status.thisMap.blocks[c];if(!b.disable&&core.nearHero(b.x,b.y)){d.push(b.event.id)}}for(var c in this.infoRules){if(d.indexOf(this.infoRules[c].id)>=0){this.print(this.infoRules[c].text);return}}}};a.prototype.clearInfo=function(b){if(this.infocnt==1){this.print()}else{if(this.infocnt>1){this.infocnt--}}};return new a()})();