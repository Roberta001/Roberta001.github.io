"use strict";function maps(){this._init()}maps.prototype._init=function(){this.blocksInfo=maps_90f36752_8815_4be8_b32b_d7fad1d0542e};maps.prototype._setFloorSize=function(a){if(!a){core.floorIds.forEach(function(b){core.maps._setFloorSize(b)});return}core.floors[a].width=core.floors[a].width||core.__SIZE__;core.floors[a].height=core.floors[a].height||core.__SIZE__};maps.prototype.loadFloor=function(c,d){var b=core.floors[c];if(!d){d=b.map}if(d instanceof Array){d={map:d}}var a={};var f=["firstArrive","eachArrive","parallelDo","map","bgmap","fgmap","events","changeFloor","afterBattle","afterGetItem","afterOpenDoor","cannotMove"];for(var e in b){if(f.indexOf(e)==-1&&b[e]!=null){a[e]=core.clone(b[e])}}for(var e in d){if(f.indexOf(e)==-1&&d[e]!=null){a[e]=core.clone(d[e])}}d=this.decompressMap(d.map,c);a.blocks=this._mapIntoBlocks(d,b,c);return a};maps.prototype._mapIntoBlocks=function(g,c,d){var b=[];var k=core.floors[d].width;var h=core.floors[d].height;for(var e=0;e<h;e++){for(var f=0;f<k;f++){var a=this.initBlock(f,e,(g[e]||[])[f],true,c);if(a.id!=0||a.event.trigger){b.push(a)}}}return b};maps.prototype.getNumberById=function(a){core.status.id2number=core.status.id2number||{};if(core.status.id2number[a]!=null){return core.status.id2number[a]}return core.status.id2number[a]=this._getNumberById(a)};maps.prototype._getNumberById=function(a){for(var b in this.blocksInfo){if((this.blocksInfo[b]||{}).id==a){return parseInt(b)||0}}if(/^X\d+$/.test(a)){if(core.icons.getTilesetOffset(a)){return parseInt(a.substring(1))}}if(a=="none"){return 0}if(a=="airwall"){return 17}return 0};maps.prototype.getBlockByNumber=function(a){core.status.number2Block=core.status.number2Block||{};if(core.status.number2Block[a]!=null){return core.status.number2Block[a]}return core.status.number2Block[a]=this.initBlock(null,null,a,true)};maps.prototype.initBlock=function(g,h,f,a,e){var d=null;f=""+(f||0);if(f.endsWith(":f")){d=true}if(f.endsWith(":t")){d=false}f=parseInt(f);var b={x:g,y:h,id:f};if(d!=null){b.disable=d}if(f==17){b.event={cls:"terrains",id:"airwall",noPass:true,cannotIn:["up","down","left","right"]}}else{if(f in this.blocksInfo){b.event=JSON.parse(JSON.stringify(this.blocksInfo[f]))}else{if(core.icons.getTilesetOffset(f)){b.event={cls:"tileset",id:"X"+f,noPass:true}}else{b.event={cls:"terrains",id:"none",noPass:false}}}}if(typeof b.event.noPass==="string"){b.event.noPass=JSON.parse(b.event.noPass)}if(a){this._addInfo(b)}if(e){this._addEvent(b,g,h,(e.events||{})[g+","+h]);var c=(e.changeFloor||{})[g+","+h];if(c){this._addEvent(b,g,h,{trigger:"changeFloor",data:c})}}if(main.mode=="editor"){delete b.disable}return b};maps.prototype._addInfo=function(a){if(a.event.cls.indexOf("enemy")==0&&!a.event.trigger){a.event.trigger="battle"}if(a.event.cls=="items"&&!a.event.trigger){a.event.trigger="getItem"}if(a.event.noPass==null){if(a.event.cls!="items"){a.event.noPass=true}}if(a.event.animate==null){a.event.animate=core.icons._getAnimateFrames(a.event.cls,false)}a.event.height=32;if(a.event.cls=="enemy48"||a.event.cls=="npc48"){a.event.height=48}};maps.prototype._addEvent=function(a,d,e,b){if(!b){return}if(typeof b=="string"){b={data:[b]}}else{if(b instanceof Array){b={data:b}}}b.data=b.data||[];if(a.disable==null&&b.enable!=null){a.disable=!b.enable}if(b.animate===false){a.event.animate=1}for(var c in b){if(c!="enable"&&c!="animate"&&b[c]!=null){a.event[c]=core.clone(b[c])}}if(!a.event.trigger){a.event.trigger="action"}};maps.prototype._initMaps=function(){var b=core.floorIds;var d={};for(var c=0;c<b.length;c++){var a=b[c];d[a]=this.loadFloor(a)}return d};maps.prototype._initFloorMap=function(b){var c=core.clone(core.floors[b].map);var e=core.floors[b].width;var d=core.floors[b].height;for(var f=0;f<d;f++){if(c[f]==null){c[f]=[]}for(var g=0;g<e;g++){if(c[f][g]==null){c[f][g]=0}var a=core.floors[b].events[g+","+f];if(a&&a.enable===false&&main.mode=="play"){c[f][g]+=":f"}}}return c};maps.prototype.compressMap=function(c,a){var b=this._initFloorMap(a);if(core.utils.same(c,b)){return null}var e=core.floors[a].width;var d=core.floors[a].height;for(var f=0;f<d;f++){if(core.utils.same(c[f],b[f])){c[f]=0}else{for(var g=0;g<e;g++){if(c[f][g]===b[f][g]){c[f][g]=-1}}}}return c};maps.prototype.decompressMap=function(c,a){var b=this._initFloorMap(a);if(!c){return b}var e=core.floors[a].width;var d=core.floors[a].height;for(var f=0;f<d;f++){if(c[f]===0){c[f]=b[f]}else{for(var g=0;g<e;g++){if(c[f][g]===-1){c[f][g]=b[f][g]}}}}return c};maps.prototype.saveMap=function(c){var g=core.status.maps;if(!c){var e={};for(var d in g){var h=this.saveMap(d);if(Object.keys(h).length>0){e[d]=h}}return e}var e=g[c],b=core.floors[c];var a=this._getMapArrayFromBlocks(e.blocks,b.width,b.height,true);if(main.mode=="editor"){return a}var i=this._compressFloorData(e,b);var f=this.compressMap(a,c);if(f!=null){i.map=f}return i};maps.prototype._compressFloorData=function(c,a){var e={};for(var d in c){if(d!="blocks"){var b=a[d];if(!core.utils.same(c[d],b)){e[d]=core.clone(c[d])}}}return e};maps.prototype.loadMap=function(a,b){if(!b){var c={};core.floorIds.forEach(function(d){c[d]=core.maps.loadFloor(d,a[d])});return c}return this.loadFloor(b,a[b])};maps.prototype.resizeMap=function(c){c=c||core.status.floorId;if(!c){return}core.bigmap.width=core.floors[c].width;core.bigmap.height=core.floors[c].height;var b=core.bigmap.width*32;var a=core.bigmap.height*32;core.bigmap.canvas.forEach(function(d){core.canvas[d].canvas.setAttribute("width",b);core.canvas[d].canvas.setAttribute("height",a);core.canvas[d].canvas.style.width=b*core.domStyle.scale+"px";core.canvas[d].canvas.style.height=a*core.domStyle.scale+"px";if(main.mode==="editor"&&editor.isMobile){core.canvas[d].canvas.style.width=core.bigmap.width*32/core.__PIXELS__*96+"vw";core.canvas[d].canvas.style.height=core.bigmap.height*32/core.__PIXELS__*96+"vw"}})};maps.prototype.getMapArray=function(a,b){a=a||core.status.floorId;return this._getMapArrayFromBlocks(core.status.maps[a].blocks,core.floors[a].width,core.floors[a].height,b)};maps.prototype._getMapArrayFromBlocks=function(b,g,e,f){if(typeof b=="string"){var d=b;b=core.status.maps[d].blocks;g=core.floors[d].width;e=core.floors[d].height}var c=[];var a=[];for(var i=0;i<g;i++){a.push(0)}for(var h=0;h<e;h++){c.push(core.clone(a))}b.forEach(function(j){var k=j.x,l=j.y;if(j.disable){if(f){c[l][k]=j.id+":f"}}else{c[l][k]=j.id;if(f&&j.disable===false){c[l][k]=j.id+":t"}}});return c};maps.prototype.getMapBlocksObj=function(a,c){a=a||core.status.floorId;var b={};core.status.maps[a].blocks.forEach(function(d){if(!d.disable||c){b[d.x+","+d.y]=d}});return b};maps.prototype._getBgFgMapArray=function(e,c,f){c=c||core.status.floorId;if(!c){return[]}var h=core.floors[c].width;var d=core.floors[c].height;if(!f&&core.status[e+"maps"][c]){return core.status[e+"maps"][c]}var a=core.clone(core.floors[c][e+"map"]||[]);if(main.mode=="editor"&&!(window.editor&&editor.uievent&&editor.uievent.isOpen)){a=core.clone(editor[e+"map"])||a}for(var i=0;i<h;i++){for(var j=0;j<d;j++){a[j]=a[j]||[];var b="__"+e+"Map__"+c+"_"+i+"_"+j;var g="__"+e+"Value__"+c+"_"+i+"_"+j;if(core.hasFlag(b)){a[j][i]=0}else{a[j][i]=core.getFlag(g,a[j][i]||0)}if(main.mode=="editor"){a[j][i]=a[j][i].idnum||a[j][i]||0}}}if(core.status[e+"maps"]){core.status[e+"maps"][c]=core.clone(a)}return a};maps.prototype.getBgMapArray=function(a,b){return this._getBgFgMapArray("bg",a,b)};maps.prototype.getFgMapArray=function(a,b){return this._getBgFgMapArray("fg",a,b)};maps.prototype._getBgFgNumber=function(b,d,e,a,c){if(d==null){d=core.getHeroLoc("x")}if(e==null){e=core.getHeroLoc("y")}return this._getBgFgMapArray(b,a,c)[e][d]};maps.prototype.getBgNumber=function(c,d,a,b){return this._getBgFgNumber("bg",c,d,a,b)};maps.prototype.getFgNumber=function(c,d,a,b){return this._getBgFgNumber("fg",c,d,a,b)};maps.prototype.generateMovableArray=function(f,j,k,c){f=f||core.status.floorId;if(!f){return null}var i=core.floors[f].width,h=core.floors[f].height;var b=this.getBgMapArray(f),e=this.getFgMapArray(f),d=this.getMapArray(f);var g=function(m,n,l){if(l!=null){return core.maps._canMoveHero_checkPoint(m,n,l,f,{bgArray:b,fgArray:e,eventArray:d})}return["left","down","up","right"].filter(function(o){return core.maps._canMoveHero_checkPoint(m,n,o,f,{bgArray:b,fgArray:e,eventArray:d})})};if(j!=null&&k!=null){return g(j,k,c)}var a=[];for(var j=0;j<i;j++){a[j]=[];for(var k=0;k<h;k++){a[j][k]=g(j,k)}}return a};maps.prototype.canMoveHero=function(c,d,a,b){if(c==null){c=core.getHeroLoc("x")}if(d==null){d=core.getHeroLoc("y")}a=a||core.getHeroLoc("direction");return this.generateMovableArray(b,c,d,a)};maps.prototype._canMoveHero_checkPoint=function(f,g,a,c,b){if(core.inArray((core.floors[c].cannotMove||{})[f+","+g],a)){return false}var d=f+core.utils.scan[a].x,e=g+core.utils.scan[a].y;if(d<0||e<0||d>=core.floors[c].width||e>=core.floors[c].height){return false}if(!core.isReplaying()&&(d<1||e<1||d>=core.floors[c].width-1||e>=core.floors[c].height-1)){return false}if(this._canMoveHero_checkCannotInOut([b.bgArray[g][f],b.fgArray[g][f],b.eventArray[g][f]],"cannotOut",a)){return false}if(this._canMoveHero_checkCannotInOut([b.bgArray[e][d],b.fgArray[e][d],b.eventArray[e][d]],"cannotIn",a)){return false}if(c==core.status.floorId&&core.status.hero.hp<=(core.status.checkBlock.damage[d+","+e]||0)&&!core.flags.canGoDeadZone&&b.eventArray[e][d]==0){return false}return true};maps.prototype._canMoveHero_checkCannotInOut=function(c,b,a){if(c instanceof Array){for(var d in c){if(this._canMoveHero_checkCannotInOut(c[d],b,a)){return true}}return false}return core.inArray((this.getBlockByNumber(c).event||{})[b],a)};maps.prototype.canMoveDirectly=function(a,b){return this.canMoveDirectlyArray([[a,b]])[0]};maps.prototype.canMoveDirectlyArray=function(e){var a=[],f=e.length;var b=core.getHeroLoc("x"),c=core.getHeroLoc("y");if(!this._canMoveDirectly_checkGlobal()){for(var d=0;d<f;++d){a.push(-1)}return a}for(var d=0;d<f;++d){if(e[d][0]==b&&e[d][1]==c){a.push(0);f--}else{if(e[d][0]<0||e[d][0]>=core.bigmap.width||e[d][1]<0||e[d][1]>=core.bigmap.height){a.push(-1);f--}else{a.push(null)}}}if(f==0){return a}if(!this._canMoveDirectly_checkStartPoint(b,c)){for(var d in a){if(a[d]==null){a[d]=-1}}return a}return this._canMoveDirectly_bfs(b,c,e,f,a)};maps.prototype._canMoveDirectly_checkGlobal=function(){if(!core.flags.enableMoveDirectly){return false}if(core.status.thisMap.cannotMoveDirectly){return false}if(core.hasFlag("cannotMoveDirectly")){return false}if(core.hasFlag("poison")){return false}return true};maps.prototype._canMoveDirectly_checkStartPoint=function(b,c){if(core.status.checkBlock.damage[b+","+c]){return false}var a=core.getBlock(b,c);if(a!=null){return a.block.event.trigger=="changeFloor"}return true};maps.prototype._canMoveDirectly_bfs=function(o,p,g,k,a){var d=this.generateMovableArray();var c=this.getMapBlocksObj(core.status.floorId);var b=this.getBgMapArray();var q=[],n=[];q[o+","+p]=0;n.push(o+","+p);while(n.length>0){var j=n.shift().split(","),r=parseInt(j[0]),s=parseInt(j[1]);for(var e in core.utils.scan){if(!core.inArray(d[r][s],e)){continue}var l=r+core.utils.scan[e].x,m=s+core.utils.scan[e].y,h=l+","+m;if(q[h]){continue}if(b[m][l]==167){continue}if(!this._canMoveDirectly_checkNextPoint(c,l,m)){continue}q[h]=q[j]+1;for(var f in a){if(g[f][0]==l&&g[f][1]==m&&a[f]==null){a[f]=q[h];k--;if(k==0){return a}}}n.push(h)}}for(var f in a){if(a[f]==null){a[f]=-1}}return a};maps.prototype._canMoveDirectly_checkNextPoint=function(a,c,d){var b=c+","+d;if(a[b]&&(a[b].event.trigger||a[b].event.noPass)){return false}if(core.status.checkBlock.damage[b]){return false}if(core.status.checkBlock.ambush[b]){return false}return true};maps.prototype.automaticRoute=function(b,c){var h=core.getHeroLoc("x"),i=core.getHeroLoc("y");if(b==h&&c==i){return[]}var g=this._automaticRoute_bfs(h,i,b,c);if(g[b+","+c]==null){return[]}var a=[],e=b,f=c;while(e!=h||f!=i){var d=g[e+","+f];a.push({direction:d,x:e,y:f});e-=core.utils.scan[d].x;f-=core.utils.scan[d].y}a.reverse();return a};maps.prototype._automaticRoute_bfs=function(m,n,d,e){var l={},a=this.generateMovableArray();var k=new PriorityQueue({comparator:function(o,p){return o.depth-p.depth}});l[m+","+n]="";k.queue({depth:0,x:m,y:n});while(k.length!=0){var b=k.dequeue(),c=b.depth,g=b.x,h=b.y;for(var f in core.utils.scan){if(!core.inArray(a[g][h],f)){continue}var i=g+core.utils.scan[f].x;var j=h+core.utils.scan[f].y;if(i<0||i>=core.bigmap.width||j<0||j>=core.bigmap.height||l[i+","+j]!=null){continue}if(i==d&&j==e){l[i+","+j]=f;break}if(core.noPass(i,j)){continue}l[i+","+j]=f;k.queue({depth:c+this._automaticRoute_deepAdd(i,j),x:i,y:j})}if(l[d+","+e]!=null){break}}return l};maps.prototype._automaticRoute_deepAdd=function(d,e){var b=1;var a=core.getBlock(d,e);if(a!=null){var c=a.block.event.id;if(c=="light"){b+=100}if(c.endsWith("Net")){b+=100}if(!core.flags.potionWhileRouting&&c.endsWith("Potion")){b+=100}}b+=(core.status.checkBlock.damage[d+","+e]||0)*100;if(core.status.checkBlock.ambush[d+","+e]){b+=1000}return b};maps.prototype.drawBlock=function(b,a){if(b.event.id=="none"){return}var d=a!=null;if(!d){a=0}var e=b.x,f=b.y;if(d&&b.event.animate>1&&(32*e<core.bigmap.offsetX-64||32*e>core.bigmap.offsetX+core.__PIXELS__+32||32*f<core.bigmap.offsetY-64||32*f>core.bigmap.offsetY+core.__PIXELS__+32+16)){return}var c=this.getBlockInfo(b);if(c==null){return}if(c.cls!="tileset"){c.posX=a%b.event.animate}if(!b.name){this._drawBlockInfo(c,b.x,b.y)}else{this._drawBlockInfo_bgfg(c,b.name,b.x,b.y)}};maps.prototype._drawBlockInfo=function(a,f,g){var c=a.image,d=a.posX,e=a.posY,b=a.height;core.clearMap("event",f*32,g*32,32,32);core.drawImage("event",c,d*32,e*b+b-32,32,32,f*32,g*32,32,32);if(b>32){core.clearMap("event2",f*32,g*32+32-b,32,b-32);core.drawImage("event2",c,d*32,e*b,32,b-32,f*32,g*32+32-b,32,b-32)}};maps.prototype._drawBlockInfo_bgfg=function(a,d,g,h){var c=a.image,e=a.posX,f=a.posY,b=a.height;core.clearMap(d,g*32,h*32+32-b,32,b);if(d=="bg"){if(b>32){core.clearMap("bg",g*32,h*32-32,32,32);core.drawImage("bg",core.material.groundCanvas.canvas,g*32,h*32-32)}core.drawImage("bg",core.material.groundCanvas.canvas,g*32,h*32)}core.drawImage(d,c,e*32,f*b,32,b,g*32,h*32+32-b,32,b)};maps.prototype.generateGroundPattern=function(a){var b=((core.status.maps||core.floors)[a||core.status.floorId]||{}).defaultGround||"ground";core.material.groundCanvas.clearRect(0,0,32,32);core.material.groundCanvas.drawImage(core.material.images.terrains,0,32*core.material.icons.terrains[b],32,32,0,0,32,32);core.material.groundPattern=core.material.groundCanvas.createPattern(core.material.groundCanvas.canvas,"repeat")};maps.prototype.drawMap=function(b,a){b=b||core.status.floorId;if(!b){if(a){a()}return}core.clearMap("all");this.generateGroundPattern(b);core.status.floorId=b;core.status.thisMap=core.status.maps[b];this._drawMap_drawAll();if(core.status.curtainColor){core.fillRect("curtain",0,0,core.__PIXELS__,core.__PIXELS__,core.arrayToRGBA(core.status.curtainColor))}core.drawHero();core.updateStatusBar();if(a){a()}};maps.prototype._drawMap_drawAll=function(a){a=a||core.status.floorId;this.drawBg(a);this.drawEvents(a);this.drawFg(a)};maps.prototype._drawMap_drawBlockInfo=function(d,b,c,a,f){if(c==null){return}if(c.cls=="autotile"){this._drawAutotile(d,a,b,32,0,0);if(f){this.addGlobalAnimate(b)}return}if(!f){var e=c.height;core.drawImage(d,c.image,32*c.posX,e*c.posY,32,e,32*b.x,32*b.y+32-e,32,e);return}this.drawBlock(b);this.addGlobalAnimate(b)};maps.prototype.drawBg=function(b,a){b=b||core.status.floorId;var c=a==null;if(c){a=core.canvas.bg;core.clearMap(a);core.status.floorAnimateObjs=this._getFloorImages(b)}core.maps._drawBg_drawBackground(b,a);core.maps._drawFloorImages(b,a,"bg");core.maps._drawBgFgMap(b,a,"bg",c)};maps.prototype._drawBg_drawBackground=function(b,a){var g=core.floors[b].width,d=core.floors[b].height;var c=(core.status.maps||core.floors)[b].defaultGround||"ground";var h=core.material.icons.terrains[c];if(h!=null){for(var e=0;e<g;e++){for(var f=0;f<d;f++){a.drawImage(core.material.images.terrains,0,h*32,32,32,e*32,f*32,32,32)}}}};maps.prototype.drawEvents=function(d,b,c){d=d||core.status.floorId;if(!b){b=core.status.maps[d].blocks}var a=this._getMapArrayFromBlocks(b,core.floors[d].width,core.floors[d].height);var e=c==null;if(e){c=core.canvas.event}b.filter(function(f){return f.event&&!f.disable}).forEach(function(f){core.maps._drawMap_drawBlockInfo(c,f,core.maps.getBlockInfo(f),a,e)});if(e){core.status.autotileAnimateObjs.map=core.clone(a)}};maps.prototype.drawFg=function(b,a){b=b||core.status.floorId;var c=a==null;if(c){a=core.canvas.fg;core.status.floorAnimateObjs=this._getFloorImages(b)}this._drawFloorImages(b,a,"fg");this._drawBgFgMap(b,a,"fg",c)};maps.prototype._drawBgFgMap=function(h,f,j,k){h=h||core.status.floorId;if(!h){return}var l=core.floors[h].width;var i=core.floors[h].height;if(!core.status[j+"maps"]){core.status[j+"maps"]={}}var b=this._getBgFgMapArray(j,h,true);var g=null;if(j=="fg"&&k&&this._drawBgFgMap_shouldBlurFg()){g=this.getMapArray(h)}for(var m=0;m<l;m++){for(var n=0;n<i;n++){var c=this.initBlock(m,n,b[n][m],true);c.name=j;var d=this.getBlockInfo(c);if(!d){continue}var e=false,a;if(g!=null&&g[n][m]!=0){e=true;a=f.globalAlpha;f.globalAlpha=0.6}this._drawMap_drawBlockInfo(f,c,d,b,k);if(e){f.globalAlpha=a}}}if(k){core.status.autotileAnimateObjs[j+"map"]=core.clone(b)}};maps.prototype._drawBgFgMap_shouldBlurFg=function(){return main.mode=="editor"||core.flags.blurFg};maps.prototype._drawFloorImages=function(c,a,e,d,b){c=c||core.status.floorId;if(!d){d=this._getFloorImages(c)}var f=b!=null;d.forEach(function(m){if(typeof m=="string"){m=[0,0,m]}var g=parseInt(m[0]),h=parseInt(m[1]),k=m[2],i=core.clamp(parseInt(m[4]),1,8);k=core.getMappedName(k);var j=core.material.images.images[k];if(f&&i==1){return}if(core.isset(g)&&core.isset(h)&&j&&!core.hasFlag("__floorImg__"+c+"_"+g+"_"+h)){var n=parseInt(j.width/i),l=(b||0)%i*n;if(/.*\.gif/i.test(k)&&main.mode=="play"){if(f){return}this._drawFloorImages_gif(j,g,h);return}core.maps._drawFloorImage(a,e,m[3],j,l,n,g,h,f)}})};maps.prototype._getFloorImages=function(a){a=a||core.status.floorId;var b=[];if((core.status.maps||core.floors)[a].images){b=(core.status.maps||core.floors)[a].images;if(typeof b=="string"){b=[[0,0,b]]}}return b};maps.prototype._drawFloorImages_gif=function(d,a,b){core.dom.gif.innerHTML="";var c=new Image();c.src=d.src;c.style.position="absolute";c.style.left=(a*core.domStyle.scale)+"px";c.style.top=(b*core.domStyle.scale)+"px";c.style.width=d.width*core.domStyle.scale+"px";c.style.height=d.height*core.domStyle.scale+"px";core.dom.gif.appendChild(c);return};maps.prototype._drawFloorImage=function(b,g,j,f,h,k,c,d,i){var e=f.height;var a=function(){if(i){core.clearMap(b,c,d,k,e)}core.drawImage(b,f,h,0,k,e,c,d,k,e)};if(!j){if(g!="bg"){return}return a()}if(j==1){if(g!="fg"){return}return a()}if(j==2){if(g=="bg"){if(i){core.clearMap(b,c,d+e-32,k,32)}core.drawImage("bg",f,h,e-32,k,32,c,d+e-32,k,32)}else{if(g=="fg"){if(i){core.clearMap(b,c,d,k,e-32)}core.drawImage("fg",f,h,0,k,e-32,c,d,k,e-32)}}return}};maps.prototype._drawAutotile=function(d,i,c,j,h,l,k){var m=c.x,n=c.y;var b=core.material.images.autotile[c.event.id];k=k||0;k%=parseInt(b.width/96);var e={};var g=function(o,p){if(core.maps._drawAutotile_getAutotileAroundId(i[n][m],o,p,i)){return 1}else{return 0}};var f=[];[-1,0,1].forEach(function(o){f[o]=[];[-1,0,1].forEach(function(p){f[o][p]=g(m+o,n+p)})});if(f[-1][-1]+f[0][-1]+f[0][0]+f[-1][0]==3&&!f[-1][-1]){this._drawAutotile_render(d,m*j+h,n*j+l,j,b,k,16);e[0]=true}if(f[0][-1]+f[1][-1]+f[1][0]+f[0][0]==3&&!f[1][-1]){this._drawAutotile_render(d,m*j+h+j/2,n*j+l,j,b,k,17);e[1]=true}if(f[0][0]+f[1][0]+f[1][1]+f[0][1]==3&&!f[1][1]){this._drawAutotile_render(d,m*j+h+j/2,n*j+l+j/2,j,b,k,18);e[3]=true}if(f[0-1][0]+f[0][0]+f[0][1]+f[-1][1]==3&&!f[-1][1]){this._drawAutotile_render(d,m*j+h,n*j+l+j/2,j,b,k,19);e[2]=true}var a=f[0][-1]+2*f[-1][0]+4*f[0][1]+8*f[1][0];this._drawAutotile_render(d,m*j,n*j,j,b,k,a,e)};maps.prototype._drawAutotile_render=function(b,i,j,g,a,h,e,d){var f=[[[96*h,0,32,32,i,j,g,g],],[[96*h,3*32,16,32,i,j,g/2,g],[96*h+2*32+16,3*32,16,32,i+g/2,j,g/2,g],],[[96*h+2*32,32,32,16,i,j,g,g/2],[96*h+2*32,3*32+16,32,16,i,j+g/2,g,g/2],],[[96*h+2*32,3*32,32,32,i,j,g,g],],[[96*h,32,16,32,i,j,g/2,g],[96*h+2*32+16,32,16,32,i+g/2,j,g/2,g],],[[96*h,2*32,16,32,i,j,g/2,g],[96*h+2*32+16,2*32,16,32,i+g/2,j,g/2,g],],[[96*h+2*32,32,32,32,i,j,g,g],],[[96*h+2*32,2*32,32,32,i,j,g,g],],[[96*h,32,32,16,i,j,g,g/2],[96*h,3*32+16,32,16,i,j+g/2,g,g/2],],[[96*h,3*32,32,32,i,j,g,g],],[[96*h+32,32,32,16,i,j,g,g/2],[96*h+32,3*32+16,32,16,i,j+g/2,g,g/2],],[[96*h+32,3*32,32,32,i,j,g,g],],[[96*h,32,32,32,i,j,g,g],],[[96*h,2*32,32,32,i,j,g,g],],[[96*h+32,32,32,32,i,j,g,g],],[[96*h+32,2*32,32,32,i,j,g,g],],[[96*h+2*32,0,16,16,i,j,g/2,g/2],],[[96*h+2*32+16,0,16,16,i,j,g/2,g/2],],[[96*h+2*32+16,16,16,16,i,j,g/2,g/2],],[[96*h+2*32,16,16,16,i,j,g/2,g/2],],];var c=f[e];if(e>=16){b.drawImage(a,c[0][0],c[0][1],c[0][2],c[0][3],c[0][4],c[0][5],g/2,g/2)}else{this._drawAutotile_renderCut(b,a,i,j,g,c,d)}};maps.prototype._drawAutotile_renderCut=function(b,a,l,m,k,d,e){var f=[];e=e||{};if(d.length==2){var j=0;var c=0;for(var h in d){if(d[h][2]%32){c=0}else{if(d[h][3]%32){c=1}}if(d[h][0]%32||d[h][1]%32){j=1}else{j=0}if(c){j*=2;if(!e[j]){f[j]=[d[h][0],d[h][1]]}if(!e[j+1]){f[j+1]=[parseInt(d[h][0])+16,d[h][1]]}}else{if(!e[j]){f[j]=[d[h][0],d[h][1]]}if(!e[j+2]){f[j+2]=[d[h][0],parseInt(d[h][1])+16]}}}}else{if(!e[0]){f[0]=[d[0][0],d[0][1]]}if(!e[1]){f[1]=[d[0][0]+16,d[0][1]]}if(!e[2]){f[2]=[d[0][0],d[0][1]+16]}if(!e[3]){f[3]=[d[0][0]+16,d[0][1]+16]}}for(var h=0;h<4;h++){var g=f[h];if(!g){continue}b.drawImage(a,g[0],g[1],16,16,l+(h%2)*k/2,m+parseInt(h/2)*k/2,k/2,k/2)}};maps.prototype._drawAutotile_drawBlockByIndex=function(b,c,d,a,e,f,g){var h=16*((e-1)%6),i=16*(~~((e-1)/6));g=g||0;g%=parseInt(a.width/96);b.drawImage(a,h+96*g,i,16,16,c,d,f/2,f/2)};maps.prototype._drawAutotile_getAutotileAroundId=function(a,c,d,b){if(c<0||d<0||c>=b[0].length||d>=b.length){return 1}else{return core.material.autotileEdges[a].indexOf(b[d][c])>=0}};maps.prototype._drawAutotile_checkAround=function(o,p,g){var d=g[p][o];var n=[];for(var e=0;e<4;e++){var c=0;var l=e%2,m=~~(e/2);for(var f=0;f<4;f++){var h=f%2,k=~~(f/2);var a=this._drawAutotile_getAutotileAroundId(d,o+l+h-1,p+m+k-1,g);c+=a*(Math.pow(2,3-f))}n.push(c)}return n};maps.prototype._drawAutotile_getAutotileIndexs=function(g,h,e,d){var c=[];var f=this._drawAutotile_checkAround(g,h,e);for(var b=0;b<4;b++){var a=d[f[b]];c.push(a[3-b])}return c};maps.prototype._drawAutotileAnimate=function(b,a){var d=b.x,e=b.y;if(32*d<core.bigmap.offsetX-64||32*d>core.bigmap.offsetX+core.__PIXELS__+32||32*e<core.bigmap.offsetY-64||32*e>core.bigmap.offsetY+core.__PIXELS__+32+16){return}var c=b.name?core.canvas[b.name]:core.canvas.event;c.clearRect(32*d,32*e,32,32);if(b.name){if(b.name=="bg"){core.drawImage("bg",core.material.groundCanvas.canvas,32*d,32*e)}this._drawAutotile(c,core.status.autotileAnimateObjs[b.name+"map"],b,32,0,0,a)}else{this._drawAutotile(c,core.status.autotileAnimateObjs.map,b,32,0,0,a)}};maps.prototype._makeAutotileEdges=function(){var a=Object.keys(core.material.images.autotile);core.material.autotileEdges={};var b=document.createElement("canvas"),c=b.getContext("2d");b.width=b.height=32;c.mozImageSmoothingEnabled=false;c.webkitImageSmoothingEnabled=false;c.msImageSmoothingEnabled=false;c.imageSmoothingEnabled=false;a.forEach(function(f){var e=core.maps.getNumberById(f);core.material.autotileEdges[e]=[e];c.clearRect(0,0,32,32);c.drawImage(core.material.images.autotile[f],0,0,32,32,0,0,32,32);var d=b.toDataURL("image/png");a.forEach(function(h){if(f==h){return}var g=core.maps.getNumberById(h);c.clearRect(0,0,32,32);c.drawImage(core.material.images.autotile[h],32,0,32,32,0,0,32,32);if(d==b.toDataURL("image/png")){core.material.autotileEdges[e].push(g)}})})};maps.prototype.drawThumbnail=function(b,a,c,d){b=b||core.status.floorId;if(!b){return}this._drawThumbnail_drawTempCanvas(b,a,c);this._drawThumbnail_drawToTarget(b,d)};maps.prototype._drawThumbnail_drawTempCanvas=function(c,a,f){a=a||core.status.maps[c].blocks;f=f||{};var j=core.floors[c].width;var e=core.floors[c].height;var g=core.bigmap.tempCanvas;var i=j*32,h=e*32;g.canvas.width=i;g.canvas.height=h;g.clearRect(0,0,i,h);var d=core.status.hero!=null,b=null;if(f.flags){if(!d){core.status.hero={}}b=core.status.hero.flags;core.status.hero.flags=f.flags}this._drawThumbnail_realDrawTempCanvas(c,a,f,g);if(!d){delete core.status.hero}else{if(b!=null){core.status.hero.flags=b}}};maps.prototype._drawThumbnail_realDrawTempCanvas=function(b,a,e,f){this.drawBg(b,f);this.drawEvents(b,a,f);if(e.heroLoc){e.heroIcon=e.heroIcon||core.getFlag("heroIcon","hero.png");e.heroIcon=core.getMappedName(e.heroIcon);var d=core.material.icons.hero[e.heroLoc.direction];var c=core.material.images.images[e.heroIcon].height/4;f.drawImage(core.material.images.images[e.heroIcon],d.stop*32,d.loc*c,32,c,32*e.heroLoc.x,32*e.heroLoc.y+32-c,32,c)}this.drawFg(b,f);if(e.damage){core.control.updateDamage(b,f)}};maps.prototype._drawThumbnail_drawToTarget=function(d,o){if(o==null){return}if(typeof o=="string"||o.canvas){o={ctx:o}}var c=core.getContextByName(o.ctx);if(c==null){return}var q=o.x||0,r=o.y||0,k=o.size||core.__PIXELS__;var p=core.floors[d].width,e=core.floors[d].height;var a=o.centerX,b=o.centerY;if(a==null){a=Math.floor(p/2)}if(b==null){b=Math.floor(e/2)}var l=core.bigmap.tempCanvas,n=32*p,m=32*e;core.clearMap(c,q,r,k,k);if(o.all){if(n<=m){var h=k,i=h*n/m;var j=(k-i)/2;core.fillRect(c,q,r,j,h,"#000000");core.fillRect(c,q+k-j,r,j,h);c.drawImage(l.canvas,32,32,n-64,m-64,q+j,r,i,h)}else{var i=k,h=i*m/n;var j=(k-h)/2;core.fillRect(c,q,r,i,j,"#000000");core.fillRect(c,q,r+k-j,i,j);c.drawImage(l.canvas,32,32,n-64,m-64,q,r+j,i,h)}}else{var f=1,g=1;c.drawImage(l.canvas,f*32,g*32,core.__PIXELS__,core.__PIXELS__,q,r,k,k)}};maps.prototype.noPass=function(c,d,b){var a=core.getBlock(c,d,b);if(a==null){return false}return a.block.event.noPass};maps.prototype.npcExists=function(c,d,b){var a=this.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls.indexOf("npc")==0};maps.prototype.terrainExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(c?a.block.event.id==c:true)};maps.prototype.stairExists=function(d,e,b){var a=this.getBlockId(d,e,b);if(a==null){return false}var c=["upFloor","downFloor"];if(core.flags.flyRecordPosition){c=c.concat(["leftPortal","rightPortal","upPortal","downPortal"])}return c.indexOf(a)>=0};maps.prototype.nearStair=function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");return this.stairExists(a,b)||this.stairExists(a-1,b)||this.stairExists(a,b-1)||this.stairExists(a+1,b)||this.stairExists(a,b+1)};maps.prototype.enemyExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls.indexOf("enemy")==0&&(c?a.block.event.id==c:true)};maps.prototype.getBlock=function(e,f,b,d){b=b||core.status.floorId;if(!b){return null}var a=core.status.maps[b].blocks;for(var c=0;c<a.length;c++){if(a[c].x==e&&a[c].y==f){if(!d&&a[c].disable){return null}return{index:c,block:a[c]}}}return null};maps.prototype.getBlockId=function(d,e,b,c){var a=core.getBlock(d,e,b,c);return a==null?null:a.block.event.id};maps.prototype.getBlockCls=function(d,e,b,c){var a=core.getBlock(d,e,b,c);return a==null?null:a.block.event.cls};maps.prototype.getBlockInfo=function(b){if(!b){return null}if(typeof b=="string"){b=this.getNumberById(b)}if(typeof b=="number"){if(b==0){return null}b=this.getBlockByNumber(b)}var i=b.id,f=b.event.id,c=b.event.cls,h=b.event.name,g=null,k=0,l=0,a=b.event.animate,e=b.event.height||32,d={};if(f=="none"){return null}else{if(f=="airwall"){if(!core.material.images.airwall){return null}g=core.material.images.airwall;h="空气墙"}else{if(c=="tileset"){var j=core.icons.getTilesetOffset(f);if(j==null){return null}k=j.x;l=j.y;g=core.material.images.tilesets[j.image]}else{if(c=="autotile"){g=core.material.images.autotile[f]}else{g=core.material.images[c];l=core.material.icons[c][f];d=b.event.faceIds||{};if(core.material.enemys[f]){h=core.material.enemys[f].name}else{if(core.material.items[f]){h=core.material.items[f].name}}}}}}return{number:i,id:f,cls:c,name:h,image:g,posX:k,posY:l,height:e,faceIds:d,animate:a}};maps.prototype.searchBlock=function(d,b,f){if(typeof d=="number"){d=this.getBlockByNumber(d).event.id}b=b||core.status.floorId;var e=[];if(b instanceof Array){b.forEach(function(g){e=e.concat(core.searchBlock(d,g,f))});return e}for(var c=0;c<core.status.maps[b].blocks.length;++c){var a=core.status.maps[b].blocks[c];if((f||!a.disable)&&core.matchWildcard(d,a.event.id)){e.push({floorId:b,index:c,block:a,x:a.x,y:a.y})}}return e};maps.prototype.showBlock=function(c,d,b){b=b||core.status.floorId;if(!b){return}var a=core.getBlock(c,d,b,true);if(a==null){return}a=a.block;if(a.disable){a.disable=false;if(b==core.status.floorId){core.drawBlock(a);core.addGlobalAnimate(a)}core.updateStatusBar()}};maps.prototype.hideBlock=function(d,e,b){b=b||core.status.floorId;if(!b){return}var a=core.getBlock(d,e,b,true);if(a==null){return}if(b==core.status.floorId){core.removeGlobalAnimate(d,e);core.clearMap("event",d*32,e*32,32,32);var c=a.block.event.height||32;if(c>32){core.clearMap("event2",d*32,e*32+32-c,32,c-32)}}a.block.disable=true;core.updateStatusBar()};maps.prototype.removeBlock=function(e,f,b){b=b||core.status.floorId;if(!b){return}var a=core.getBlock(e,f,b,true);if(a==null){return}var d=a.index;if(b==core.status.floorId){core.removeGlobalAnimate(e,f);core.clearMap("event",e*32,f*32,32,32);var c=a.block.event.height||32;if(c>32){core.clearMap("event2",e*32,f*32+32-c,32,c-32)}}core.removeBlockById(d,b);core.updateStatusBar()};maps.prototype.removeBlockById=function(d,c){c=c||core.status.floorId;if(!c){return}var b=core.status.maps[c].blocks,a=b[d];if(this.canRemoveBlock(a,c)){b.splice(d,1)}else{a.disable=true}};maps.prototype.removeBlockByIds=function(a,b){a=a||core.status.floorId;if(!a){return}b.sort(function(c,d){return d-c}).forEach(function(c){core.removeBlockById(c,a)})};maps.prototype.canRemoveBlock=function(a,b){var c=a.x,d=a.y;if(core.floors[b].events[c+","+d]||core.floors[b].changeFloor[c+","+d]){return false}if(a.event&&a.event.cls.indexOf("enemy")==0&&core.hasSpecial(a.event.id,23)){return false}return true};maps.prototype.showBgFgMap=function(d,c,b,a){this._triggerBgFgMap("show",d,c,b,a)};maps.prototype.hideBgFgMap=function(d,c,b,a){this._triggerBgFgMap("hide",d,c,b,a)};maps.prototype._triggerBgFgMap=function(e,d,c,b,a){if(e!="show"){e="hide"}if(d!="fg"){d="bg"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(!b){return}if(c.length==0){return}c.forEach(function(g){var h=g[0],i=g[1];var f="__"+d+"Map__"+b+"_"+h+"_"+i;if(e=="hide"){core.setFlag(f,true)}else{core.removeFlag(f)}});core.status[d+"maps"][b]=null;if(b==core.status.floorId){core.drawMap(b,a)}else{if(a){a()}}};maps.prototype.showFloorImage=function(c,b,a){this._triggerFloorImage("show",c,b,a)};maps.prototype.hideFloorImage=function(c,b,a){this._triggerFloorImage("hide",c,b,a)};maps.prototype._triggerFloorImage=function(d,c,b,a){if(d!="show"){d="hide"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(!b){return}if(c.length==0){return}c.forEach(function(f){var g=f[0],h=f[1];var e="__floorImg__"+b+"_"+g+"_"+h;if(d=="hide"){core.setFlag(e,true)}else{core.removeFlag(e)}});if(b==core.status.floorId){core.drawMap(b,a)}else{if(a){a()}}};maps.prototype.setBlock=function(d,f,g,b){b=b||core.status.floorId;if(!b||d==null||f==null||g==null){return}if(f<0||f>=core.floors[b].width||g<0||g>=core.floors[b].height){return}if(typeof d=="string"){if(/^\d+$/.test(d)){d=parseInt(d)}else{d=core.getNumberById(d)}}var a=this.initBlock(f,g,d,true,core.floors[b]);if(a.id==0&&!a.event.trigger){core.removeBlock(f,g,b);return}var e=core.getBlock(f,g,b,true);if(b==core.status.floorId){core.removeGlobalAnimate(f,g);core.clearMap("event",f*32,g*32,32,32);if(e!=null){var c=(e.block.event||{}).height||32;if(c>32){core.clearMap("event2",f*32,g*32+32-c,32,c-32)}}}if(e==null){core.status.maps[b].blocks.push(a)}else{e.block.id=d;e.block.event=a.event;a=e.block}if(b==core.status.floorId&&!a.disable){core.drawBlock(a);if(a.event.cls!="autotile"){core.addGlobalAnimate(a)}core.updateStatusBar()}};maps.prototype.replaceBlock=function(b,d,a){a=a||core.status.floorId;if(a instanceof Array){a.forEach(function(e){core.replaceBlock(b,d,e)});return}var c=this.getBlockByNumber(d,true);core.status.maps[a].blocks.forEach(function(e){if(e.id==b){e.id=d;for(var f in c.event){e.event[f]=core.clone(c.event[f])}}})};maps.prototype.setBgFgBlock=function(b,c,e,f,a){a=a||core.status.floorId;if(!a||c==null||e==null||f==null){return}if(e<0||e>=core.floors[a].width||f<0||f>=core.floors[a].height){return}if(b!="bg"&&b!="fg"){return}if(typeof c=="string"){if(/^\d+$/.test(c)){c=parseInt(c)}else{c=core.getNumberById(c)}}var d="__"+b+"Value__"+a+"_"+e+"_"+f;core.setFlag(d,c);core.status[b+"maps"][a]=null;if(a==core.status.floorId){core.clearMap(b);if(b=="bg"){core.drawBg(a)}else{core.drawFg(a)}}};maps.prototype.resetMap=function(a){a=a||core.status.floorId;if(!a){return}if(typeof a=="string"){a=[a]}var b=false;a.forEach(function(c){core.status.maps[c]=core.maps.loadFloor(c);if(c==core.status.floorId){b=true}});if(b){this.drawMap()}core.drawTip("地图重置成功")};maps.prototype._initDetachedBlock=function(a,k,l,i){var j=null,b="__body_"+k+"_"+l,f=null;if(a.height>32){j="__head_"+k+"_"+l;core.createCanvas(j,0,0,32,a.height-32,55)}core.createCanvas(b,0,0,32,32,35);var e=null,g=null;if(a.cls.indexOf("enemy")==0&&core.hasItem("book")&&i){var h=core.enemys.getDamageString(a.id,k,l);e=h.damage;g=h.color}if(e!=null){f="__damage_"+k+"_"+l;var d=core.createCanvas(f,0,0,32,32,65);d.textAlign="left";d.font="bold 11px Arial";core.fillBoldText(d,e,1,31,g);if(core.flags.displayCritical){var c=core.enemys.nextCriticals(a.id);if(c.length>0){c=c[0]}c=core.formatBigNumber(c[0],true);if(c=="???"){c="?"}core.fillBoldText(d,c,1,21,"#FFFFFF")}}return{headCanvas:j,bodyCanvas:b,damageCanvas:f}};maps.prototype._moveDetachedBlock=function(a,h,i,j,c){var f=a.height,k=a.posX,l=a.posY,g=a.image;var e=c.headCanvas,b=c.bodyCanvas,d=c.damageCanvas;if(e){core.dymCanvas[e].clearRect(0,0,32,f);core.dymCanvas[e].drawImage(g,k*32,l*f,32,f-32,0,0,32,f-32);core.relocateCanvas(e,h-core.bigmap.offsetX,i+32-f-core.bigmap.offsetY);core.setOpacity(e,j)}if(b){core.dymCanvas[b].clearRect(0,0,32,32);core.dymCanvas[b].drawImage(g,k*32,l*f+f-32,32,32,0,0,32,32);core.relocateCanvas(b,h-core.bigmap.offsetX,i-core.bigmap.offsetY);core.setOpacity(b,j)}if(d){core.relocateCanvas(d,h-core.bigmap.offsetX,i-core.bigmap.offsetY);core.setOpacity(d,j)}};maps.prototype._deleteDetachedBlock=function(a){core.deleteCanvas(a.headCanvas);core.deleteCanvas(a.bodyCanvas);core.deleteCanvas(a.damageCanvas)};maps.prototype._getAndRemoveBlock=function(c,d){var a=core.getBlock(c,d);if(a==null){return null}a=a.block;var b=this.getBlockInfo(a);if(b==null){return}core.removeBlock(c,d);return[a,b]};maps.prototype.moveBlock=function(k,l,i,j,f,d){j=j||500;var b=this._getAndRemoveBlock(k,l);if(b==null){if(d){d()}return}var a=b[0],c=b[1];var h=(i||[]).filter(function(m){return["up","down","left","right","forward","backward"].indexOf(m)>=0});var e=this._initDetachedBlock(c,k,l,a.event.animate!==false);this._moveDetachedBlock(c,32*k,32*l,1,e);var g={x:k,y:l,px:32*k,py:32*l,opacity:1,keep:f,lastDirection:null,offset:1,moveSteps:h,step:0,per_time:j/16/core.status.replay.speed};this._moveBlock_doMove(c,e,g,d)};maps.prototype._moveBlock_doMove=function(d,f,g,e){var c=core.icons._getAnimateFrames(d.cls,true),b=0;var a=window.setInterval(function(){if(d.cls!="tileset"){b+=g.per_time;if(b>core.values.animateSpeed){b=0;d.posX=(d.posX+1)%c}}if(g.moveSteps.length!=0){core.maps._moveBlock_moving(d,f,g)}else{core.maps._moveJumpBlock_finished(d,f,g,a,e)}},g.per_time);core.animateFrame.asyncId[a]=true};maps.prototype._moveBlock_updateDirection=function(a,f){f.offset=1;var e=f.moveSteps[0];if(f.lastDirection==null){for(var c in a.faceIds){if(a.faceIds[c]==a.id){f.lastDirection=c;break}}}if(e=="forward"||e=="backward"){if(f.lastDirection==null){f.moveSteps.shift();return false}if(e=="backward"){f.offset=-1}e=f.lastDirection}f.lastDirection=f.moveSteps[0]=e;f.x+=core.utils.scan[e].x*f.offset;f.y+=core.utils.scan[e].y*f.offset;var b=a.faceIds[e];if(b){var g=core.material.icons[a.cls][b];if(g!=null){a.posY=g}}return true};maps.prototype._moveBlock_moving=function(a,b,d){if(d.step==0){if(!this._moveBlock_updateDirection(a,d)){return}}var c=d.moveSteps[0];d.step++;d.px+=core.utils.scan[c].x*2*d.offset;d.py+=core.utils.scan[c].y*2*d.offset;this._moveDetachedBlock(a,d.px,d.py,d.opacity,b);if(d.step==16){d.step=0;d.moveSteps.shift()}};maps.prototype.jumpBlock=function(j,k,f,g,l,i,d){l=l||500;var b=this._getAndRemoveBlock(j,k);if(b==null){if(d){d()}return}var a=b[0],c=b[1];var e=this._initDetachedBlock(c,j,k,a.event.animate!==false);this._moveDetachedBlock(c,32*j,32*k,1,e);core.playSound("jump.mp3");var h=this.__generateJumpInfo(j,k,f,g,l);h.keep=i;this._jumpBlock_doJump(c,e,h,d)};maps.prototype.__generateJumpInfo=function(h,i,d,e,j){var b=d-h,c=e-i,a=Math.round(Math.sqrt(b*b+c*c));var g=6+a,f=g*2;j/=Math.max(core.status.replay.speed,1);return{x:h,y:i,ex:d,ey:e,px:32*h,py:32*i,opacity:1,jump_peak:g,jump_count:f,step:0,per_time:j/f}};maps.prototype._jumpBlock_doJump=function(b,d,e,c){var a=window.setInterval(function(){if(e.jump_count>0){core.maps._jumpBlock_jumping(b,d,e)}else{core.maps._moveJumpBlock_finished(b,d,e,a,c)}},e.per_time);core.animateFrame.asyncId[a]=true};maps.prototype.__updateJumpInfo=function(b){b.jump_count--;b.x=(b.x*b.jump_count+b.ex)/(b.jump_count+1);b.y=(b.y*b.jump_count+b.ey)/(b.jump_count+1);b.px=32*b.x;var a=Math.abs(b.jump_count-b.jump_peak);b.py=32*b.y-(b.jump_peak*b.jump_peak-a*a)/2};maps.prototype._jumpBlock_jumping=function(a,b,c){this.__updateJumpInfo(c);core.maps._moveDetachedBlock(a,c.px,c.py,c.opacity,b)};maps.prototype._moveJumpBlock_finished=function(b,d,e,a,c){if(e.keep){e.opacity=0}else{e.opacity-=0.06}if(e.opacity<=0){delete core.animateFrame.asyncId[a];clearInterval(a);this._deleteDetachedBlock(d);if(e.keep){core.setBlock(b.number,e.x,e.y);core.showBlock(e.x,e.y)}if(c){c()}}else{this._moveDetachedBlock(b,e.px,e.py,e.opacity,d)}};maps.prototype.animateBlock=function(d,f,e,a){var b=f=="hide";if(typeof d[0]=="number"&&typeof d[1]=="number"){d=[d]}var c=this._animateBlock_getList(d);if(c.length==0){if(a){a()}return}this._animateBlock_drawList(c,b?1:0);e/=Math.max(core.status.replay.speed,1);this._animateBlock_doAnimate(d,c,b,10/e,a)};maps.prototype._animateBlock_doAnimate=function(f,e,d,c,b){var g=d?1:0;var a=setInterval(function(){g+=d?-c:c;core.maps._animateBlock_drawList(e,g);if(g>=1||g<=0){delete core.animateFrame.asyncId[a];clearInterval(a);e.forEach(function(h){if(h.blockInfo){core.maps._deleteDetachedBlock(h.canvases)}});f.forEach(function(h){if(d){core.removeBlock(h[0],h[1])}else{core.showBlock(h[0],h[1])}});if(b){b()}}},10);core.animateFrame.asyncId[a]=true};maps.prototype._animateBlock_getList=function(b){var a=[];b.forEach(function(f){var c=core.getBlock(f[0],f[1],null,true);if(c==null){return}c=c.block;var d=core.maps.getBlockInfo(c);if(d==null){a.push({x:f[0],y:f[1]});return}var e=core.maps._initDetachedBlock(d,f[0],f[1],c.event.displayDamage!==false);a.push({x:f[0],y:f[1],blockInfo:d,canvases:e})});return a};maps.prototype._animateBlock_drawList=function(a,b){a.forEach(function(c){if(c.blockInfo){core.maps._moveDetachedBlock(c.blockInfo,c.x*32,c.y*32,b,c.canvases)}})};maps.prototype.addGlobalAnimate=function(a){if(!a.event||a.event.animate==null){return}if(a.event.cls=="autotile"){var b=a.event.id,c=core.material.images.autotile[b];if(!c||c.width==96){return}core.status.autotileAnimateObjs.blocks.push(a)}else{if(!a.event.animate||a.event.animate==1){return}core.status.globalAnimateObjs.push(a)}};maps.prototype.removeGlobalAnimate=function(b,c,a){if(b==null||c==null){core.status.globalAnimateStatus=0;core.status.globalAnimateObjs=[];core.status.autotileAnimateObjs={blocks:[],map:null,bgmap:null,fgmap:null};core.status.floorAnimateObjs=[];return}core.status.globalAnimateObjs=core.status.globalAnimateObjs.filter(function(d){return d.x!=b||d.y!=c||d.name!=a});if(core.status.autotileAnimateObjs.blocks){core.status.autotileAnimateObjs.blocks=core.status.autotileAnimateObjs.blocks.filter(function(d){return d.x!=b||d.y!=c||d.name!=a});core.status.autotileAnimateObjs.map[c][b]=0}};maps.prototype.drawBoxAnimate=function(){core.status.boxAnimateObjs.forEach(function(a){core.clearMap("ui",a.bgx,a.bgy,a.bgWidth,a.bgHeight);core.fillRect("ui",a.bgx,a.bgy,a.bgWidth,a.bgHeight,core.material.groundPattern);core.drawImage("ui",a.image,core.status.globalAnimateStatus%a.animate*32,a.pos,32,a.height,a.x,a.y,32,a.height)})};maps.prototype.drawAnimate=function(f,g,h,b){f=core.getMappedName(f);if(core.isReplaying()||!core.material.animates[f]||g==null||h==null){if(b){b()}return -1}var a=core.material.animates[f],c=32*g+16,d=32*h+16;core.playSound(a.se);var e=setTimeout(null);core.status.animateObjs.push({id:e,animate:a,centerX:c,centerY:d,index:0,callback:b});return e};maps.prototype.drawHeroAnimate=function(d,b){d=core.getMappedName(d);if(core.isReplaying()||!core.material.animates[d]){if(b){b()}return -1}var a=core.material.animates[d];core.playSound(a.se);var c=setTimeout(null);core.status.animateObjs.push({id:c,animate:a,hero:true,index:0,callback:b});return c};maps.prototype._drawAnimateFrame=function(a,b,c,e){var d=a.frames[e];var f=a.ratio;d.forEach(function(l){var i=a.images[l.index];if(!i){return}var k=i.width*f*l.zoom/100;var j=i.height*f*l.zoom/100;core.setAlpha("animate",l.opacity/255);var g=b+l.x,h=c+l.y;if(!l.mirror&&!l.angle){core.drawImage("animate",i,g-k/2-core.bigmap.offsetX,h-j/2-core.bigmap.offsetY,k,j)}else{core.saveCanvas("animate");core.canvas.animate.translate(g,h);if(l.angle){core.canvas.animate.rotate(-l.angle*Math.PI/180)}if(l.mirror){core.canvas.animate.scale(-1,1)}core.drawImage("animate",i,-k/2-core.bigmap.offsetX,-j/2-core.bigmap.offsetY,k,j);core.loadCanvas("animate")}core.setAlpha("animate",1)})};maps.prototype.stopAnimate=function(c,a){for(var b=0;b<core.status.animateObjs.length;b++){var d=core.status.animateObjs[b];if(d.id==c){if(a){(function(e){setTimeout(function(){if(e){e()}})})(d.callback)}}}core.status.animateObjs=core.status.animateObjs.filter(function(e){return e.id!=c});if(core.status.animateObjs.length==0){core.clearMap("animate")}};