"use strict";function actions(){this._init();this.SIZE=core.__SIZE__;this.HSIZE=core.__HALF_SIZE__;this.LAST=this.SIZE-1;this.CHOICES_LEFT=5;this.CHOICES_RIGHT=this.LAST-this.CHOICES_LEFT}actions.prototype._init=function(){this.actionsdata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.actions;this.actions={};this.registerAction("onkeyDown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onkeyDown","_sys_onkeyDown",this._sys_onkeyDown,0);this.registerAction("onkeyUp","_sys_onkeyUp_replay",this._sys_onkeyUp_replay,100);this.registerAction("onkeyUp","_sys_onkeyUp",this._sys_onkeyUp,0);this.registerAction("pressKey","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("pressKey","_sys_pressKey",this._sys_pressKey,0);this.registerAction("keyDown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("keyDown","_sys_keyDown_lockControl",this._sys_keyDown_lockControl,50);this.registerAction("keyDown","_sys_keyDown",this._sys_keyDown,0);this.registerAction("keyUp","_sys_keyUp_replay",this._sys_keyUp_replay,100);this.registerAction("keyUp","_sys_keyUp_lockControl",this._sys_keyUp_lockControl,50);this.registerAction("keyUp","_sys_keyUp",this._sys_keyUp,0);this.registerAction("ondown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("ondown","_sys_ondown_paint",this._sys_ondown_paint,60);this.registerAction("ondown","_sys_ondown_lockControl",this._sys_ondown_lockControl,30);this.registerAction("ondown","_sys_ondown",this._sys_ondown,0);this.registerAction("onmove","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onmove","_sys_onmove_paint",this._sys_onmove_paint,50);this.registerAction("onmove","_sys_onmove_choices",this._sys_onmove_choices,30);this.registerAction("onmove","_sys_onmove",this._sys_onmove,0);this.registerAction("onup","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onup","_sys_onup_paint",this._sys_onup_paint,50);this.registerAction("onup","_sys_onup",this._sys_onup,0);this.registerAction("onclick","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onclick","_sys_onclick_lockControl",this._sys_onclick_lockControl,50);this.registerAction("onclick","_sys_onclick",this._sys_onclick,0);this.registerAction("onmousewheel","_sys_onmousewheel",this._sys_onmousewheel,0);this.registerAction("keyDownCtrl","_sys_keyDownCtrl",this._sys_keyDownCtrl,0);this.registerAction("longClick","_sys_longClick_lockControl",this._sys_longClick_lockControl,50);this.registerAction("longClick","_sys_longClick",this._sys_longClick,0)};actions.prototype.registerAction=function(a,c,b,d){if(!c||!b){return}d=d||0;if(!this.actions[a]){this.actions[a]=[]}this.unregisterAction(a,c);this.actions[a].push({action:a,name:c,func:b,priority:d});this.actions[a]=this.actions[a].sort(function(e,f){return f.priority-e.priority})};actions.prototype.unregisterAction=function(a,b){if(!this.actions[a]){return}this.actions[a]=this.actions[a].filter(function(c){return c.name!=b})};actions.prototype.doRegisteredAction=function(a){var b=this.actions[a];if(!b){return false}for(var d=0;d<b.length;++d){try{if(core.doFunc.apply(core,[b[d].func,this].concat(Array.prototype.slice.call(arguments,1)))){return true}}catch(c){main.log(c);main.log("ERROR in actions["+b[d].name+"].")}}return false};actions.prototype._checkReplaying=function(){if(core.isReplaying()&&["save","book","book-detail","viewMaps","toolbox","equipbox","text"].indexOf(core.status.event.id)<0){return true}return false};actions.prototype._sys_checkReplay=function(){if(this._checkReplaying()){return true}};actions.prototype.onkeyDown=function(a){this.doRegisteredAction("onkeyDown",a)};actions.prototype._sys_onkeyDown=function(a){core.status.holdingKeys=core.status.holdingKeys||[];var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){return}}if(a.preventDefault){a.preventDefault()}core.status.holdingKeys.push(a.keyCode);this.pressKey(a.keyCode)}else{if(a.keyCode==17){core.status.ctrlDown=true}this.keyDown(a.keyCode)}};actions.prototype.onkeyUp=function(a){this.doRegisteredAction("onkeyUp",a)};actions.prototype._sys_onkeyUp_replay=function(a){if(this._checkReplaying()){if(a.keyCode==27){core.stopReplay()}else{if(a.keyCode==90){core.speedDownReplay()}else{if(a.keyCode==88){core.speedUpReplay()}else{if(a.keyCode==32){core.triggerReplay()}else{if(a.keyCode==65){core.rewindReplay()}else{if(a.keyCode==83){core.saveReplay()}else{if(a.keyCode==67){core.bookReplay()}else{if(a.keyCode==33||a.keyCode==34){core.viewMapReplay()}else{if(a.keyCode==78){core.stepReplay()}else{if(a.keyCode==84){core.toolboxReplay()}else{if(a.keyCode==81){core.equipboxReplay()}else{if(a.keyCode==66){core.drawStatistics()}else{if(a.keyCode>=49&&a.keyCode<=51){core.setReplaySpeed(a.keyCode-48)}else{if(a.keyCode==52){core.setReplaySpeed(6)}else{if(a.keyCode==53){core.setReplaySpeed(12)}else{if(a.keyCode==54){core.setReplaySpeed(24)}}}}}}}}}}}}}}}}return true}};actions.prototype._sys_onkeyUp=function(a){var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){core.status.holdingKeys=core.status.holdingKeys.slice(0,b).concat(core.status.holdingKeys.slice(b+1));if(b===core.status.holdingKeys.length&&core.status.holdingKeys.length!==0){core.pressKey(core.status.holdingKeys.slice(-1)[0])}break}}if(a.preventDefault){a.preventDefault()}this.keyUp(a.keyCode,a.altKey)}else{if(a.keyCode==17){core.status.ctrlDown=false}this.keyUp(a.keyCode,a.altKey)}};actions.prototype.pressKey=function(a){this.doRegisteredAction("pressKey",a)};actions.prototype._sys_pressKey=function(a){if(a===core.status.holdingKeys.slice(-1)[0]){this.keyDown(a);window.setTimeout(function(){core.pressKey(a)},30)}};actions.prototype.keyDown=function(a){this.doRegisteredAction("keyDown",a)};actions.prototype._sys_keyDown_lockControl=function(a){if(!core.status.lockControl){return false}if(a==17){this.keyDownCtrl();return true}switch(core.status.event.id){case"action":this._keyDownAction(a);break;case"book":this._keyDownBook(a);break;case"fly":this._keyDownFly(a);break;case"viewMaps":this._keyDownViewMaps(a);break;case"equipbox":this._keyDownEquipbox(a);break;case"toolbox":this._keyDownToolbox(a);break;case"save":case"load":case"replayLoad":case"replayRemain":this._keyDownSL(a);break;case"shop":this._keyDownShop(a);break;case"selectShop":case"switchs":case"settings":case"syncSave":case"syncSelect":case"localSaveSelect":case"storageRemove":case"replay":case"gameInfo":this._keyDownChoices(a);break;case"cursor":this._keyDownCursor(a);break}return true};actions.prototype._sys_keyDown=function(a){if(!core.status.played){return true}switch(a){case 37:core.moveHero("left");break;case 38:core.moveHero("up");break;case 39:core.moveHero("right");break;case 40:core.moveHero("down");break}return true};actions.prototype.keyUp=function(c,a,b){this.doRegisteredAction("keyUp",c,a,b)};actions.prototype._sys_keyUp_replay=function(c,a,b){if(!b&&this._checkReplaying()){return true}};actions.prototype._sys_keyUp_lockControl=function(b,a){if(!core.status.lockControl){return false}var c=function(){return b==27||b==88||b==13||b==32||b==67};core.status.holdingKeys=[];switch(core.status.event.id){case"text":c()&&core.drawText();break;case"confirmBox":this._keyUpConfirmBox(b);break;case"action":this._keyUpAction(b);break;case"about":c()&&core.closePanel();break;case"help":c()&&core.closePanel();break;case"book":this._keyUpBook(b);break;case"book-detail":c()&&this._clickBookDetail();break;case"fly":this._keyUpFly(b);break;case"viewMaps":this._keyUpViewMaps(b);break;case"shop":this._keyUpShop(b);break;case"selectShop":this._keyUpQuickShop(b);break;case"toolbox":this._keyUpToolbox(b);break;case"equipbox":this._keyUpEquipbox(b,a);break;case"save":case"load":case"replayLoad":case"replayRemain":this._keyUpSL(b);break;case"keyBoard":c()&&core.closePanel();break;case"switchs":this._keyUpSwitchs(b);break;case"settings":this._keyUpSettings(b);break;case"syncSave":this._keyUpSyncSave(b);break;case"syncSelect":this._keyUpSyncSelect(b);break;case"localSaveSelect":this._keyUpLocalSaveSelect(b);break;case"storageRemove":this._keyUpStorageRemove(b);break;case"cursor":this._keyUpCursor(b);break;case"replay":this._keyUpReplay(b);break;case"gameInfo":this._keyUpGameInfo(b);break;case"centerFly":this._keyUpCenterFly(b);break;case"paint":this._keyUpPaint(b);break}return true};actions.prototype._sys_keyUp=function(b,a){if(!core.status.played){return true}this.actionsdata.onKeyUp(b,a);if(core.status.automaticRoute&&core.status.automaticRoute.autoHeroMove){core.stopAutomaticRoute()}core.status.heroStop=true;return true};actions.prototype.ondown=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("ondown",d,e,b,c)};actions.prototype._sys_ondown_paint=function(c,d,a,b){if(core.status.played&&(core.status.event||{}).id=="paint"){this._ondownPaint(a,b);return true}};actions.prototype._sys_ondown_lockControl=function(c,d,a,b){if(core.status.played&&!core.status.lockControl){return false}if(core.status.event.id=="action"&&core.status.event.data.type=="wait"){core.setFlag("type",1);core.setFlag("x",c);core.setFlag("y",d);core.setFlag("px",a);core.setFlag("py",b);core.status.route.push("input:"+(1000000+1000*a+b));core.events.__action_wait_afterGet(core.status.event.data.current);core.doAction()}else{core.actions.onclick(c,d,[])}if(core.timeout.onDownTimeout==null){core.timeout.onDownTimeout=setTimeout(function(){if(core.interval.onDownInterval==null){core.interval.onDownInterval=setInterval(function(){if(!core.actions.longClick(c,d,true)){clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null}},40)}},500)}return true};actions.prototype._sys_ondown=function(d,e,b,c){core.status.downTime=new Date();core.deleteCanvas("route");var a={x:d,y:e};core.status.stepPostfix=[];core.status.stepPostfix.push(a);core.fillPosWithPoint(a)};actions.prototype.onmove=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("onmove",d,e,b,c)};actions.prototype._sys_onmove_paint=function(c,d,a,b){if(core.status.played&&(core.status.event||{}).id=="paint"){core.actions._onmovePaint(a,b);return true}};actions.prototype._sys_onmove_choices=function(a,b){if(!core.status.lockControl){return false}switch(core.status.event.id){case"action":if(core.status.event.data.type!="choices"){break}case"shop":case"selectShop":case"switchs":case"settings":case"syncSave":case"syncSelect":case"localSaveSelect":case"storageRemove":case"replay":case"gameInfo":this._onMoveChoices(a,b);return true;default:break}return false};actions.prototype._sys_onmove=function(g,h){if((core.status.stepPostfix||[]).length>0){var e={x:g,y:h};var f=core.status.stepPostfix[core.status.stepPostfix.length-1];var a=[e.y-f.y,f.x-e.x,f.y-e.y,e.x-f.x];var d=0,c=4;for(var b=0;b<4;b++){if(a[b]>d){c=b;d=a[b]}}e=[{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:0},false][c];if(e){e.x+=f.x;e.y+=f.y;core.status.stepPostfix.push(e);core.fillPosWithPoint(e)}}return true};actions.prototype.onup=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("onup",d,e,b,c)};actions.prototype._sys_onup_paint=function(){if(core.status.played&&(core.status.event||{}).id=="paint"){this._onupPaint();return true}};actions.prototype._sys_onup=function(){clearTimeout(core.timeout.onDownTimeout);core.timeout.onDownTimeout=null;clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null;if((core.status.stepPostfix||[]).length==0){return false}var g=[];var a={"0":{"1":"down","-1":"up"},"-1":{"0":"left"},"1":{"0":"right"}};for(var b=1;b<core.status.stepPostfix.length;b++){var d=core.status.stepPostfix[b-1];var c=core.status.stepPostfix[b];g.push({direction:a[c.x-d.x][c.y-d.y],x:c.x+parseInt(core.bigmap.offsetX/32),y:c.y+parseInt(core.bigmap.offsetY/32)})}var e=core.status.stepPostfix[0].x;var f=core.status.stepPostfix[0].y;core.status.stepPostfix=[];if(!core.status.lockControl){core.clearMap("ui")}if(!core.status.lockControl&&g.length==0&&core.status.downTime!=null&&new Date()-core.status.downTime>=1000){core.actions.longClick(e,f)}else{core.actions.onclick(e,f,g)}core.status.downTime=null;return true};actions.prototype._getClickLoc=function(f,g){var d={x:0,y:0};var c=32;c=c*core.domStyle.scale;if(core.domStyle.isVertical){d.x=0;d.y=core.dom.statusBar.offsetHeight+3}else{d.x=core.dom.statusBar.offsetWidth+3;d.y=0}var a=core.dom.gameGroup.offsetLeft+d.x;var e=core.dom.gameGroup.offsetTop+d.y;var b={x:f-a,y:g-e,size:c};return b};actions.prototype.onclick=function(b,c,a){this.doRegisteredAction("onclick",b,c,a||[])};actions.prototype._sys_onclick_lockControl=function(a,b){if(!core.status.lockControl){return false}switch(core.status.event.id){case"centerFly":this._clickCenterFly(a,b);break;case"book":this._clickBook(a,b);break;case"book-detail":this._clickBookDetail(a,b);break;case"fly":this._clickFly(a,b);break;case"viewMaps":this._clickViewMaps(a,b);break;case"switchs":this._clickSwitchs(a,b);break;case"settings":this._clickSettings(a,b);break;case"shop":this._clickShop(a,b);break;case"selectShop":this._clickQuickShop(a,b);break;case"equipbox":this._clickEquipbox(a,b);break;case"toolbox":this._clickToolbox(a,b);break;case"save":case"load":case"replayLoad":case"replayRemain":this._clickSL(a,b);break;case"confirmBox":this._clickConfirmBox(a,b);break;case"keyBoard":this._clickKeyBoard(a,b);break;case"action":this._clickAction(a,b);break;case"text":core.drawText();break;case"syncSave":this._clickSyncSave(a,b);break;case"syncSelect":this._clickSyncSelect(a,b);break;case"localSaveSelect":this._clickLocalSaveSelect(a,b);break;case"storageRemove":this._clickStorageRemove(a,b);break;case"cursor":this._clickCursor(a,b);break;case"replay":this._clickReplay(a,b);break;case"gameInfo":this._clickGameInfo(a,b);break;case"about":case"help":core.ui.closePanel();break}return true};actions.prototype._sys_onclick=function(b,c,a){core.setAutomaticRoute(b+parseInt(core.bigmap.offsetX/32),c+parseInt(core.bigmap.offsetY/32),a);return true};actions.prototype.onmousewheel=function(a){this.doRegisteredAction("onmousewheel",a)};actions.prototype._sys_onmousewheel=function(a){if(this._checkReplaying()){if(a==1){core.speedUpReplay()}if(a==-1){core.speedDownReplay()}return}if(core.status.lockControl&&core.status.event.id=="fly"){if(a==1){core.ui.drawFly(this._getNextFlyFloor(1))}if(a==-1){core.ui.drawFly(this._getNextFlyFloor(-1))}return}if(core.status.lockControl&&core.status.event.id=="book"){if(a==1){core.ui.drawBook(core.status.event.data-this.HSIZE)}if(a==-1){core.ui.drawBook(core.status.event.data+this.HSIZE)}return}if(core.status.lockControl&&(core.status.event.id=="save"||core.status.event.id=="load")){var b=core.status.event.data.page*10+core.status.event.data.offset;if(a==1){core.ui.drawSLPanel(b-10)}if(a==-1){core.ui.drawSLPanel(b+10)}return}if(core.status.lockControl&&core.status.event.id=="viewMaps"){if(a==1){this._clickViewMaps(this.HSIZE,this.HSIZE-3)}if(a==-1){this._clickViewMaps(this.HSIZE,this.HSIZE+3)}return}if(core.status.lockControl&&core.status.event.id=="action"&&core.status.event.data.type=="wait"){core.setFlag("type",0);var c=a==1?33:34;core.setFlag("keycode",c);core.status.route.push("input:"+c);core.events.__action_wait_afterGet(core.status.event.data.current);core.doAction();return}};actions.prototype.keyDownCtrl=function(){this.doRegisteredAction("keyDownCtrl")};actions.prototype._sys_keyDownCtrl=function(){if(core.status.event.id=="text"){core.drawText();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="sleep"&&!core.status.event.data.current.noSkip){if(core.timeout.sleepTimeout&&!core.hasAsync()){clearTimeout(core.timeout.sleepTimeout);core.timeout.sleepTimeout=null;core.doAction()}return true}};actions.prototype.longClick=function(b,c,a){if(!core.isPlaying()){return false}return this.doRegisteredAction("longClick",b,c,a)};actions.prototype._sys_longClick_lockControl=function(a,b){if(!core.status.lockControl){return false}if(core.status.event.id=="text"){core.drawText();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return true}if(core.status.event.id=="fly"){if((a==this.SIZE-2||a==this.SIZE-3)&&(b==this.HSIZE-1||b==this.HSIZE+3)){this._clickFly(a,b);return true}}if(["save","load","replayLoad","replayRemain"].indexOf(core.status.event.id)>=0){if([this.HSIZE-2,this.HSIZE-3,this.HSIZE+2,this.HSIZE+3].indexOf(a)>=0&&b==this.LAST){this._clickSL(a,b);return true}}if(core.status.event.id=="shop"&&a>=this.CHOICES_LEFT&&a<=this.CHOICES_RIGHT){return this._clickShop(a,b)}if(core.status.event.id=="action"&&core.status.event.data.type=="sleep"&&!core.status.event.data.current.noSkip){if(core.timeout.sleepTimeout&&!core.hasAsync()){clearTimeout(core.timeout.sleepTimeout);core.timeout.sleepTimeout=null;core.doAction();return true}}return false};actions.prototype._sys_longClick=function(b,c,a){if(!core.status.lockControl&&!a){core.waitHeroToStop(function(){core.ui.drawKeyBoard()});return true}return false};actions.prototype._selectChoices=function(d,c,a){var e=this.HSIZE-parseInt((d-1)/2)+(core.status.event.ui.offset||0);if(c==13||c==32||c==67){a.apply(this,[this.HSIZE,e+core.status.event.selection])}if(core.status.event.id=="switchs"&&(core.status.event.selection==2||core.status.event.selection==3)){if(c==37){a.apply(this,[this.HSIZE-2,e+core.status.event.selection])}if(c==39){a.apply(this,[this.HSIZE+2,e+core.status.event.selection])}}if(c>=49&&c<=57){var b=c-49;if(b<d){a.apply(this,[this.HSIZE,e+b])}}};actions.prototype._keyDownChoices=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype._onMoveChoices=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;if(b==core.status.event.selection){return}core.status.event.selection=b;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype._clickCenterFly=function(c,d){var a=core.status.event.data.posX,b=core.status.event.data.posY;core.ui.closePanel();if(c==a&&d==b){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.drawTip("当前不能使用中心对称飞行器")}}else{core.drawTip("取消使用")}};actions.prototype._keyUpCenterFly=function(a){core.ui.closePanel();if(a==51||a==13||a==32||a==67){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.drawTip("当前不能使用中心对称飞行器")}}};actions.prototype._clickConfirmBox=function(a,b){if((a==this.HSIZE-2||a==this.HSIZE-1)&&b==this.HSIZE+1&&core.status.event.data.yes){core.status.event.data.yes()}if((a==this.HSIZE+2||a==this.HSIZE+1)&&b==this.HSIZE+1&&core.status.event.data.no){core.status.event.data.no()}};actions.prototype._keyUpConfirmBox=function(a){if(a==37){core.status.event.selection=0;core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no);return}if(a==39){core.status.event.selection=1;core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no);return}if(a==13||a==32||a==67){if(core.status.event.selection==0&&core.status.event.data.yes){core.status.event.selection=null;core.status.event.data.yes();return}if(core.status.event.selection==1&&core.status.event.data.no){core.status.event.selection=null;core.status.event.data.no();return}}};actions.prototype._clickAction=function(d,e){if(core.status.event.data.type=="text"){if(core.status.event.interval!=null){core.insertAction({type:"text",text:core.status.event.ui,showAll:true})}core.doAction();return}if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length==0){return}if(d>=this.CHOICES_LEFT&&d<=this.CHOICES_RIGHT){var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){core.status.route.push("choices:"+(e-c));core.insertAction(a[e-c].action);core.doAction()}}return}if(core.status.event.data.type=="confirm"){if((d==this.HSIZE-2||d==this.HSIZE-1)&&e==this.HSIZE+1){core.status.route.push("choices:0");core.insertAction(core.status.event.ui.yes);core.doAction()}else{if((d==this.HSIZE+2||d==this.HSIZE+1)&&e==this.HSIZE+1){core.status.route.push("choices:1");core.insertAction(core.status.event.ui.no);core.doAction()}}return}};actions.prototype._keyDownAction=function(a){if(core.status.event.data.type=="choices"){this._keyDownChoices(a);return}if(core.status.event.data.type=="confirm"&&(a==37||a==39)){core.status.event.selection=1-core.status.event.selection;core.drawConfirmBox(core.status.event.ui.text);return}};actions.prototype._keyUpAction=function(c){if(core.status.event.data.type=="text"&&(c==13||c==32||c==67)){if(core.status.event.interval!=null){core.insertAction({type:"text",text:core.status.event.ui,showAll:true})}core.doAction();return}if(core.status.event.data.type=="wait"){core.setFlag("type",0);core.setFlag("keycode",c);core.status.route.push("input:"+c);core.events.__action_wait_afterGet(core.status.event.data.current);core.doAction();return}if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length>0){this._selectChoices(a.length,c,this._clickAction)}return}if(core.status.event.data.type=="confirm"&&(c==13||c==32||c==67)){core.status.route.push("choices:"+core.status.event.selection);if(core.status.event.selection==0){core.insertAction(core.status.event.ui.yes)}else{core.insertAction(core.status.event.ui.no)}core.doAction();return}};actions.prototype._clickBook=function(h,j){if((h==this.HSIZE-2||h==this.HSIZE-3)&&j==this.LAST){core.ui.drawBook(core.status.event.data-this.HSIZE);return}if((h==this.HSIZE+2||h==this.HSIZE+3)&&j==this.LAST){core.ui.drawBook(core.status.event.data+this.HSIZE);return}if(h>=this.LAST-2&&j==this.LAST){if(core.events.recoverEvents(core.status.event.interval)){return}else{if(core.status.event.ui!=null){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.ui)}else{core.ui.closePanel()}}return}var a=core.status.event.data;if(a!=null&&j<this.LAST){var e=core.ui._drawBook_pageinfo();var f=e.per_page,d=parseInt(a/f);var g=this.LAST/f;for(var b=0;b<f;++b){if(j>=g*b&&j<g*(b+1)){var c=f*d+b;core.ui.drawBook(c);core.ui.drawBookDetail(c);break}}return}return};actions.prototype._keyDownBook=function(a){if(a==37){core.ui.drawBook(core.status.event.data-this.HSIZE)}if(a==38){core.ui.drawBook(core.status.event.data-1)}if(a==39){core.ui.drawBook(core.status.event.data+this.HSIZE)}if(a==40){core.ui.drawBook(core.status.event.data+1)}if(a==33){core.ui.drawBook(core.status.event.data-this.HSIZE)}if(a==34){core.ui.drawBook(core.status.event.data+this.HSIZE)}return};actions.prototype._keyUpBook=function(b){if(b==27||b==88){if(core.events.recoverEvents(core.status.event.interval)){return}else{if(core.status.event.ui!=null){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.ui)}else{core.ui.closePanel()}}return}if(b==13||b==32||b==67){var a=core.status.event.data;if(a!=null){core.ui.drawBookDetail(a)}return}};actions.prototype._clickBookDetail=function(){core.clearMap("data");core.status.event.id="book"};actions.prototype._clickFly=function(a,b){if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE+3){core.ui.drawFly(this._getNextFlyFloor(-1))}if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE-1){core.ui.drawFly(this._getNextFlyFloor(1))}if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE+4){core.ui.drawFly(this._getNextFlyFloor(-10))}if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE-2){core.ui.drawFly(this._getNextFlyFloor(10))}if(a>=this.HSIZE-1&&a<=this.HSIZE+1&&b==this.LAST){core.ui.closePanel()}if(a>=0&&a<=this.HSIZE+3&&b>=3&&b<=this.LAST-1){core.flyTo(core.floorIds[core.status.event.data])}return};actions.prototype._keyDownFly=function(a){if(a==37){core.ui.drawFly(this._getNextFlyFloor(-10))}else{if(a==38){core.ui.drawFly(this._getNextFlyFloor(1))}else{if(a==39){core.ui.drawFly(this._getNextFlyFloor(10))}else{if(a==40){core.ui.drawFly(this._getNextFlyFloor(-1))}}}}return};actions.prototype._getNextFlyFloor=function(b,d){if(d==null){d=core.status.event.data}if(b==0){return d}var e=Math.sign(b);b=Math.abs(b);var a=d;while(true){d+=e;if(d<0||d>=core.floorIds.length){break}var c=core.floorIds[d];if(core.status.maps[c].canFlyTo&&core.hasVisitedFloor(c)){b--;a=d}if(b==0){break}}return a};actions.prototype._keyUpFly=function(a){if(a==71||a==27||a==88){core.ui.closePanel()}if(a==13||a==32||a==67){this._clickFly(this.HSIZE-1,this.HSIZE-1)}return};actions.prototype._clickViewMaps=function(i,j){if(core.status.event.data==null){core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId));return}var g=core.floorIds.indexOf(core.status.floorId);var d=core.status.event.data.index;var a=core.status.event.data.x,b=core.status.event.data.y;var c=core.floorIds[d],f=core.floors[c].width,e=core.floors[c].height;var h=this.HSIZE-4;if(i<=h-2&&j<=h-2){core.status.event.data.damage=!core.status.event.data.damage;core.ui.drawMaps(d,a,b);return}if(i<=h-2&&j>=this.SIZE+1-h){core.status.event.data.paint=!core.status.event.data.paint;core.ui.drawMaps(d,a,b);return}if(i>=this.SIZE+1-h&&j<=h-2){core.status.event.data.all=!core.status.event.data.all;core.ui.drawMaps(d,a,b);return}if(i>=h&&i<=this.LAST-h&&j<=h-1&&e>this.SIZE){core.ui.drawMaps(d,a,b-1);return}if(i>=h&&i<=this.LAST-h&&j>=this.SIZE-h&&e>this.SIZE){core.ui.drawMaps(d,a,b+1);return}if(i<=h-1&&j>=h&&j<=this.LAST-h){core.ui.drawMaps(d,a-1,b);return}if(i>=this.SIZE-h&&j>=h&&j<=this.LAST-h){core.ui.drawMaps(d,a+1,b);return}if(j<=this.HSIZE-2&&(e==this.SIZE||(i>=h&&i<=this.LAST-h))){d++;while(d<core.floorIds.length&&d!=g&&core.status.maps[core.floorIds[d]].cannotViewMap){d++}if(d<core.floorIds.length){core.ui.drawMaps(d)}return}if(j>=this.HSIZE+2&&(e==this.SIZE||(i>=h&&i<=this.LAST-h))){d--;while(d>=0&&d!=g&&core.status.maps[core.floorIds[d]].cannotViewMap){d--}if(d>=0){core.ui.drawMaps(d)}return}if(i>=h&&i<=this.LAST-h&&j>=this.HSIZE-1&&j<=this.HSIZE+1){core.clearMap("data");core.ui.closePanel();return}};actions.prototype._keyDownViewMaps=function(b){if(core.status.event.data==null){return}var a=core.floorIds[core.status.event.data.index],c=core.floors[a].height;if(b==38||b==33){this._clickViewMaps(this.HSIZE,this.HSIZE-3)}if(b==40||b==34){this._clickViewMaps(this.HSIZE,this.HSIZE+3)}if(b==87&&c>this.SIZE){this._clickViewMaps(this.HSIZE,0)}if(b==65){this._clickViewMaps(0,this.HSIZE)}if(b==83&&c>this.SIZE){this._clickViewMaps(this.HSIZE,this.LAST)}if(b==68){this._clickViewMaps(this.LAST,this.HSIZE)}return};actions.prototype._keyUpViewMaps=function(a){if(core.status.event.data==null){core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId));return}if(a==27||a==13||a==32||(!core.isReplaying()&&a==67)){core.clearMap("data");core.ui.closePanel();return}if(a==86){core.status.event.data.damage=!core.status.event.data.damage;core.ui.drawMaps(core.status.event.data);return}if(a==90){core.status.event.data.all=!core.status.event.data.all;core.ui.drawMaps(core.status.event.data);return}if(a==77){core.status.event.data.paint=!core.status.event.data.paint;core.ui.drawMaps(core.status.event.data);return}if(a==88||(core.isReplaying()&&a==67)){if(core.isReplaying()){core.bookReplay()}else{core.openBook(false)}return}return};actions.prototype._clickShop=function(d,e){var b=core.status.event.data.shop;var a=b.choices;if(d>=this.CHOICES_LEFT&&d<=this.CHOICES_RIGHT){var c=this.HSIZE-parseInt(a.length/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){return core.events._useShop(b,e-c)}else{if(e==c+a.length){core.events._exitShop()}else{return false}}}return true};actions.prototype._keyDownShop=function(a){if(a==32&&core.status.event.selection!=core.status.event.data.shop.choices.length){this._selectChoices(core.status.event.data.shop.choices.length+1,a,this._clickShop);return}this._keyDownChoices(a)};actions.prototype._keyUpShop=function(a){if(a==27||a==88){core.events._exitShop();return}if(a!=32||core.status.event.selection==core.status.event.data.shop.choices.length){this._selectChoices(core.status.event.data.shop.choices.length+1,a,this._clickShop);return}return};actions.prototype._clickQuickShop=function(d,e){var a=Object.keys(core.status.shops).filter(function(f){return core.status.shops[f].visited||!core.status.shops[f].mustEnable});if(d>=this.CHOICES_LEFT&&d<=this.CHOICES_RIGHT){var c=this.HSIZE-parseInt(a.length/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=core.events.canUseQuickShop(a[e-c]);if(!core.flags.enableDisabledShop&&b){core.drawText(b);return}core.events.openShop(a[e-c],true);if(core.status.event.id=="shop"){core.status.event.data.fromList=true}}else{if(e==c+a.length){core.ui.closePanel()}}return}return};actions.prototype._keyUpQuickShop=function(a){if(a==27||a==75||a==88||a==86){core.ui.closePanel();return}var b=Object.keys(core.status.shops).filter(function(c){return core.status.shops[c].visited||!core.status.shops[c].mustEnable});this._selectChoices(b.length+1,a,this._clickQuickShop);return};actions.prototype._clickToolbox=function(d,e){if(d>=this.LAST-2&&e==0){core.ui.closePanel();if(core.isReplaying()){core.equipboxReplay()}else{core.openEquipbox()}return}if(d>=this.LAST-2&&e==this.LAST){core.ui.closePanel();return}var c=core.status.event.data.toolsPage;var a=core.status.event.data.constantsPage;if(d==this.HSIZE-2||d==this.HSIZE-3){if(e==this.LAST-5&&c>1){core.status.event.data.toolsPage--;core.ui.drawToolbox(core.status.event.selection)}if(e==this.LAST&&a>1){core.status.event.data.constantsPage--;core.ui.drawToolbox(core.status.event.selection)}}if(d==this.HSIZE+2||d==this.HSIZE+3){if(e==this.LAST-5&&c<Math.ceil(Object.keys(core.status.hero.items.tools).length/this.LAST)){core.status.event.data.toolsPage++;core.ui.drawToolbox(core.status.event.selection)}if(e==this.LAST&&a<Math.ceil(Object.keys(core.status.hero.items.constants).length/this.LAST)){core.status.event.data.constantsPage++;core.ui.drawToolbox(core.status.event.selection)}}var b=parseInt(d/2);if(e==this.LAST-8){b+=0}else{if(e==this.LAST-6){b+=this.HSIZE}else{if(e==this.LAST-3){b+=this.LAST}else{if(e==this.LAST-1){b+=this.LAST+this.HSIZE}else{b=-1}}}}if(b>=0){this._clickToolboxIndex(b)}};actions.prototype._clickToolboxIndex=function(a){var c=null;var d;if(a<this.LAST){d=a+this.LAST*(core.status.event.data.toolsPage-1);c=Object.keys(core.status.hero.items.tools).sort()}else{d=a%this.LAST+this.LAST*(core.status.event.data.constantsPage-1);c=Object.keys(core.status.hero.items.constants).sort()}if(c==null){return}if(d>=c.length){return}var b=c[d];if(b==core.status.event.data.selectId){if(core.isReplaying()){return}core.events.tryUseItem(b)}else{core.ui.drawToolbox(a)}};actions.prototype._keyDownToolbox=function(f){if(core.status.event.data==null){return}var g=this.LAST-1;var i=Object.keys(core.status.hero.items.tools).sort();var a=Object.keys(core.status.hero.items.constants).sort();var e=core.status.event.selection;var k=core.status.event.data.toolsPage;var c=core.status.event.data.constantsPage;var l=Math.ceil(i.length/this.LAST);var d=Math.ceil(a.length/this.LAST);var j=k<l?g:(i.length+g)%this.LAST;var b=this.LAST+(c<d?g:(a.length+g)%this.LAST);if(f==37){if(e==0){if(k>1){core.status.event.data.toolsPage--;e=g}else{return}}else{if(e==this.LAST){if(c==1){if(l==0){return}core.status.event.data.toolsPage=l;e=(i.length+g)%this.LAST}else{core.status.event.data.constantsPage--;e=2*this.LAST-1}}else{e-=1}}this._clickToolboxIndex(e);return}if(f==38){if(e>=this.LAST&&e<this.LAST+this.HSIZE){if(l==0){return}if(j>=this.HSIZE){e=Math.min(j,e-this.HSIZE)}else{e=Math.min(j,e-this.LAST)}}else{if(e<this.HSIZE){return}else{e-=this.HSIZE}}this._clickToolboxIndex(e);return}if(f==39){if(k<l&&e==g){core.status.event.data.toolsPage++;e=0}else{if(c<d&&e==2*this.LAST-1){core.status.event.data.constantsPage++;e=this.LAST}else{if(e==j){if(d==0){return}core.status.event.data.constantsPage=1;e=this.LAST}else{if(e==b){return}else{e++}}}}this._clickToolboxIndex(e);return}if(f==40){var h=null;if(e<this.HSIZE){if(j>=this.HSIZE){h=Math.min(j,e+this.HSIZE)}else{e+=this.HSIZE}}if(h==null&&e<this.LAST){if(d==0){return}h=Math.min(e+this.HSIZE,b)}if(h==null&&e<this.LAST+this.HSIZE){if(b>=this.LAST+this.HSIZE){h=Math.min(b,e+this.HSIZE)}}if(h!=null){this._clickToolboxIndex(h)}return}};actions.prototype._keyUpToolbox=function(a){if(a==81){core.ui.closePanel();if(core.isReplaying()){core.equipboxReplay()}else{core.openEquipbox()}return}if(a==84||a==27||a==88){core.ui.closePanel();return}if(core.status.event.data==null){return}if(a==13||a==32||a==67){this._clickToolboxIndex(core.status.event.selection);return}};actions.prototype._clickEquipbox=function(e,f){if(e>=this.LAST-2&&f==0){core.ui.closePanel();if(core.isReplaying()){core.toolboxReplay()}else{core.openToolbox()}return}if(e>=this.LAST-2&&f==this.LAST){core.ui.closePanel();return}if((e==this.HSIZE-2||e==this.HSIZE-3)&&f==this.LAST){if(core.status.event.data.page>1){core.status.event.data.page--;core.ui.drawEquipbox(core.status.event.selection)}return}if((e==this.HSIZE+2||e==this.HSIZE+3)&&f==this.LAST){var b=Math.ceil(Object.keys(core.status.hero.items.equips).length/this.LAST);if(core.status.event.data.page<b){core.status.event.data.page++;core.ui.drawEquipbox(core.status.event.selection)}return}var c=this.HSIZE-3,d=this.SIZE/c;if(f==this.LAST-8){for(var a=0;a<c;++a){if(e>=a*d&&e<=(a+1)*d){return this._clickEquipboxIndex(a)}}}else{if(f==this.LAST-6){for(var a=0;a<c;++a){if(e>=a*d&&e<=(a+1)*d){return this._clickEquipboxIndex(c+a)}}}else{if(f==this.LAST-3){this._clickEquipboxIndex(this.LAST+parseInt(e/2))}else{if(f==this.LAST-1){this._clickEquipboxIndex(this.LAST+this.HSIZE+parseInt(e/2))}}}}};actions.prototype._clickEquipboxIndex=function(c){if(c<this.LAST){if(c>=core.status.globalAttribute.equipName.length){return}if(c==core.status.event.selection&&core.status.hero.equipment[c]){if(core.isReplaying()){return}core.unloadEquip(c);core.status.route.push("unEquip:"+c)}}else{var b=Object.keys(core.status.hero.items.equips||{}).sort();if(c==core.status.event.selection){if(core.isReplaying()){return}var a=b[c-this.LAST+(core.status.event.data.page-1)*this.LAST];core.loadEquip(a);core.status.route.push("equip:"+a)}}core.ui.drawEquipbox(c)};actions.prototype._keyDownEquipbox=function(c){if(core.status.event.data==null){return}var d=this.LAST-1;var g=this.HSIZE-3;var a=core.status.globalAttribute.equipName.length;var e=Object.keys(core.status.hero.items.equips).sort();var b=core.status.event.selection;var f=core.status.event.data.page;var i=Math.ceil(e.length/this.LAST);var h=this.LAST+(f<i?d:(e.length+d)%this.LAST);if(c==37){if(b==0){return}if(b==this.LAST){if(f>1){core.status.event.data.page--;b=this.LAST+d}else{if(f==1){b=a-1}else{return}}}else{b-=1}this._clickEquipboxIndex(b);return}if(c==38){if(b<g){return}else{if(b<2*g){b-=g}else{if(b<this.LAST+this.HSIZE){b=parseInt((b-this.LAST)/2);if(a>g){b=Math.min(a-1,b+g)}else{b=Math.min(a-1,b)}}else{b-=this.HSIZE}}}this._clickEquipboxIndex(b);return}if(c==39){if(f<i&&b==this.LAST+d){core.status.event.data.page++;b=this.LAST}else{if(b==a-1){if(i==0){return}b=this.LAST}else{if(b==h){return}else{b++}}}this._clickEquipboxIndex(b);return}if(c==40){if(b<g){if(a>g){b=Math.min(b+g,a-1)}else{if(i==0){return}b=Math.min(2*b+1+this.LAST,h)}}else{if(b<2*g){if(i==0){return}b=Math.min(2*(b-g)+1+this.LAST,h)}else{if(b<this.LAST+this.HSIZE){b=Math.min(b+this.HSIZE,h)}else{return}}}this._clickEquipboxIndex(b);return}};actions.prototype._keyUpEquipbox=function(b,a){if(a&&b>=48&&b<=57){core.items.quickSaveEquip(b-48);return}if(b==84){core.ui.closePanel();if(core.isReplaying()){core.toolboxReplay()}else{core.openToolbox()}return}if(b==81||b==27||b==88){core.ui.closePanel();return}if(!core.status.event.data.selectId){return}if(b==13||b==32||b==67){this._clickEquipboxIndex(core.status.event.selection);return}};actions.prototype._clickSL=function(g,j){var d=core.status.event.data.page,c=core.status.event.data.offset;var b=d*10+c;if((g==this.HSIZE-1||g==this.HSIZE-2)&&j==this.LAST){core.ui.drawSLPanel(10*(d-1)+c);return}if((g==this.HSIZE+1||g==this.HSIZE+2)&&j==this.LAST){core.ui.drawSLPanel(10*(d+1)+c);return}if(g>=this.LAST-2&&j==this.LAST){if(core.events.recoverEvents(core.status.event.interval)){return}core.ui.closePanel();delete core.status.tempRoute;if(!core.isPlaying()){core.showStartAnimate(true)}return}if(g>=0&&g<=2&&j==this.LAST){if(core.status.event.id=="save"){core.status.event.selection=!core.status.event.selection;core.ui.drawSLPanel(b)}else{core.status.event.data.mode=core.status.event.data.mode=="all"?"fav":"all";if(core.status.event.data.mode=="fav"){core.ui.drawSLPanel(1,true)}else{d=parseInt((core.saves.saveIndex-1)/5);c=core.saves.saveIndex-5*d;core.ui.drawSLPanel(10*d+c,true)}}return}var h=parseInt(this.SIZE/3),i=parseInt(this.SIZE*2/3);var e=0,f=this.HSIZE;if(j>=e&&j<=e+1){if(g>=h&&g<i){return this._clickSL_favorite(d,1)}if(g>=i){return this._clickSL_favorite(d,2)}}if(j>=f&&j<=f+1){if(g<h){return this._clickSL_favorite(d,3)}if(g>=h&&g<i){return this._clickSL_favorite(d,4)}if(g>=i){return this._clickSL_favorite(d,5)}}var a=null;if(j>=e+2&&j<this.HSIZE-1){if(g<h){a="autoSave"}if(g>=h&&g<i){a=5*d+1}if(g>=i){a=5*d+2}}if(j>=f+2&&j<this.SIZE-1){if(g<h){a=5*d+3}if(g>=h&&g<i){a=5*d+4}if(g>=i){a=5*d+5}}if(a!=null){if(core.status.event.selection){if(a=="autoSave"){core.drawTip("无法删除自动存档！")}else{core.removeSave(a,function(){core.ui.drawSLPanel(b,true)})}}else{if(core.status.event.data.mode=="fav"&&a!="autoSave"){a=core.saves.favorite[a-1]}core.doSL(a,core.status.event.id)}}};actions.prototype._clickSL_favorite=function(c,b){if(b==0){return}var a=5*c+b;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1];core.myprompt("请输入想要显示的存档名(长度不超过5字符)",null,function(e){if(e&&e.length<=5){core.saves.favoriteName[a]=e;core.control._updateFavoriteSaves();core.drawSLPanel(10*c+b)}else{if(e){alert("无效的输入！")}}})}else{var d=core.saves.favorite.indexOf(a);if(d>=0){core.saves.favorite.splice(d,1);delete core.saves.favoriteName[a]}else{if(core.hasSave(a)){core.saves.favorite.push(a);core.saves.favorite=core.saves.favorite.sort(function(e,f){return e-f});core.drawTip("收藏成功！")}}core.control._updateFavoriteSaves();core.ui.drawSLPanel(10*c+b)}};actions.prototype._keyDownSL=function(b){var d=core.status.event.data.page,c=core.status.event.data.offset;var a=d*10+c;if(b==37){if(c==0){core.ui.drawSLPanel(10*(d-1)+5)}else{core.ui.drawSLPanel(a-1)}return}if(b==38){if(c<3){core.ui.drawSLPanel(10*(d-1)+c+3)}else{core.ui.drawSLPanel(a-3)}return}if(b==39){if(c==5){core.ui.drawSLPanel(10*(d+1)+1)}else{core.ui.drawSLPanel(a+1)}return}if(b==40){if(c>=3){core.ui.drawSLPanel(10*(d+1)+c-3)}else{core.ui.drawSLPanel(a+3)}return}if(b==33){core.ui.drawSLPanel(10*(d-1)+c);return}if(b==34){core.ui.drawSLPanel(10*(d+1)+c);return}};actions.prototype._keyUpSL=function(c){var e=core.status.event.data.page,d=core.status.event.data.offset;var b=e*10+d;if(c==27||c==88||(core.status.event.id=="save"&&c==83)||(core.status.event.id=="load"&&c==68)){this._clickSL(this.LAST,this.LAST);return}if(c>=48&&c<=57){if(c==48){c=58}core.ui.drawSLPanel((c-49)*1000+1);return}if(c==13||c==32||c==67){if(d==0){core.doSL("autoSave",core.status.event.id)}else{var a=5*e+d;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1]}core.doSL(a,core.status.event.id)}return}if(c==69&&core.status.event.id!="save"){this._clickSL(0,this.LAST);return}if(c==46){if(d==0){core.drawTip("无法删除自动存档！")}else{var a=5*e+d;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1]}core.removeSave(a,function(){core.ui.drawSLPanel(b,true)})}}if(c==70&&core.status.event.data.mode=="all"){this._clickSL_favorite(e,d)}};actions.prototype._clickSwitchs=function(d,e){var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);var b=e-c;if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){if(b!=2&&b!=3){return}if(d!=this.HSIZE-2&&d!=this.HSIZE+2){return}}if(b>=0&&b<a.length){core.status.event.selection=b;switch(b){case 0:return this._clickSwitchs_bgm();case 1:return this._clickSwitchs_sound();case 2:if(d==this.HSIZE-2){return this._clickSwitchs_userVolume(-1)}if(d==this.HSIZE+2){return this._clickSwitchs_userVolume(1)}return;case 3:if(d==this.HSIZE-2){return this._clickSwitchs_moveSpeed(-10)}if(d==this.HSIZE+2){return this._clickSwitchs_moveSpeed(10)}return;case 4:return this._clickSwitchs_displayEnemyDamage();case 5:return this._clickSwitchs_displayCritical();case 6:return this._clickSwitchs_displayExtraDamage();case 7:return this._clickSwitchs_localForage();case 8:return this._clickSwitchs_clickMove();case 9:core.status.event.selection=0;core.ui.drawSettings();break}}};actions.prototype._clickSwitchs_bgm=function(){core.triggerBgm();core.ui.drawSwitchs()};actions.prototype._clickSwitchs_sound=function(){core.musicStatus.soundStatus=!core.musicStatus.soundStatus;core.setLocalStorage("soundStatus",core.musicStatus.soundStatus);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_userVolume=function(a){var b=Math.round(Math.sqrt(100*core.musicStatus.userVolume));core.musicStatus.userVolume=core.clamp(Math.pow(b+a,2)/100,0,1);if(core.musicStatus.gainNode!=null){core.musicStatus.gainNode.gain.value=core.musicStatus.userVolume}if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].volume=core.musicStatus.userVolume*core.musicStatus.designVolume}core.setLocalStorage("userVolume",core.musicStatus.userVolume);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_moveSpeed=function(a){core.values.moveSpeed=core.clamp(core.values.moveSpeed+a,50,200);core.setLocalStorage("moveSpeed",core.values.moveSpeed);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_displayEnemyDamage=function(){core.flags.displayEnemyDamage=!core.flags.displayEnemyDamage;core.updateDamage();core.setLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_displayCritical=function(){core.flags.displayCritical=!core.flags.displayCritical;core.updateDamage();core.setLocalStorage("critical",core.flags.displayCritical);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_displayExtraDamage=function(){core.flags.displayExtraDamage=!core.flags.displayExtraDamage;core.updateDamage();core.setLocalStorage("extraDamage",core.flags.displayExtraDamage);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_localForage=function(){core.platform.useLocalForage=!core.platform.useLocalForage;core.setLocalStorage("useLocalForage",core.platform.useLocalForage);core.control.getSaveIndexes(function(a){core.saves.ids=a});core.ui.drawSwitchs()};actions.prototype._clickSwitchs_clickMove=function(){if(core.hasFlag("__noClickMove__")){core.removeFlag("__noClickMove__")}else{core.setFlag("__noClickMove__",true)}core.ui.drawSwitchs()};actions.prototype._keyUpSwitchs=function(a){if(a==27||a==88){core.status.event.selection=0;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSwitchs)};actions.prototype._clickSettings=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.status.event.selection=0;core.ui.drawSwitchs();break;case 1:core.ui.drawKeyBoard();break;case 2:core.clearUI();core.ui.drawMaps();break;case 3:core.clearUI();core.ui.drawPaint();break;case 4:core.status.event.selection=0;core.ui.drawSyncSave();break;case 5:core.status.event.selection=0;core.ui.drawGameInfo();break;case 6:return core.confirmRestart();case 7:core.ui.closePanel();break}}return};actions.prototype._keyUpSettings=function(a){if(a==27||a==88){core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSettings)};actions.prototype._clickSyncSave=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.status.event.selection=0;core.ui.drawSyncSelect();break;case 1:core.syncLoad();break;case 2:core.status.event.selection=0;core.ui.drawLocalSaveSelect();break;case 3:return this._clickSyncSave_readFile();case 4:return this._clickSyncSave_replay();case 5:core.status.event.selection=0;core.ui.drawStorageRemove();break;case 6:core.status.event.selection=4;core.ui.drawSettings();break}}return};actions.prototype._clickSyncSave_readFile=function(){core.readFile(function(a){if(a.name!=core.firstData.name){return alert("存档和游戏不一致！")}if(a.version!=core.firstData.version){return alert("游戏版本不一致！")}if(!a.data){return alert("无效的存档！")}core.control._syncLoad_write(a.data)},null,".h5save")};actions.prototype._clickSyncSave_replay=function(){core.ui.drawReplay()};actions.prototype._keyUpSyncSave=function(a){if(a==27||a==88){core.status.event.selection=2;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSyncSave)};actions.prototype._clickSyncSelect=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.syncSave("all");break;case 1:core.syncSave();break;case 2:core.status.event.selection=0;core.ui.drawSyncSave();break}}};actions.prototype._keyUpSyncSelect=function(a){if(a==27||a==88){core.status.event.selection=0;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSyncSelect)};actions.prototype._clickLocalSaveSelect=function(e,f){if(e<this.CHOICES_LEFT||e>this.CHOICES_RIGHT){return}var b=core.status.event.ui.choices;var d=this.HSIZE-parseInt((b.length-1)/2)+(core.status.event.ui.offset||0);if(f>=d&&f<d+b.length){var c=f-d;core.status.event.selection=c;if(c<2){var a=function(h){if(h){var g={name:core.firstData.name,version:core.firstData.version,data:h};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5save",JSON.stringify(g))}};if(c==0){core.getAllSaves(a)}else{core.getSave(core.saves.saveIndex,a)}}core.status.event.selection=2;core.ui.drawSyncSave()}};actions.prototype._keyUpLocalSaveSelect=function(a){if(a==27||a==88){core.status.event.selection=0;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickLocalSaveSelect)};actions.prototype._clickStorageRemove=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return this._clickStorageRemove_all();case 1:return this._clickStorageRemove_current();case 2:core.status.event.selection=6;core.ui.drawSyncSave();break}}};actions.prototype._clickStorageRemove_all=function(){core.myconfirm("你确定要清除【全部塔】的所有本地存档？\n此行为不可逆！！！",function(){var a=function(){core.saves.ids={};core.saves.autosave.data=null;core.saves.autosave.updated=false;core.ui.closePanel();core.saves.saveIndex=1;core.saves.favorite=[];core.saves.favoriteName={};core.control._updateFavoriteSaves();core.removeLocalStorage("saveIndex");core.drawText("\t[操作成功]你的所有存档已被清空。")};if(core.platform.useLocalForage){core.ui.drawWaiting("正在清空，请稍后...");localforage.clear(a)}else{localStorage.clear();a()}})};actions.prototype._clickStorageRemove_current=function(){core.myconfirm("你确定要清除本塔的所有本地存档？\n此行为不可逆！！！",function(){var a=function(){core.saves.ids={};core.saves.autosave.data=null;core.saves.autosave.updated=false;core.ui.closePanel();core.saves.saveIndex=1;core.saves.favorite=[];core.saves.favoriteName={};core.control._updateFavoriteSaves();core.removeLocalStorage("saveIndex");core.drawText("\t[操作成功]当前塔的存档已被清空。")};if(core.platform.useLocalForage){core.ui.drawWaiting("正在清空，请稍后...");Object.keys(core.saves.ids).forEach(function(b){core.removeLocalForage("save"+b)});core.removeLocalForage("autoSave",a)}else{Object.keys(core.saves.ids).forEach(function(b){core.removeLocalStorage("save"+b)});core.removeLocalStorage("autoSave");a()}})};actions.prototype._keyUpStorageRemove=function(a){if(a==27||a==88){core.status.event.selection=5;core.ui.drawSyncSave();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickStorageRemove)};actions.prototype._clickReplay=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return this._clickReplay_fromBeginning();case 1:return this._clickReplay_fromLoad();case 2:return this._clickReplay_replayRemain();case 3:return core.chooseReplayFile();case 4:return this._clickReplay_download();case 5:return core.ui.closePanel()}}};actions.prototype._clickReplay_fromBeginning=function(){core.ui.closePanel();core.startGame(core.status.hard,core.getFlag("__seed__"),core.clone(core.status.route))};actions.prototype._clickReplay_fromLoad=function(){core.status.event.id="replayLoad";core.status.event.selection=null;core.clearUI();var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)};actions.prototype._clickReplay_replayRemain=function(){core.closePanel();core.drawText(["\t[接续播放录像]该功能允许你播放\r[yellow]两个存档之间的录像\r，常常用于\r[yellow]区域优化\r。\n例如，有若干个区，已经全部通关；之后重打一区并进行了优化，则可以对剩余区域直接播放录像而无需全部重打。","\t[步骤1]请选择一个存档。\n\r[yellow]该存档的坐标必须和当前勇士坐标完全相同。\r\n将尝试从此处开始回放。",],function(){core.status.event.id="replayRemain";core.lockControl();var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)})};actions.prototype._clickReplay_download=function(){core.download(core.firstData.name+"_"+core.formatDate2()+".h5route",JSON.stringify({name:core.firstData.name,hard:core.status.hard,seed:core.getFlag("__seed__"),route:core.encodeRoute(core.status.route)}))};actions.prototype._keyUpReplay=function(a){if(a==27||a==88){core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickReplay)};actions.prototype._clickGameInfo=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return core.ui.drawStatistics();case 1:return this._clickGameInfo_openProject();case 2:return this._clickGameInfo_openComments();case 3:return core.ui.drawHelp();case 4:return core.ui.drawAbout();case 5:return this._clickGameInfo_download();case 6:core.status.event.selection=5;core.ui.drawSettings();break}}};actions.prototype._clickGameInfo_openProject=function(){if(core.platform.isPC){window.open("editor.html","_blank")}else{core.myconfirm("即将离开本塔，跳转至本塔工程页面，确认？",function(){window.location.href="editor-mobile.html"})}};actions.prototype._clickGameInfo_openComments=function(){if(core.platform.isPC){window.open("/score.php?name="+core.firstData.name+"&num=10","_blank")}else{core.myconfirm("即将离开本塔，跳转至本塔评论页面，确认？",function(){window.location.href="/score.php?name="+core.firstData.name+"&num=10"})}};actions.prototype._clickGameInfo_download=function(){if(core.platform.isPC){window.open(core.firstData.name+".zip")}else{window.location.href=core.firstData.name+".zip"}};actions.prototype._keyUpGameInfo=function(a){if(a==27||a==88){core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickGameInfo)};actions.prototype._clickKeyBoard=function(x,y){var m=this.HSIZE;if(y==m-3&&x>=m-5&&x<=m+5){core.ui.closePanel();core.keyUp(112+x+5-m)}if(y==m-3&&x==m+6){var val=prompt();if(val!=null){try{eval(val)}catch(e){}}}if(y==m-2&&x>=m-5&&x<=m+4){core.ui.closePanel();core.keyUp(x==m+4?48:49+x+5-m)}var lines=[["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],];if(y==m-1&&x>=m-5&&x<=m+4){core.ui.closePanel();core.keyUp(lines[0][x+5-m].charCodeAt(0))}if(y==m&&x>=m-5&&x<=m+3){core.ui.closePanel();core.keyUp(lines[1][x+5-m].charCodeAt(0))}if(y==m+1&&x>=m-5&&x<=m+1){core.ui.closePanel();core.keyUp(lines[2][x+5-m].charCodeAt(0))}if(y==m+2&&x>=m-5&&x<=m+5){core.ui.closePanel();if(x==m-5){core.keyUp(189)}if(x==m-4){core.keyUp(187)}if(x==m-3){core.keyUp(219)}if(x==m-2){core.keyUp(221)}if(x==m-1){core.keyUp(220)}if(x==m){core.keyUp(186)}if(x==m+1){core.keyUp(222)}if(x==m+2){core.keyUp(188)}if(x==m+3){core.keyUp(190)}if(x==m+4){core.keyUp(191)}if(x==m+5){core.keyUp(192)}}if(y==m+3&&x>=m-5&&x<=m+4){core.ui.closePanel();if(x==m-5){core.keyUp(27)}if(x==m-4){core.keyUp(9)}if(x==m-3){core.keyUp(20)}if(x==m-2){core.keyUp(16)}if(x==m-1){core.keyUp(17)}if(x==m){core.keyUp(18)}if(x==m+1){core.keyUp(32)}if(x==m+2){core.keyUp(8)}if(x==m+3){core.keyUp(13)}if(x==m+4){core.keyUp(46)}}if(y==m+4&&x>=m+3&&x<=m+5){core.ui.closePanel()}};actions.prototype._clickCursor=function(a,b){if(a==core.status.automaticRoute.cursorX&&b==core.status.automaticRoute.cursorY){core.ui.closePanel();core.onclick(a,b,[]);return}core.status.automaticRoute.cursorX=a;core.status.automaticRoute.cursorY=b;core.ui.drawCursor()};actions.prototype._keyDownCursor=function(a){if(a==37){core.status.automaticRoute.cursorX--;core.ui.drawCursor();return}if(a==38){core.status.automaticRoute.cursorY--;core.ui.drawCursor();return}if(a==39){core.status.automaticRoute.cursorX++;core.ui.drawCursor();return}if(a==40){core.status.automaticRoute.cursorY++;core.ui.drawCursor();return}};actions.prototype._keyUpCursor=function(a){if(a==27||a==88){core.ui.closePanel();return}if(a==13||a==32||a==67||a==69){core.ui.closePanel();core.onclick(core.status.automaticRoute.cursorX,core.status.automaticRoute.cursorY,[]);return}};actions.prototype._ondownPaint=function(a,b){a+=core.bigmap.offsetX;b+=core.bigmap.offsetY;if(!core.status.event.data.erase){core.dymCanvas.paint.beginPath();core.dymCanvas.paint.moveTo(a,b)}core.status.event.data.x=a;core.status.event.data.y=b};actions.prototype._onmovePaint=function(c,d){if(core.status.event.data.x==null){return}c+=core.bigmap.offsetX;d+=core.bigmap.offsetY;if(core.status.event.data.erase){core.clearMap("paint",c-10,d-10,20,20);return}var a=(core.status.event.data.x+c)/2,b=(core.status.event.data.y+d)/2;core.dymCanvas.paint.quadraticCurveTo(a,b,c,d);core.dymCanvas.paint.stroke();core.status.event.data.x=c;core.status.event.data.y=d};actions.prototype._onupPaint=function(){core.status.event.data.x=null;core.status.event.data.y=null;core.paint[core.status.floorId]=lzw_encode(core.utils._encodeCanvas(core.dymCanvas.paint).join(","))};actions.prototype.setPaintMode=function(a){if(a=="paint"){core.status.event.data.erase=false}else{if(a=="erase"){core.status.event.data.erase=true}else{return}}core.drawTip("进入"+(core.status.event.data.erase?"擦除":"绘图")+"模式")};actions.prototype.clearPaint=function(){core.clearMap("paint");delete core.paint[core.status.floorId];core.drawTip("已清空绘图内容")};actions.prototype.savePaint=function(){var a={};for(var b in core.paint){if(core.paint[b]){a[b]=lzw_decode(core.paint[b])}}core.download(core.firstData.name+".h5paint",JSON.stringify({name:core.firstData.name,paint:a}))};actions.prototype.loadPaint=function(){core.readFile(function(b){if(b.name!=core.firstData.name){alert("绘图文件和游戏不一致！");return}if(!b.paint){alert("无效的绘图文件！");return}core.paint={};for(var a in b.paint){if(b.paint[a]){core.paint[a]=lzw_encode(b.paint[a])}}core.clearMap("paint");var c=core.paint[core.status.floorId];if(c){c=lzw_decode(c).split(",")}core.utils._decodeCanvas(c,32*core.bigmap.width,32*core.bigmap.height);core.drawImage("paint",core.bigmap.tempCanvas.canvas,0,0);core.drawTip("读取绘图文件成功")})};actions.prototype.exitPaint=function(){core.deleteCanvas("paint");core.ui.closePanel();core.statusBar.image.keyboard.style.opacity=1;core.statusBar.image.shop.style.opacity=1;core.drawTip("退出绘图模式")};actions.prototype._keyUpPaint=function(a){if(a==27||a==88||a==77||a==13||a==32||a==67){this.exitPaint();return}};