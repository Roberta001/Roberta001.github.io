"use strict";function core(){this.__SIZE__=11;this.__PIXELS__=this.__SIZE__*32;this.__HALF_SIZE__=Math.floor(this.__SIZE__/2);this.material={animates:{},images:{},bgms:{},sounds:{},ground:null,items:{},enemys:{},icons:{},};this.timeout={turnHeroTimeout:null,onDownTimeout:null,sleepTimeout:null,};this.interval={heroMoveInterval:null,onDownInterval:null,};this.animateFrame={totalTime:0,totalTimeStart:0,globalAnimate:false,globalTime:0,selectorTime:0,selectorUp:true,animateTime:0,moveTime:0,lastLegTime:0,leftLeg:true,weather:{time:0,type:null,nodes:[],data:null,fog:null,},tips:{time:0,offset:0,list:[],lastSize:0,},asyncId:{}};this.musicStatus={audioContext:null,bgmStatus:false,soundStatus:true,playingBgm:null,lastBgm:null,gainNode:null,playingSounds:{},userVolume:1,designVolume:1,cachedBgms:[],cachedBgmCount:4,};this.platform={isOnline:true,isPC:true,isAndroid:false,isIOS:false,string:"PC",isWeChat:false,isQQ:false,isChrome:false,supportCopy:false,useLocalForage:true,fileInput:null,fileReader:null,successCallback:null,errorCallback:null,};this.domStyle={scale:1,isVertical:false,showStatusBar:true,toolbarBtn:false,};this.bigmap={canvas:["bg","event","event2","fg","damage"],offsetX:0,offsetY:0,width:this.__SIZE__,height:this.__SIZE__,tempCanvas:null,};this.paint={};this.saves={saveIndex:null,ids:{},autosave:{data:null,time:0,updated:false,storage:true,max:10,},favorite:[],favoriteName:{}};this.initStatus={played:false,gameOver:false,hero:{},heroCenter:{px:null,py:null},floorId:null,thisMap:null,maps:null,bgmaps:{},fgmaps:{},checkBlock:{},lockControl:false,heroMoving:0,heroStop:true,automaticRoute:{autoHeroMove:false,autoStep:0,movedStep:0,destStep:0,destX:null,destY:null,offsetX:null,offsetY:null,autoStepRoutes:[],moveStepBeforeStop:[],lastDirection:null,cursorX:null,cursorY:null,moveDirectly:false,},downTime:null,ctrlDown:false,route:[],replay:{replaying:false,pausing:false,animate:false,toReplay:[],totalList:[],speed:1,steps:0,save:[],},shops:{},event:{id:null,data:null,selection:null,ui:null,interval:null,},autoEvents:[],textAttribute:{position:"center",offset:0,title:[255,215,0,1],background:[0,0,0,0.85],text:[255,255,255,1],titlefont:22,textfont:16,bold:false,time:0,},globalAttribute:{equipName:main.equipName||[],statusLeftBackground:main.statusLeftBackground||"url(project/images/ground.png) repeat",statusTopBackground:main.statusTopBackground||"url(project/images/ground.png) repeat",toolsBackground:main.toolsBackground||"url(project/images/ground.png) repeat",borderColor:main.borderColor||"white",statusBarColor:main.statusBarColor||"white",hardLabelColor:main.hardLabelColor||"red",floorChangingBackground:main.floorChangingBackground||"black",floorChangingTextColor:main.floorChangingTextColor||"white",font:main.font||"Verdana"},curtainColor:null,openingDoor:null,globalAnimateObjs:[],floorAnimateObjs:[],boxAnimateObjs:[],autotileAnimateObjs:{blocks:[],map:null,bgmap:null,fgmap:null},globalAnimateStatus:0,animateObjs:[],};this.status={};this.dymCanvas={}}core.prototype.init=function(b,a){this._forwardFuncs();for(var c in b){core[c]=b[c]}this._init_flags();this._init_platform();this._init_others();this._initPlugins();core.loader._load(function(){core.extensions._load(function(){core._afterLoadResources(a)})})};core.prototype._init_flags=function(){core.flags=core.clone(core.data.flags);core.values=core.clone(core.data.values);core.firstData=core.clone(core.data.firstData);this._init_sys_flags();document.title=core.firstData.title+" - HTML5魔塔";(core.firstData.shops||[]).forEach(function(i){core.initStatus.shops[i.id]=i});for(var c in core.floors){var b=core.floors[c].autoEvent||{};for(var e in b){var f=e.split(","),g=parseInt(f[0]),h=parseInt(f[1]);for(var d in b[e]){var a=core.clone(b[e][d]);if(a&&a.condition&&a.data){a.floorId=c;a.x=g;a.y=h;a.index=d;a.symbol=c+"@"+g+"@"+h+"@"+d;a.condition=core.replaceValue(a.condition);a.data=core.precompile(a.data);core.initStatus.autoEvents.push(a)}}}}core.initStatus.autoEvents.sort(function(i,j){if(i.priority!=j.priority){return j.priority-i.priority}if(i.floorId!=j.floorId){return core.floorIds.indexOf(i.floorId)-core.floorIds.indexOf(j.floorId)}if(i.x!=j.x){return i.x-j.x}if(i.y!=j.y){return i.y-j.y}return i.index-j.index});core.maps._setFloorSize();core.material.enemys=core.enemys.getEnemys();core.material.items=core.items.getItems();core.items._resetItems();core.material.icons=core.icons.getIcons()};core.prototype._init_sys_flags=function(){if(!core.flags.enableExperience){core.flags.enableLevelUp=false}if(!core.flags.enableLevelUp){core.flags.levelUpLeftMode=false}if(core.flags.equipboxButton){core.flags.equipment=true}core.flags.displayEnemyDamage=core.getLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.flags.displayCritical=core.getLocalStorage("critical",core.flags.displayCritical);core.flags.displayExtraDamage=core.getLocalStorage("extraDamage",core.flags.displayExtraDamage);core.values.moveSpeed=core.getLocalStorage("moveSpeed",core.values.moveSpeed)};core.prototype._init_platform=function(){core.platform.isOnline=location.protocol.indexOf("http")==0;if(!core.platform.isOnline){alert("请勿直接打开html文件！使用启动服务或者APP进行离线游戏。")}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;try{core.musicStatus.audioContext=new window.AudioContext();core.musicStatus.gainNode=core.musicStatus.audioContext.createGain();core.musicStatus.gainNode.connect(core.musicStatus.audioContext.destination)}catch(b){core.musicStatus.audioContext=null}core.musicStatus.bgmStatus=core.getLocalStorage("bgmStatus",true);core.musicStatus.soundStatus=core.getLocalStorage("soundStatus",true);core.musicStatus.userVolume=core.getLocalStorage("userVolume",1);["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"].forEach(function(c){if(navigator.userAgent.indexOf(c)>=0){if(c=="iPhone"||c=="iPad"||c=="iPod"){core.platform.isIOS=true}if(c=="Android"){core.platform.isAndroid=true}core.platform.isPC=false}});core.platform.string=core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"";core.platform.supportCopy=document.queryCommandSupported&&document.queryCommandSupported("copy");var a=/Chrome\/(\d+)\./i.exec(navigator.userAgent);if(a&&parseInt(a[1])>=50){core.platform.isChrome=true}core.platform.isSafari=/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent);core.platform.isQQ=/QQ/i.test(navigator.userAgent);core.platform.isWeChat=/MicroMessenger/i.test(navigator.userAgent);this._init_checkLocalForage();if(window.FileReader){core.platform.fileReader=new FileReader();core.platform.fileReader.onload=function(){core.readFileContent(core.platform.fileReader.result)};core.platform.fileReader.onerror=function(){if(core.platform.errorCallback){core.platform.errorCallback()}}}};core.prototype._init_checkLocalForage=function(){core.platform.useLocalForage=core.getLocalStorage("useLocalForage",true);var a=function(c){main.log(c);core.platform.useLocalForage=false};if(core.platform.useLocalForage){try{core.setLocalForage("__test__",lzw_encode("__test__"),function(){try{core.getLocalForage("__test__",null,function(d){try{if(lzw_decode(d)!="__test__"){core.platform.useLocalForage=false}else{core.removeLocalForage("__test__")}}catch(f){a(f)}},a)}catch(c){a(c)}},a)}catch(b){a(b)}}};core.prototype._init_others=function(){core.material.groundCanvas=document.createElement("canvas").getContext("2d");core.material.groundCanvas.canvas.width=core.material.groundCanvas.canvas.height=32;core.material.groundPattern=core.material.groundCanvas.createPattern(core.material.groundCanvas.canvas,"repeat");core.bigmap.tempCanvas=document.createElement("canvas").getContext("2d");core.loadImage("fog",function(b,a){core.animateFrame.weather.fog=a});core.loadImage("keyboard",function(b,a){core.material.images.keyboard=a});core.saves.saveIndex=core.getLocalStorage("saveIndex",1);core.control.getSaveIndexes(function(a){core.saves.ids=a})};core.prototype._afterLoadResources=function(a){core.initStatus.maps=core.maps._initMaps();core.ui.statusBar.init();core.control._setRequestAnimationFrame();if(core.plugin._afterLoadResources){core.plugin._afterLoadResources()}core.showStartAnimate();if(a){a()}};core.prototype._initPlugins=function(){core.plugin=new function(){};for(var b in plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1){if(plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1[b] instanceof Function){try{plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1[b].apply(core.plugin)}catch(a){main.log(a);main.log("无法初始化插件"+b)}}}core._forwardFunc("plugin")};core.prototype._forwardFuncs=function(){for(var a=0;a<main.loadList.length;++a){var b=main.loadList[a];if(b=="core"){continue}this._forwardFunc(b)}};core.prototype._forwardFunc=function(name,funcname){if(funcname==null){for(funcname in core[name]){if(funcname.charAt(0)!="_"&&core[name][funcname] instanceof Function){this._forwardFunc(name,funcname)}}return}if(core[funcname]){console.error("ERROR: 无法转发 "+name+" 中的函数 "+funcname+" 到 core 中！同名函数已存在。");return}var parameterInfo=/^\s*function\s*[\w_$]*\(([\w_,$\s]*)\)\s*\{/.exec(core[name][funcname].toString());var parameters=(parameterInfo==null?"":parameterInfo[1]).replace(/\s*/g,"").replace(/,/g,", ");eval("core."+funcname+" = function ("+parameters+") {\n\treturn core."+name+"."+funcname+"("+parameters+");\n}");if(name=="plugin"){main.log("插件函数转发：core."+funcname+" = core.plugin."+funcname)}};core.prototype.doFunc=function(b,a){if(typeof b=="string"){b=core.plugin[b];a=core.plugin}return b.apply(a,Array.prototype.slice.call(arguments,2))};var core=new core();