"use strict";function loader(){this._init()}loader.prototype._init=function(){};loader.prototype._setStartProgressVal=function(a){core.dom.startTopProgress.style.width=a+"%"};loader.prototype._setStartLoadTipText=function(a){core.dom.startTopLoadTips.innerText=a};loader.prototype._load=function(a){this._loadIcons();this._loadAnimates();this._loadMusic();core.loader._loadMaterialImages(function(){core.loader._loadExtraImages(function(){core.loader._loadAutotiles(function(){core.loader._loadTilesets(a)})})})};loader.prototype._loadIcons=function(){this.loadImage("icons.png",function(a,b){var c=core.splitImage(b);for(var d in core.statusBar.icons){if(typeof core.statusBar.icons[d]=="number"){core.statusBar.icons[d]=c[core.statusBar.icons[d]];if(core.statusBar.image[d]!=null){core.statusBar.image[d].src=core.statusBar.icons[d].src}}}})};loader.prototype._loadMaterialImages=function(a){if(main.useCompress){this.loadImagesFromZip("project/images/materials.zip",core.materials,core.material.images,a)}else{this.loadImages(core.materials,core.material.images,a)}};loader.prototype._loadExtraImages=function(a){core.material.images.images={};var b=core.clone(core.images);if(b.indexOf("hero.png")<0){b.push("hero.png")}if(main.useCompress){this.loadImagesFromZip("project/images/images.zip",b,core.material.images.images,a)}else{this.loadImages(b,core.material.images.images,a)}};loader.prototype._loadAutotiles=function(c){core.material.images.autotile={};var d=Object.keys(core.material.icons.autotile);var b={};var a=function(){d.forEach(function(e){core.material.images.autotile[e]=b[e]});setTimeout(function(){core.maps._makeAutotileEdges()});c()};if(main.useCompress){this.loadImagesFromZip("project/images/autotiles.zip",d,b,a)}else{this.loadImages(d,b,a)}};loader.prototype._loadTilesets=function(b){core.material.images.tilesets={};core.tilesets=core.tilesets||[];var a=function(){for(var d in core.material.images.tilesets){var c=core.material.images.tilesets[d];if(c.width%32!=0||c.height%32!=0){console.warn("警告！"+d+"的宽或高不是32的倍数！")}if(c.width*c.height>32*32*3000){console.warn("警告！"+d+"上的图块素材个数大于3000！")}}b()};if(main.useCompress){this.loadImagesFromZip("project/images/tilesets.zip",core.tilesets,core.material.images.tilesets,a)}else{this.loadImages(core.tilesets,core.material.images.tilesets,a)}};loader.prototype.loadImages=function(d,e,a){if(!d||d.length==0){if(a){a()}return}var c=0;for(var b=0;b<d.length;b++){this.loadImage(d[b],function(f,g){core.loader._setStartLoadTipText("正在加载图片 "+f+"...");if(e[f]!==undefined){if(g!=null){e[f]=g}return}e[f]=g;c++;core.loader._setStartProgressVal(c*(100/d.length));if(c==d.length){if(a){a()}}})}};loader.prototype.loadImagesFromZip=function(d,b,c,a){if(!b||b.length==0){if(a){a()}return}core.unzip(d+"?v="+main.version,function(f){var e=1;b.forEach(function(i){var h=i;if(h.indexOf(".")<0){h+=".png"}if(h in f){var g=new Image();var j=URL.createObjectURL(f[h]);e++;g.onload=function(){e--;URL.revokeObjectURL(j);if(e==0&&a){a()}};g.src=j;c[i]=g}});e--;if(e==0&&a){a()}})};loader.prototype.loadImage=function(d,a){try{var f=d;if(f.indexOf(".")<0){f=f+".png"}var c=new Image();c.onload=function(){a(d,c)};c.onerror=function(){a(d,null)};c.src="project/images/"+f+"?v="+main.version;if(f.endsWith(".gif")){a(d,null)}}catch(b){main.log(b)}};loader.prototype._loadAnimates=function(){if(main.useCompress){core.unzip("project/animates/animates.zip?v="+main.version,function(a){for(var b in a){if(b.endsWith(".animate")){var c=b.substring(0,b.length-8);if(core.animates.indexOf(c)>=0){core.loader._loadAnimate(c,a[b])}}}},null,true)}else{core.animates.forEach(function(a){core.http("GET","project/animates/"+a+".animate?v="+main.version,null,function(b){core.loader._loadAnimate(a,b)},function(b){main.log(b);core.material.animates[a]=null},"text/plain; charset=x-user-defined")})}};loader.prototype._loadAnimate=function(d,a){try{a=JSON.parse(a);var b={};b.ratio=a.ratio;b.se=a.se;b.images=[];b.images_rev=[];a.bitmaps.forEach(function(h){if(!h){b.images.push(null)}else{try{var g=new Image();g.src=h;b.images.push(g)}catch(f){main.log(f);b.images.push(null)}}});b.frame=a.frame_max;b.frames=[];a.frames.forEach(function(f){var e=[];f.forEach(function(g){e.push({index:g[0],x:g[1],y:g[2],zoom:g[3],opacity:g[4],mirror:g[5]||0,angle:g[6]||0,})});b.frames.push(e)});core.material.animates[d]=b}catch(c){main.log(c);core.material.animates[d]=null}};loader.prototype._loadMusic=function(){core.bgms.forEach(function(a){core.loader.loadOneMusic(a)});if(main.useCompress&&core.musicStatus.audioContext){core.unzip("project/sounds/sounds.zip?v="+main.version,function(a){for(var b in a){if(core.sounds.indexOf(b)>=0){core.loader._loadOneSound_decodeData(b,a[b])}}})}else{core.sounds.forEach(function(a){core.loader.loadOneSound(a)})}core.playBgm(main.startBgm)};loader.prototype.loadOneMusic=function(b){var a=new Audio();a.preload="none";if(main.bgmRemote){a.src=main.bgmRemoteRoot+core.firstData.name+"/"+b}else{a.src="project/sounds/"+b}a.loop="loop";core.material.bgms[b]=a};loader.prototype.loadOneSound=function(b){if(core.musicStatus.audioContext!=null){core.http("GET","project/sounds/"+b+"?v="+main.version,null,function(c){core.loader._loadOneSound_decodeData(b,c)},function(c){main.log(c);core.material.sounds[b]=null},null,"arraybuffer")}else{var a=new Audio();a.src="project/sounds/"+b;core.material.sounds[b]=a}};loader.prototype._loadOneSound_decodeData=function(d,b){if(b instanceof Blob){var a=new zip.BlobReader(b);a.init(function(){a.readUint8Array(0,a.size,function(e){core.loader._loadOneSound_decodeData(d,e.buffer)})});return}try{core.musicStatus.audioContext.decodeAudioData(b,function(e){core.material.sounds[d]=e},function(f){main.log(f);core.material.sounds[d]=null})}catch(c){main.log(c);core.material.sounds[d]=null}};loader.prototype.loadBgm=function(b){b=core.getMappedName(b);if(!core.material.bgms[b]){return}if(!core.musicStatus.bgmStatus){return}var a=core.musicStatus.cachedBgms.indexOf(b);if(a>=0){core.musicStatus.cachedBgms.splice(a,1)}else{this._preloadBgm(core.material.bgms[b]);if(core.musicStatus.cachedBgms.length==core.musicStatus.cachedBgmCount){this.freeBgm(core.musicStatus.cachedBgms.pop())}}core.musicStatus.cachedBgms.unshift(b)};loader.prototype._preloadBgm=function(a){a.volume=0;a.play()};loader.prototype.freeBgm=function(a){a=core.getMappedName(a);if(!core.material.bgms[a]){return}core.musicStatus.cachedBgms=core.musicStatus.cachedBgms.filter(function(b){return b!=a});core.material.bgms[a].removeAttribute("src");core.material.bgms[a].load();core.material.bgms[a]=null;if(a==core.musicStatus.playingBgm){core.musicStatus.playingBgm=null}setTimeout(function(){core.loader.loadOneMusic(a)},3000)};