"use strict";function control(){this._init()}control.prototype._init=function(){this.controldata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.control;this.renderFrameFuncs=[];this.replayActions=[];this.resizes=[];this.registerAnimationFrame("totalTime",false,this._animationFrame_totalTime);this.registerAnimationFrame("autoSave",true,this._animationFrame_autoSave);this.registerAnimationFrame("globalAnimate",true,this._animationFrame_globalAnimate);this.registerAnimationFrame("animate",true,this._animationFrame_animate);this.registerAnimationFrame("heroMoving",true,this._animationFrame_heroMoving);this.registerAnimationFrame("weather",true,this._animationFrame_weather);this.registerAnimationFrame("tips",true,this._animateFrame_tips);this.registerAnimationFrame("parallelDo",false,this._animationFrame_parallelDo);this.registerAnimationFrame("checkConsoleOpened",true,this._animationFrame_checkConsoleOpened);this.registerReplayAction("move",this._replayAction_move);this.registerReplayAction("item",this._replayAction_item);this.registerReplayAction("equip",this._replayAction_equip);this.registerReplayAction("unEquip",this._replayAction_unEquip);this.registerReplayAction("fly",this._replayAction_fly);this.registerReplayAction("shop",this._replayAction_shop);this.registerReplayAction("turn",this._replayAction_turn);this.registerReplayAction("getNext",this._replayAction_getNext);this.registerReplayAction("moveDirectly",this._replayAction_moveDirectly);this.registerReplayAction("key",this._replayAction_key);this.registerResize("gameGroup",this._resize_gameGroup);this.registerResize("canvas",this._resize_canvas)};control.prototype.registerAnimationFrame=function(b,c,a){this.unregisterAnimationFrame(b);this.renderFrameFuncs.push({name:b,needPlaying:c,func:a})};control.prototype.unregisterAnimationFrame=function(a){this.renderFrameFuncs=this.renderFrameFuncs.filter(function(b){return b.name!=a})};control.prototype._setRequestAnimationFrame=function(){this._checkRequestAnimationFrame();core.animateFrame.totalTime=Math.max(core.animateFrame.totalTime,core.getLocalStorage("totalTime",0));var a=function(b){core.control.renderFrameFuncs.forEach(function(c){if(c.func){try{if(core.isPlaying()||!c.needPlaying){core.doFunc(c.func,core.control,b)}}catch(d){main.log(d);main.log("ERROR in requestAnimationFrame["+c.name+"]：已自动注销该项。");core.unregisterAnimationFrame(c.name)}}});window.requestAnimationFrame(a)};window.requestAnimationFrame(a)};control.prototype._checkRequestAnimationFrame=function(){(function(){var a=0;var b=["webkit","moz"];for(var c=0;c<b.length&&!window.requestAnimationFrame;++c){window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(d,f){var e=new Date().getTime();var h=Math.max(0,16.7-(e-a));var g=window.setTimeout(function(){d(e+h)},h);a=e+h;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}())};control.prototype._animationFrame_totalTime=function(a){core.animateFrame.totalTime+=a-core.animateFrame.totalTimeStart;core.animateFrame.totalTimeStart=a;if(core.isPlaying()){core.status.hero.statistics.totalTime=core.animateFrame.totalTime;core.status.hero.statistics.currTime+=a-(core.status.hero.statistics.start||a);core.status.hero.statistics.start=a}};control.prototype._animationFrame_autoSave=function(a){if(a-core.saves.autosave.time<=5000){return}core.control.checkAutosave();core.saves.autosave.time=a};control.prototype._animationFrame_globalAnimate=function(a){if(a-core.animateFrame.globalTime<=core.values.animateSpeed){return}core.status.globalAnimateStatus++;if(core.status.floorId){core.status.globalAnimateObjs.forEach(function(b){core.drawBlock(b,core.status.globalAnimateStatus%(b.event.animate||1))});core.maps._drawFloorImages(core.status.floorId,core.canvas.bg,"bg",core.status.floorAnimateObjs||[],core.status.globalAnimateStatus);core.maps._drawFloorImages(core.status.floorId,core.canvas.fg,"fg",core.status.floorAnimateObjs||[],core.status.globalAnimateStatus);core.status.autotileAnimateObjs.blocks.forEach(function(b){core.maps._drawAutotileAnimate(b,core.status.globalAnimateStatus)})}core.drawBoxAnimate();core.animateFrame.globalTime=a};control.prototype._animationFrame_animate=function(c){if(c-core.animateFrame.animateTime<50||!core.status.animateObjs||core.status.animateObjs.length==0){return}core.clearMap("animate");for(var a=0;a<core.status.animateObjs.length;a++){var b=core.status.animateObjs[a];if(b.index==b.animate.frames.length){(function(d){setTimeout(function(){if(d){d()}})})(b.callback)}}core.status.animateObjs=core.status.animateObjs.filter(function(d){return d.index<d.animate.frames.length});core.status.animateObjs.forEach(function(d){if(d.hero){core.maps._drawAnimateFrame(d.animate,core.status.heroCenter.px,core.status.heroCenter.py,d.index++)}else{core.maps._drawAnimateFrame(d.animate,d.centerX,d.centerY,d.index++)}});core.animateFrame.animateTime=c};control.prototype._animationFrame_heroMoving=function(a){if(core.status.heroMoving<=0){return}if(a-core.animateFrame.moveTime>(core.values.moveSpeed||100)){core.animateFrame.leftLeg=!core.animateFrame.leftLeg;core.animateFrame.moveTime=a}core.drawHero(core.animateFrame.leftLeg?"leftFoot":"rightFoot",4*core.status.heroMoving)};control.prototype._animationFrame_weather=function(a){var b=core.animateFrame.weather;if(a-b.time<=30||!core.dymCanvas.weather){return}core.control["_animationFrame_weather_"+b.type]();b.time=a};control.prototype._animationFrame_weather_rain=function(){var a=core.dymCanvas.weather,b=core.bigmap.offsetX,c=core.bigmap.offsetY;core.clearMap("weather");a.strokeStyle="rgba(174,194,224,0.8)";a.lineWidth=1;a.lineCap="round";core.animateFrame.weather.nodes.forEach(function(d){a.beginPath();a.moveTo(d.x-b,d.y-c);a.lineTo(d.x+d.l*d.xs-b,d.y+d.l*d.ys-c);a.stroke();d.x+=d.xs;d.y+=d.ys;if(d.x>core.bigmap.width*32||d.y>core.bigmap.height*32){d.x=Math.random()*core.bigmap.width*32;d.y=-10}});a.fill()};control.prototype._animationFrame_weather_snow=function(){var b=core.dymCanvas.weather,c=core.bigmap.offsetX,d=core.bigmap.offsetY;core.clearMap("weather");b.fillStyle="rgba(255, 255, 255, 0.8)";b.beginPath();core.animateFrame.weather.data=core.animateFrame.weather.data||0;core.animateFrame.weather.data+=0.01;var a=core.animateFrame.weather.data;core.animateFrame.weather.nodes.forEach(function(e){b.moveTo(e.x-c,e.y-d);b.arc(e.x-c,e.y-d,e.r,0,Math.PI*2,true);e.x+=Math.sin(a)*2;e.y+=Math.cos(a+e.d)+1+e.r/2;if(e.x>core.bigmap.width*32+5||e.x<-5||e.y>core.bigmap.height*32){if(Math.random()>1/3){e.x=Math.random()*core.bigmap.width*32;e.y=-10}else{if(Math.sin(a)>0){e.x=-5}else{e.x=core.bigmap.width*32+5}e.y=Math.random()*core.bigmap.height*32}}});b.fill()};control.prototype._animationFrame_weather_fog=function(){var a=core.dymCanvas.weather,c=core.bigmap.offsetX,d=core.bigmap.offsetY;core.clearMap("weather");if(core.animateFrame.weather.fog){var e=core.__PIXELS__,b=core.__PIXELS__;core.setAlpha("weather",0.5);core.animateFrame.weather.nodes.forEach(function(f){a.drawImage(core.animateFrame.weather.fog,f.x-c,f.y-d,e,b);f.x+=f.xs;f.y+=f.ys;if(f.x>core.bigmap.width*32-e/2){f.x=core.bigmap.width*32-e/2-1;f.xs=-f.xs}if(f.x<-e/2){f.x=-e/2+1;f.xs=-f.xs}if(f.y>core.bigmap.height*32-b/2){f.y=core.bigmap.height*32-b/2-1;f.ys=-f.ys}if(f.y<-b/2){f.y=-b/2+1;f.ys=-f.ys}});core.setAlpha("weather",1)}};control.prototype._animateFrame_tips=function(f){var g=core.animateFrame.tips;if(f-g.time<=30){return}var c=f-g.time;g.time=f;if(g.list.length==0){return}var a=Math.max(g.offset-5,0),d=null;var b=[];core.setFont("data","16px Arial");core.setTextAlign("data","left");core.clearMap("data",0,0,this.PIXEL,g.lastSize*50);g.lastLength=g.list.length;while(g.list.length>0){var e=g.list.shift();core.ui._drawTip_drawOne(e,a);if(e.stage==1){e.opacity+=0.05;if(e.opacity>=0.7){e.stage=2}}else{if(e.stage==2){e.time+=c;if(e.time>=2000){e.stage=3}}else{e.opacity-=0.05}}if(e.opacity>0){b.push(e);if(d==null){d=a}}a+=50}g.list=b;g.offset=d||0};control.prototype._animationFrame_parallelDo=function(a){core.control.controldata.parallelDo(a)};control.prototype._animationFrame_checkConsoleOpened=function(a){if(core.consoleOpened()){core.setFlag("__consoleOpened__",true)}};control.prototype.showStartAnimate=function(b,a){this._showStartAnimate_resetDom();if(core.flags.startUsingCanvas||b){return this._showStartAnimate_finished(core.flags.startUsingCanvas,a)}core.hideWithAnimate(core.dom.startTop,20,function(){core.control._showStartAnimate_finished(false,a)})};control.prototype._showStartAnimate_resetDom=function(){core.dom.startPanel.style.opacity=1;core.dom.startPanel.style.display="block";core.dom.startTop.style.opacity=1;core.dom.startTop.style.display="block";core.dom.startButtonGroup.style.display="none";core.dom.startButtons.style.display="block";core.dom.levelChooseButtons.style.display="none";core.status.played=false;core.clearStatus();core.clearMap("all");core.dom.musicBtn.style.display="block";core.setMusicBtn();core.events.setVolume(1,0);core.updateStatusBar()};control.prototype._showStartAnimate_finished=function(b,a){core.dom.startTop.style.display="none";core.dom.startButtonGroup.style.display="block";main.selectedButton=null;main.selectButton(0);if(b){core.startGame()}if(a){a()}};control.prototype.hideStartAnimate=function(a){core.hideWithAnimate(core.dom.startPanel,20,a)};control.prototype.isPlaying=function(){return core.status.played};control.prototype.clearStatus=function(){for(var a in core.timeout){clearTimeout(core.timeout[a]);core.timeout[a]=null}for(var a in core.interval){clearInterval(core.interval[a]);core.interval[a]=null}core.status={};core.clearStatusBar();core.deleteAllCanvas();core.status.played=false};control.prototype._initStatistics=function(a){if(!core.isset(core.status.hero.statistics)){core.status.hero.statistics={totalTime:a,currTime:0,hp:0,battle:0,money:0,experience:0,battleDamage:0,poisonDamage:0,extraDamage:0,moveDirectly:0,ignoreSteps:0,}}};control.prototype.clearAutomaticRouteNode=function(a,b){core.clearMap("route",a*32+5-core.status.automaticRoute.offsetX,b*32+5-core.status.automaticRoute.offsetY,27,27)};control.prototype.stopAutomaticRoute=function(){if(!core.status.played){return}core.status.automaticRoute.autoHeroMove=false;core.status.automaticRoute.autoStep=0;core.status.automaticRoute.destStep=0;core.status.automaticRoute.movedStep=0;core.status.automaticRoute.autoStepRoutes=[];core.status.automaticRoute.destX=null;core.status.automaticRoute.destY=null;core.status.automaticRoute.lastDirection=null;core.status.heroStop=true;if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.deleteCanvas("route")}};control.prototype.saveAndStopAutomaticRoute=function(){var a=core.status.automaticRoute;if(a.moveStepBeforeStop.length==0){a.moveStepBeforeStop=a.autoStepRoutes.slice(a.autoStep-1);if(a.moveStepBeforeStop.length>=1){a.moveStepBeforeStop[0].step-=a.movedStep}}this.stopAutomaticRoute()};control.prototype.continueAutomaticRoute=function(){var a=core.status.automaticRoute.moveStepBeforeStop;if(a.length===0||(a.length===1&&a[0].step===1)){core.status.automaticRoute.moveStepBeforeStop=[]}else{core.setAutoHeroMove(a)}};control.prototype.clearContinueAutomaticRoute=function(a){core.deleteCanvas("route");core.status.automaticRoute.moveStepBeforeStop=[];if(a){a()}};control.prototype.fillPosWithPoint=function(a){core.fillRect("ui",a.x*32+12,a.y*32+12,8,8,"#bfbfbf")};control.prototype.setAutomaticRoute=function(a,b,d){if(!core.status.played||core.status.lockControl){return}if(this._setAutomaticRoute_isMoving(a,b)){return}if(this._setAutomaticRoute_isTurning(a,b,d)){return}if(this._setAutomaticRoute_clickMoveDirectly(a,b,d)){return}var c=core.automaticRoute(a,b);if(c.length==0&&(a!=core.status.hero.loc.x||b!=core.status.hero.loc.y||d.length==0)){return}c=c.concat(d);core.status.automaticRoute.destX=a;core.status.automaticRoute.destY=b;this._setAutomaticRoute_drawRoute(c);this._setAutomaticRoute_setAutoSteps(c);core.setAutoHeroMove()};control.prototype._setAutomaticRoute_isMoving=function(a,b){if(core.status.automaticRoute.autoHeroMove){var c=core.status.automaticRoute.destX,d=core.status.automaticRoute.destY;core.stopAutomaticRoute();if(c==a&&d==b){core.status.automaticRoute.moveDirectly=true;setTimeout(function(){if(core.status.automaticRoute.moveDirectly&&core.status.heroMoving==0){core.control.tryMoveDirectly(a,b)}core.status.automaticRoute.moveDirectly=false},core.values.moveSpeed||100)}return true}return false};control.prototype._setAutomaticRoute_isTurning=function(a,b,c){if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y&&c.length==0){if(core.timeout.turnHeroTimeout==null){core.timeout.turnHeroTimeout=setTimeout(function(){core.turnHero();clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null},250)}else{clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null;core.getNextItem()}return true}if(core.timeout.turnHeroTimeout!=null){return true}return false};control.prototype._setAutomaticRoute_clickMoveDirectly=function(a,b,c){if(core.status.heroStop&&core.status.heroMoving==0){if(c.length<=1&&!core.hasFlag("__noClickMove__")&&core.control.tryMoveDirectly(a,b)){return true}}return false};control.prototype._setAutomaticRoute_drawRoute=function(h){var j=core.bigmap.width*32,k=core.bigmap.height*32,e=0,f=0;h.forEach(function(l){j=Math.min(j,l.x*32);e=Math.max(e,l.x*32);k=Math.min(k,l.y*32);f=Math.max(f,l.y*32)});core.status.automaticRoute.offsetX=j;core.status.automaticRoute.offsetY=k;var a=core.createCanvas("route",j-core.bigmap.offsetX,k-core.bigmap.offsetY,e-j+32,f-k+32,95);a.fillStyle="#bfbfbf";a.strokeStyle="#bfbfbf";a.lineWidth=8;for(var g=0;g<h.length;g++){if(g==h.length-1){a.fillRect(h[g].x*32+10-j,h[g].y*32+10-k,12,12)}else{a.beginPath();var c=h[g].x*32+16-j,d=h[g].y*32+16-k;var b=h[g].direction,i=h[g+1].direction;a.moveTo(c-core.utils.scan[b].x*11,d-core.utils.scan[b].y*11);a.lineTo(c,d);a.lineTo(c+core.utils.scan[i].x*11,d+core.utils.scan[i].y*11);a.stroke()}}};control.prototype._setAutomaticRoute_setAutoSteps=function(b){var c=0,a=null;b.forEach(function(e){var d=e.direction;if(a==null||a==d){c++}else{core.status.automaticRoute.autoStepRoutes.push({direction:a,step:c});c=1}a=d});core.status.automaticRoute.autoStepRoutes.push({direction:a,step:c})};control.prototype.setAutoHeroMove=function(a){a=a||core.status.automaticRoute.autoStepRoutes;if(a.length==0){return}core.status.automaticRoute.autoStepRoutes=a;core.status.automaticRoute.autoHeroMove=true;core.status.automaticRoute.autoStep=1;core.status.automaticRoute.destStep=a[0].step;core.moveHero(a[0].direction)};control.prototype.setHeroMoveInterval=function(a){if(core.status.heroMoving>0){return}if(core.status.replay.speed==24){core.moveOneStep(core.nextX(),core.nextY());if(a){a()}return}core.status.heroMoving=1;var b=1;if(core.status.replay.speed>3){b=2}if(core.status.replay.speed>6){b=4}if(core.status.replay.speed>12){b=8}core.interval.heroMoveInterval=window.setInterval(function(){core.status.heroMoving+=b;if(core.status.heroMoving>=8){clearInterval(core.interval.heroMoveInterval);core.status.heroMoving=0;core.moveOneStep(core.nextX(),core.nextY());if(a){a()}}},(core.values.moveSpeed||100)/8*b/core.status.replay.speed)};control.prototype.moveOneStep=function(a,b){return this.controldata.moveOneStep(a,b)};control.prototype.moveAction=function(a){if(core.status.heroMoving>0){return}var c=core.noPass(core.nextX(),core.nextY()),b=core.canMoveHero();if(c||!b){return this._moveAction_noPass(b,a)}this._moveAction_moving(a)};control.prototype._moveAction_noPass=function(b,a){core.status.route.push(core.getHeroLoc("direction"));core.status.automaticRoute.moveStepBeforeStop=[];core.status.automaticRoute.lastDirection=core.getHeroLoc("direction");if(b){core.events._trigger(core.nextX(),core.nextY())}core.drawHero();if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}if(a){a()}};control.prototype._moveAction_moving=function(a){core.setHeroMoveInterval(function(){var c=core.getHeroLoc("direction");core.control._moveAction_popAutomaticRoute();core.status.route.push(c);var e=core.getHeroLoc("x"),f=core.getHeroLoc("y");var b=core.getBlock(e,f);var d=false;if(b!=null&&b.block.event.trigger=="getItem"&&!core.floors[core.status.floorId].afterGetItem[e+","+f]){d=true;core.events._trigger(e,f)}core.checkBlock();if(!d){core.events._trigger(e,f)}core.updateStatusBar();if(core.getBgNumber()==167){core.insertAction("滑冰事件",null,null,null,true)}if(a){a()}})};control.prototype._moveAction_popAutomaticRoute=function(){var a=core.status.automaticRoute;if(a.autoHeroMove){a.movedStep++;a.lastDirection=core.getHeroLoc("direction");if(a.destStep==a.movedStep){if(a.autoStep==a.autoStepRoutes.length){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}else{a.movedStep=0;a.destStep=a.autoStepRoutes[a.autoStep].step;core.setHeroLoc("direction",a.autoStepRoutes[a.autoStep].direction);core.status.automaticRoute.autoStep++}}}};control.prototype.moveHero=function(b,a){if(core.status.heroMoving!=0){return}if(core.isset(b)){core.setHeroLoc("direction",b)}if(a){return this.moveAction(a)}this._moveHero_moving()};control.prototype._moveHero_moving=function(){core.status.heroStop=false;core.status.automaticRoute.moveDirectly=false;var a=function(){if(!core.status.heroStop){if(core.hasFlag("debug")&&core.status.ctrlDown){if(core.status.heroMoving!=0){return}var b=core.nextX(),c=core.nextY();if(b<1||b>=core.bigmap.width-1||c<1||c>=core.bigmap.height-1){return}core.status.heroMoving=-1;core.eventMoveHero([core.getHeroLoc("direction")],core.values.moveSpeed,function(){core.status.heroMoving=0;a()})}else{core.moveAction();setTimeout(a,50)}}};a()};control.prototype.isMoving=function(){return !core.status.heroStop||core.status.heroMoving>0};control.prototype.waitHeroToStop=function(a){var b=core.status.automaticRoute.lastDirection;core.stopAutomaticRoute();core.clearContinueAutomaticRoute();if(a){core.status.replay.animate=true;core.lockControl();core.status.automaticRoute.moveDirectly=false;setTimeout(function(){core.status.replay.animate=false;if(core.isset(b)){core.setHeroLoc("direction",b)}core.drawHero();a()},30)}};control.prototype.turnHero=function(a){if(a){core.setHeroLoc("direction",a);core.drawHero();core.status.route.push("turn:"+a);return}var b={up:"right",right:"down",down:"left",left:"up"};core.setHeroLoc("direction",b[core.getHeroLoc("direction")]);core.drawHero();core.status.route.push("turn")};control.prototype.moveDirectly=function(a,b,c){return this.controldata.moveDirectly(a,b,c)};control.prototype.tryMoveDirectly=function(e,f){if(this.nearHero(e,f)){return false}var a=core.maps.generateMovableArray();var h=[[e,f],[e-1,f,"right"],[e,f-1,"down"],[e,f+1,"up"],[e+1,f,"left"]];var b=core.canMoveDirectlyArray(h);for(var l=0;l<h.length;++l){var c=h[l],j=c[0],k=c[1],g=c[2];if(j<0||j>=core.bigmap.width||k<0||k>=core.bigmap.height){continue}if(g&&!core.inArray(a[j][k],g)){continue}if(b[l]<0){continue}if(core.control.moveDirectly(j,k,b[l])){if(g){core.moveHero(g,function(){})}return true}}return false};control.prototype.drawHero=function(g,d){if(!core.isPlaying()||!core.status.floorId||core.status.gameOver){return}var i=core.getHeroLoc("x"),j=core.getHeroLoc("y"),a=core.getHeroLoc("direction");g=g||"stop";d=d||0;var h=core.utils.scan[a];var b=h.x,c=h.y,e=b*d,f=c*d;core.bigmap.offsetX=32;core.bigmap.offsetY=32;core.clearAutomaticRouteNode(i+b,j+c);core.clearMap("hero");core.status.heroCenter.px=32*i+e+16;core.status.heroCenter.py=32*j+f+32-core.material.icons.hero.height/2;if(!core.hasFlag("hideHero")){this._drawHero_getDrawObjs(a,i,j,g,d).forEach(function(k){core.drawImage("hero",k.img,k.heroIcon[k.status]*k.width,k.heroIcon.loc*k.height,k.width,k.height,k.posx+(32-k.width)/2,k.posy+32-k.height,k.width,k.height)})}core.control.updateViewport();core.setGameCanvasTranslate("hero",0,0)};control.prototype._drawHero_getDrawObjs=function(a,g,h,f,e){var c=core.material.icons.hero,b=[],d=0;b.push({img:core.material.images.hero,width:core.material.icons.hero.width||32,height:core.material.icons.hero.height,heroIcon:c[a],posx:g*32-core.bigmap.offsetX+core.utils.scan[a].x*e,posy:h*32-core.bigmap.offsetY+core.utils.scan[a].y*e,status:f,index:d++,});(core.status.hero.followers||[]).forEach(function(i){b.push({img:core.material.images.images[i.name],width:core.material.images.images[i.name].width/4,height:core.material.images.images[i.name].height/4,heroIcon:c[i.direction],posx:32*i.x-core.bigmap.offsetX+(i.stop?0:core.utils.scan[i.direction].x*e),posy:32*i.y-core.bigmap.offsetY+(i.stop?0:core.utils.scan[i.direction].y*e),status:i.stop?"stop":f,index:d++})});return b.sort(function(i,j){return i.posy==j.posy?j.index-i.index:i.posy-j.posy})};control.prototype.setGameCanvasTranslate=function(b,d,e){var a=core.dom.gameCanvas[b];d=d*core.domStyle.scale;e=e*core.domStyle.scale;a.style.transform="translate("+d+"px,"+e+"px)";a.style.webkitTransform="translate("+d+"px,"+e+"px)";a.style.OTransform="translate("+d+"px,"+e+"px)";a.style.MozTransform="translate("+d+"px,"+e+"px)";if(main.mode==="editor"&&editor.isMobile){a.style.transform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)";a.style.webkitTransform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)";a.style.OTransform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)";a.style.MozTransform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)"}};control.prototype.addGameCanvasTranslate=function(f,g){for(var c=0,a;a=core.dom.gameCanvas[c];c++){var b=a.getAttribute("id");if(b=="ui"||b=="data"){continue}var d=f,e=g;if(core.bigmap.canvas.indexOf(b)>=0){d-=core.bigmap.offsetX;e-=core.bigmap.offsetY}core.control.setGameCanvasTranslate(b,d,e)}};control.prototype.updateViewport=function(){core.bigmap.canvas.forEach(function(a){core.control.setGameCanvasTranslate(a,-core.bigmap.offsetX,-core.bigmap.offsetY)});core.relocateCanvas("route",core.status.automaticRoute.offsetX-core.bigmap.offsetX,core.status.automaticRoute.offsetY-core.bigmap.offsetY)};control.prototype.setViewport=function(c,d){core.bigmap.offsetX=core.clamp(c,0,32*core.bigmap.width-core.__PIXELS__);core.bigmap.offsetY=core.clamp(d,0,32*core.bigmap.height-core.__PIXELS__);this.updateViewport();var a=core.clamp((core.getHeroLoc("x")-core.__HALF_SIZE__)*32,0,32*core.bigmap.width-core.__PIXELS__);var b=core.clamp((core.getHeroLoc("y")-core.__HALF_SIZE__)*32,0,32*core.bigmap.height-core.__PIXELS__);core.control.setGameCanvasTranslate("hero",a-core.bigmap.offsetX,b-core.bigmap.offsetY)};control.prototype.moveViewport=function(e,f,b){f=f||core.values.moveSpeed||300;var d=0,c=(e||[]).filter(function(g){return["up","down","left","right"].indexOf(g)>=0});var a=window.setInterval(function(){if(c.length==0){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}else{if(core.control._moveViewport_moving(++d,c)){d=0}}},f/16/core.status.replay.speed);core.animateFrame.asyncId[a]=true};control.prototype._moveViewport_moving=function(d,b){var a=b[0],c=core.utils.scan[a];core.setViewport(core.bigmap.offsetX+2*c.x,core.bigmap.offsetY+2*c.y);if(d==16){b.shift();return true}return false};control.prototype.nextX=function(a){if(a==null){a=1}return core.getHeroLoc("x")+core.utils.scan[core.getHeroLoc("direction")].x*a};control.prototype.nextY=function(a){if(a==null){a=1}return core.getHeroLoc("y")+core.utils.scan[core.getHeroLoc("direction")].y*a};control.prototype.nearHero=function(b,c,a){if(a==null){a=1}return Math.abs(b-core.getHeroLoc("x"))+Math.abs(c-core.getHeroLoc("y"))<=a};control.prototype.gatherFollowers=function(){var b=core.getHeroLoc("x"),c=core.getHeroLoc("y"),a=core.getHeroLoc("direction");(core.status.hero.followers||[]).forEach(function(d){d.x=b;d.y=c;d.stop=true;d.direction=a})};control.prototype.updateFollowers=function(){(core.status.hero.followers||[]).forEach(function(c){if(!c.stop){c.x+=core.utils.scan[c.direction].x;c.y+=core.utils.scan[c.direction].y}});var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");(core.status.hero.followers||[]).forEach(function(f){f.stop=true;var d=a-f.x,e=b-f.y;for(var c in core.utils.scan){if(core.utils.scan[c].x==d&&core.utils.scan[c].y==e){f.stop=false;f.direction=c}}a=f.x;b=f.y})};control.prototype.updateCheckBlock=function(a){return this.controldata.updateCheckBlock(a)};control.prototype.checkBlock=function(){var c=core.getHeroLoc("x"),d=core.getHeroLoc("y"),b=c+","+d;var a=core.status.checkBlock.damage[b];if(a){core.status.hero.hp-=a;core.drawTip("受到"+(core.status.checkBlock.type[b]||"伤害")+a+"点");core.drawHeroAnimate("zone");this._checkBlock_disableQuickShop();core.status.hero.statistics.extraDamage+=a;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose();return}}this._checkBlock_snipe(core.status.checkBlock.snipe[b]);this._checkBlock_ambush(core.status.checkBlock.ambush[b])};control.prototype._checkBlock_disableQuickShop=function(){if(core.flags.disableShopOnDamage){for(var a in core.status.shops){core.status.shops[a].visited=false}}};control.prototype._checkBlock_snipe=function(b){if(!b||b.length==0){return}var a=[];b.forEach(function(c){a.push({type:"move",loc:[c[0],c[1]],steps:[c[3]],time:500,keep:true,async:true})});a.push({type:"waitAsync"});core.insertAction(a)};control.prototype._checkBlock_ambush=function(b){if(!b||b.length==0){return}var a=[];b.forEach(function(c){a.push({type:"move",loc:[c[0],c[1]],steps:[c[3]],time:500,keep:false,async:true})});a.push({type:"waitAsync"});b.forEach(function(c){a.push({type:"battle",id:c[2]})});core.insertAction(a)};control.prototype.updateDamage=function(b,a){b=b||core.status.floorId;if(!core.isset(b)||core.status.gameOver){return}if(core.status.gameOver){return}var c=true;if(!core.isset(a)){a=core.canvas.damage;core.clearMap("damage");c=false}if(!core.hasItem("book")){return}core.setFont(a,"bold 11px Arial");this._updateDamage_damage(b,a);this._updateDamage_extraDamage(b,a,c)};control.prototype._updateDamage_damage=function(b,a){core.setTextAlign(a,"left");core.status.maps[b].blocks.forEach(function(c){var h=c.x,i=c.y;if(!c.disable&&c.event.cls.indexOf("enemy")==0&&c.event.displayDamage!==false){if(core.flags.displayEnemyDamage){var g=core.enemys.getDamageString(c.event.id,h,i,b);var f=g.damage,d=g.color;core.fillBoldText(a,f,32*h+1,32*(i+1)-1,d)}if(core.flags.displayCritical){var e=core.enemys.nextCriticals(c.event.id,1,h,i,b);e=core.formatBigNumber((e[0]||[])[0],true);if(e=="???"){e="?"}core.fillBoldText(a,e,32*h+1,32*(i+1)-11,"#FFFFFF")}}})};control.prototype._updateDamage_extraDamage=function(c,a,e){core.setTextAlign(a,"center");if(e){this.updateCheckBlock(c)}if(core.flags.displayExtraDamage){var f=core.floors[c].width,d=core.floors[c].height;for(var g=0;g<f;g++){for(var h=0;h<d;h++){var b=core.status.checkBlock.damage[g+","+h]||0;if(b>0){b=core.formatBigNumber(b,true);core.fillBoldText(a,b,32*g+16,32*(h+1)-14,"#FF7F00")}else{if(core.status.checkBlock.ambush[g+","+h]){core.fillBoldText(a,"!",32*g+16,32*(h+1)-14,"#FF7F00")}}}}}};control.prototype.chooseReplayFile=function(){core.readFile(function(b){if(b.name!=core.firstData.name){return alert("存档和游戏不一致！")}if(!b.route){return alert("无效的录像！")}var a=function(){core.startGame(core.flags.startUsingCanvas?"":b.hard||"",b.seed,core.decodeRoute(b.route))};if(b.version&&b.version!=core.firstData.version){core.myconfirm("游戏版本不一致！\n你仍然想播放录像吗？",a);return}a()},null,".h5route")};control.prototype.startReplay=function(a){if(!core.isPlaying()){return}core.status.replay.replaying=true;core.status.replay.pausing=true;core.status.replay.speed=1;core.status.replay.toReplay=core.clone(a);core.status.replay.totalList=core.status.route.concat(a);core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("开始播放");this.replay()};control.prototype.triggerReplay=function(){if(core.status.replay.pausing){this.resumeReplay()}else{this.pauseReplay()}};control.prototype.pauseReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}core.status.replay.pausing=true;core.updateStatusBar();core.drawTip("暂停播放")};control.prototype.resumeReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.status.replay.pausing=false;core.updateStatusBar();core.drawTip("恢复播放");core.replay()};control.prototype.stepReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.replay(true)};control.prototype.speedUpReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}var b=[0.2,0.5,1,2,3,6,12,24];for(var a=b.length-2;a>=0;a--){if(b[a]<=core.status.replay.speed){core.status.replay.speed=b[a+1];break}}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.speedDownReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}var b=[0.2,0.5,1,2,3,6,12,24];for(var a=1;a<=b.length;a++){if(b[a]>=core.status.replay.speed){core.status.replay.speed=b[a-1];break}}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.setReplaySpeed=function(a){if(!core.isPlaying()||!core.isReplaying()){return}core.status.replay.speed=a;core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.stopReplay=function(a){if(!core.isPlaying()){return}if(!core.isReplaying()&&!a){return}core.status.replay.toReplay=[];core.status.replay.totalList=[];core.status.replay.replaying=false;core.status.replay.pausing=false;core.status.replay.speed=1;core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("停止播放并恢复游戏")};control.prototype.rewindReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}if(core.status.replay.save.length==0){return core.drawTip("无法再回到上一个节点")}var b=core.status.replay.save,a=b.pop();core.loadData(a.data,function(){core.status.replay={replaying:true,pausing:true,animate:false,toReplay:a.replay.toReplay,totalList:a.replay.totalList,speed:a.replay.speed,steps:a.replay.steps,save:b};core.updateStatusBar();core.drawTip("成功回退到上一个节点")})};control.prototype.saveReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="save";var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)};control.prototype.bookReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||(core.status.event.id&&core.status.event.id!="viewMaps")){return core.drawTip("请等待当前事件的处理结束")}if(!core.hasItem("book")){return core.drawTip("你没有怪物手册")}if(core.status.event.id=="viewMaps"){core.status.event.ui=core.status.event.data}core.lockControl();core.status.event.id="book";core.useItem("book",true)};control.prototype.viewMapReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="viewMaps";core.ui.drawMaps()};control.prototype.toolboxReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="toolbox";core.ui.drawToolbox()};control.prototype.equipboxReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="equipbox";core.ui.drawEquipbox()};control.prototype.isReplaying=function(){return(core.status.replay||{}).replaying};control.prototype.replay=function(b){if(!core.isPlaying()||!core.isReplaying()||core.status.replay.animate||core.status.event.id){return}if(core.status.replay.pausing&&!b){return}if(core.status.replay.toReplay.length==0){return this._replay_finished()}this._replay_save();var a=core.status.replay.toReplay.shift();if(this._doReplayAction(a)){return}this._replay_error(a)};control.prototype.registerReplayAction=function(b,a){this.unregisterReplayAction(b);this.replayActions.push({name:b,func:a})};control.prototype.unregisterReplayAction=function(a){this.replayActions=this.replayActions.filter(function(c){return c.name!=a})};control.prototype._doReplayAction=function(a){for(var c in this.replayActions){try{if(core.doFunc(this.replayActions[c].func,this,a)){return true}}catch(b){main.log(b);main.log("ERROR in replayActions["+this.replayActions[c].name+"]：已自动注销该项。");core.unregisterReplayAction(this.replayActions[c].name)}}return false};control.prototype._replay_finished=function(){core.status.replay.replaying=false;core.status.event.selection=0;var a="录像播放完毕，你想退出播放吗？";if(core.status.route.length!=core.status.replay.totalList.length||core.subarray(core.status.route,core.status.replay.totalList)==null){a="录像播放完毕，但记录不一致。\n请检查录像播放时的二次记录问题。\n你想退出播放吗？"}core.ui.drawConfirmBox(a,function(){core.ui.closePanel();core.stopReplay(true)},function(){core.status.replay.replaying=true;core.ui.closePanel();core.pauseReplay()})};control.prototype._replay_save=function(){core.status.replay.steps++;if(core.status.replay.steps%40==1){if(core.status.replay.save.length==30){core.status.replay.save.shift()}core.status.replay.save.push({data:core.saveData(),replay:{totalList:core.clone(core.status.replay.totalList),toReplay:core.clone(core.status.replay.toReplay),speed:core.status.replay.speed,steps:core.status.replay.steps}})}};control.prototype._replay_error=function(a){core.ui.closePanel();core.status.replay.replaying=false;var b=core.status.replay.toReplay.length;var d=core.status.replay.totalList.slice(-b-11,-b-1);var c=core.status.replay.toReplay.slice(0,10);main.log("录像文件出错，当前操作："+a);main.log("之前的10个操作是：\n"+d.toString());main.log("接下来10个操作是：\n"+c.toString());core.ui.drawConfirmBox("录像文件出错，你想回到上个节点吗？",function(){core.ui.closePanel();if(core.status.replay.save.length>0){core.status.replay.replaying=true;core.status.replay.pausing=true;core.rewindReplay()}else{core.drawTip("无法回到上一个节点");core.stopReplay(true)}},function(){core.ui.closePanel();core.stopReplay(true)})};control.prototype.__replay_getTimeout=function(){if(core.status.replay.speed==24){return 0}return 750/Math.max(1,core.status.replay.speed)};control.prototype._replayAction_move=function(a){if(["up","down","left","right"].indexOf(a)<0){return false}core.moveHero(a,core.replay);return true};control.prototype._replayAction_item=function(a){if(a.indexOf("item:")!=0){return false}var b=a.substring(5);if(!core.canUseItem(b)){return false}core.useItem(b,false,core.replay);return true};control.prototype._replayAction_equip=function(a){if(a.indexOf("equip:")!=0){return false}var b=a.substring(6);var d=Object.keys(core.status.hero.items.equips).sort();var c=d.indexOf(b),e=core.__SIZE__-1;if(c<0){return false}core.status.route.push(a);if(core.material.items[b].hideInReplay){core.loadEquip(b,core.replay);return true}core.status.event.data={page:Math.floor(c/e)+1,selectId:null};c=c%e+e;core.ui.drawEquipbox(c);setTimeout(function(){core.ui.closePanel();core.loadEquip(b,core.replay)},core.control.__replay_getTimeout());return true};control.prototype._replayAction_unEquip=function(a){if(a.indexOf("unEquip:")!=0){return false}var b=parseInt(a.substring(8));if(!core.isset(b)){return false}core.ui.drawEquipbox(b);core.status.route.push(a);setTimeout(function(){core.ui.closePanel();core.unloadEquip(b,core.replay)},core.control.__replay_getTimeout());return true};control.prototype._replayAction_fly=function(a){if(a.indexOf("fly:")!=0){return false}var b=a.substring(4);var c=core.floorIds.indexOf(b);if(!core.canUseItem("fly")){return false}core.ui.drawFly(c);setTimeout(function(){if(!core.flyTo(b,core.replay)){core.control._replay_error(a)}},core.control.__replay_getTimeout());return true};control.prototype._replayAction_shop=function(a){if(a.indexOf("shop:")!=0){return false}var g=a.substring(5).split(":");var e=g[0],c=g[1].split("");if(c.length==0){return false}var d=core.status.shops[e];if(!d||!d.visited){return false}if(d.commonEvent||d.item){core.openShop(e,false);setTimeout(core.replay);return true}var b=d.choices;core.status.event.selection=parseInt(c.shift());core.events.openShop(e,false);var h=core.__HALF_SIZE__-parseInt(b.length/2)+(core.status.event.ui.offset||0);var f=setInterval(function(){if(!core.actions._clickShop(core.__HALF_SIZE__,h+core.status.event.selection)){clearInterval(f);core.control._replay_error(a);return}if(c.length==0){clearInterval(f);core.actions._clickShop(core.__HALF_SIZE__,h+b.length);core.replay();return}core.status.event.selection=parseInt(c.shift());core.events.openShop(e,false)},core.control.__replay_getTimeout());return true};control.prototype._replayAction_turn=function(a){if(a!="turn"&&a.indexOf("turn:")!=0){return false}if(a=="turn"){core.turnHero()}else{core.turnHero(a.substring(5))}setTimeout(core.replay);return true};control.prototype._replayAction_getNext=function(a){if(a!="getNext"){return false}if(!core.getNextItem()){return false}setTimeout(core.replay);return true};control.prototype._replayAction_moveDirectly=function(a){if(a.indexOf("move:")!=0){return false}while(core.status.replay.toReplay.length>0&&core.status.replay.toReplay[0].indexOf("move:")==0){core.status.route.push(a);a=core.status.replay.toReplay.shift()}var d=a.substring(5).split(":");var e=parseInt(d[0]),f=parseInt(d[1]);var b=core.getHeroLoc("x"),c=core.getHeroLoc("y");if(!core.moveDirectly(e,f)){return false}core.ui.drawArrow("ui",32*b+16-core.bigmap.offsetX,32*c+16-core.bigmap.offsetY,32*e+16-core.bigmap.offsetX,32*f+16-core.bigmap.offsetY,"#FF0000",3);setTimeout(function(){core.clearMap("ui");core.replay()},core.control.__replay_getTimeout());return true};control.prototype._replayAction_key=function(a){if(a.indexOf("key:")!=0){return false}core.actions.keyUp(parseInt(a.substring(4)),false,true);setTimeout(core.replay);return true};control.prototype.autosave=function(a){var b=null;if(a){b=core.status.route.pop();core.status.route.push("turn:"+core.getHeroLoc("direction"))}if(core.status.event.id=="action"){core.setFlag("__events__",core.clone(core.status.event.data))}if(core.saves.autosave.data==null){core.saves.autosave.data=[]}core.saves.autosave.data.push(core.saveData());if(core.saves.autosave.data.length>core.saves.autosave.max){core.saves.autosave.data.shift()}core.saves.autosave.updated=true;core.saves.ids[0]=true;core.removeFlag("__events__");if(a){core.status.route.pop();if(b){core.status.route.push(b)}}};control.prototype.checkAutosave=function(){if(!core.animateFrame||!core.saves||!core.saves.autosave){return}core.setLocalStorage("totalTime",core.animateFrame.totalTime);var a=core.saves.autosave;if(a.data==null||!a.updated||!a.storage){return}a.updated=false;if(a.data.length>=1){core.setLocalForage("autoSave",a.data[a.data.length-1])}};control.prototype.doSL=function(a,b){switch(b){case"save":this._doSL_save(a);break;case"load":this._doSL_load(a,this._doSL_load_afterGet);break;case"replayLoad":this._doSL_load(a,this._doSL_replayLoad_afterGet);break;case"replayRemain":this._doSL_load(a,this._doSL_replayRemain_afterGet);break}};control.prototype._doSL_save=function(a){if(a=="autoSave"){return core.drawTip("不能覆盖自动存档！")}if(core.status.event.interval!=null){core.setFlag("__events__",core.status.event.interval)}core.setLocalForage("save"+a,core.saveData(),function(){core.saves.saveIndex=a;core.setLocalStorage("saveIndex",core.saves.saveIndex);if(!core.events.recoverEvents(core.status.event.interval)){core.ui.closePanel()}core.drawTip("存档成功！")},function(b){main.log(b);if(core.platform.useLocalForage){alert("存档失败，错误信息：\n"+b)}else{alert("存档失败，错误信息：\n"+b+"\n建议使用垃圾存档清理工具进行清理！")}});core.removeFlag("__events__");return};control.prototype._doSL_load=function(c,a){if(c=="autoSave"&&core.saves.autosave.data!=null){var b=core.saves.autosave.data.pop();if(core.saves.autosave.data.length==0){core.saves.autosave.data.push(core.clone(b))}a(c,b)}else{core.getLocalForage(c=="autoSave"?c:"save"+c,null,function(d){if(c=="autoSave"&&d!=null){core.saves.autosave.data=d;if(!(core.saves.autosave.data instanceof Array)){core.saves.autosave.data=[core.saves.autosave.data]}return core.control._doSL_load(c,a)}a(c,d)},function(d){main.log(d);alert("无效的存档")})}return};control.prototype._doSL_load_afterGet=function(c,b){if(!b){return alert("无效的存档")}var a=function(){core.startGame(b.hard,b.hero.flags.__seed__,core.decodeRoute(b.route))};if(core.flags.checkConsole&&b.hashCode!=null&&b.hashCode!=core.hashCode(b.hero)){core.myconfirm("存档校验失败，请勿修改存档文件！\n你想回放此存档的录像吗？\n可以随时停止录像播放以继续游戏。",a);return}if(b.version!=core.firstData.version){core.myconfirm("存档版本不匹配！\n你想回放此存档的录像吗？\n可以随时停止录像播放以继续游戏。",a);return}core.ui.closePanel();core.loadData(b,function(){core.drawTip("读档成功");if(c!="autoSave"){core.saves.saveIndex=c;core.setLocalStorage("saveIndex",core.saves.saveIndex)}})};control.prototype._doSL_replayLoad_afterGet=function(b,a){if(!a){return core.drawTip("无效的存档")}if(a.version!=core.firstData.version){return core.drawTip("存档版本不匹配")}if(a.hard!=core.status.hard){core.drawTip("游戏难度不匹配！")}if(a.hashCode!=null&&a.hashCode!=core.utils.hashCode(a.hero)){return alert("存档校验失败，请勿修改存档文件！")}var c=core.subarray(core.status.route,core.decodeRoute(a.route));if(c==null||a.hero.flags.__seed__!=core.getFlag("__seed__")){return core.drawTip("无法从此存档回放录像")}core.loadData(a,function(){core.startReplay(c);core.drawTip("回退到存档节点")})};control.prototype._doSL_replayRemain_afterGet=function(b,a){if(!a){return core.drawTip("无效的存档")}var d=core.decodeRoute(a.route);if(core.status.tempRoute){var c=core.subarray(d,core.status.tempRoute);if(c==null){return alert("无法接续播放录像！\n该存档必须是前一个选择的存档的后续内容。")}delete core.status.tempRoute;core.ui.closePanel();core.startReplay(c);core.drawTip("接续播放录像");return}else{if(a.floorId!=core.status.floorId||a.hero.loc.x!=core.getHeroLoc("x")||a.hero.loc.y!=core.getHeroLoc("y")){return alert("楼层或坐标不一致！")}}core.status.tempRoute=d;core.ui.closePanel();core.drawText("\t[步骤2]请选择第二个存档。\n\r[yellow]该存档必须是前一个存档的后续。\r\n将尝试播放到此存档。",function(){core.status.event.id="replayRemain";core.lockControl();var g=core.saves.saveIndex;var f=parseInt((g-1)/5),e=g-5*f;core.ui.drawSLPanel(10*f+e)})};control.prototype.syncSave=function(b){core.ui.drawWaiting("正在同步，请稍后...");var a=function(c){core.control._syncSave_http(b,c)};if(b=="all"){core.getAllSaves(a)}else{core.getSave(core.saves.saveIndex,a)}};control.prototype._syncSave_http=function(c,b){if(!b){return core.drawText("没有要同步的存档")}var a=new FormData();a.append("type","save");a.append("name",core.firstData.name);a.append("data",JSON.stringify(b));core.http("POST","/games/sync.php",a,function(d){var e=JSON.parse(d);if(e.code<0){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+e.msg)}else{core.drawText((c=="all"?"所有存档":"存档"+core.saves.saveIndex)+"同步成功！\n\n您的存档编号： "+e.code+"\n您的存档密码： "+e.msg+"\n\n请牢记以上两个信息（如截图等），在从服务器\n同步存档时使用。\n\r[yellow]另外请注意，存档同步只会保存一个月的时间。\r")}},function(d){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+d)})};control.prototype.syncLoad=function(){core.myprompt("请输入存档编号",null,function(a){if(!a){return core.ui.drawSyncSave()}core.myprompt("请输入存档密码：",null,function(b){if(!b){return core.ui.drawSyncSave()}core.ui.drawWaiting("正在同步，请稍后...");core.control._syncLoad_http(a,b)})})};control.prototype._syncLoad_http=function(b,c){var a=new FormData();a.append("type","load");a.append("name",core.firstData.name);a.append("id",b);a.append("password",c);core.http("POST","/games/sync.php",a,function(d){var e=JSON.parse(d);if(e.code==0){core.control._syncLoad_write(JSON.parse(e.msg))}else{core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+e.msg)}},function(d){core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+d)})};control.prototype._syncLoad_write=function(a){if(a instanceof Array){core.status.event.selection=1;core.ui.drawConfirmBox("所有本地存档都将被覆盖，确认？",function(){for(var b=1;b<=5*(main.savePages||30);b++){if(b<=a.length){core.setLocalForage("save"+b,a[b-1])}else{if(core.saves.ids[b]){core.removeLocalForage("save"+b)}}}core.ui.closePanel();core.drawText("同步成功！\n你的本地所有存档均已被覆盖。")},function(){core.status.event.selection=0;core.ui.drawSyncSave()})}else{core.setLocalForage("save"+core.saves.saveIndex,a,function(){core.drawText("同步成功！\n单存档已覆盖至存档"+core.saves.saveIndex)})}};control.prototype.saveData=function(){return this.controldata.saveData()};control.prototype.loadData=function(b,a){return this.controldata.loadData(b,a)};control.prototype.getSave=function(b,a){if(b==0){if(core.saves.autosave.data!=null){a(core.saves.autosave.data)}else{core.getLocalForage("autoSave",null,function(c){if(c!=null){core.saves.autosave.data=c;if(!(core.saves.autosave.data instanceof Array)){core.saves.autosave.data=[core.saves.autosave.data]}}a(core.saves.autosave.data)},function(c){main.log(c);a(null)})}return}core.getLocalForage("save"+b,null,function(c){if(a){a(c)}},function(c){main.log(c);if(a){a(null)}})};control.prototype.getSaves=function(e,a){if(!(e instanceof Array)){return this.getSave(e,a)}var b=e.length,c={};for(var d=0;d<e.length;++d){(function(f){core.getSave(e[f],function(g){c[f]=g;if(Object.keys(c).length==b){a(c)}})})(d)}};control.prototype.getAllSaves=function(a){var b=Object.keys(core.saves.ids).filter(function(d){return d!=0}).sort(function(d,e){return d-e}),c=[];this.getSaves(b,function(d){for(var e=0;e<b.length;++e){if(d[e]!=null){c.push(d[e])}}a(c)})};control.prototype.getSaveIndexes=function(a){var b={};if(core.platform.useLocalForage){localforage.iterate(function(e,c,d){core.control._getSaveIndexes_getIndex(b,c)},function(){a(b)})}else{Object.keys(localStorage).forEach(function(c){core.control._getSaveIndexes_getIndex(b,c)});a(b)}};control.prototype._getSaveIndexes_getIndex=function(b,c){var a=new RegExp("^"+core.firstData.name+"_(save\\d+|autoSave)$").exec(c);if(a){if(a[1]=="autoSave"){b[0]=true}else{b[parseInt(a[1].substring(4))]=true}}};control.prototype.hasSave=function(a){return core.saves.ids[a]||false};control.prototype.removeSave=function(b,a){if(b==0||b=="autoSave"){b="autoSave";core.removeLocalForage(b,function(){core.saves.autosave.data=null;core.saves.autosave.updated=false;if(a){a()}});return}core.removeLocalForage("save"+b,function(){core.saves.favorite=core.saves.favorite.filter(function(c){return core.hasSave(c)});delete core.saves.favoriteName[b];core.control._updateFavoriteSaves();if(a){a()}},function(){core.drawTip("无法删除存档！");if(a){a()}})};control.prototype._loadFavoriteSaves=function(){core.saves.favorite=core.getLocalStorage("favorite",[]);core.saves.favorite=core.saves.favorite.filter(function(a){return core.hasSave(a)});core.saves.favoriteName=core.getLocalStorage("favoriteName",{})};control.prototype._updateFavoriteSaves=function(){core.setLocalStorage("favorite",core.saves.favorite);core.setLocalStorage("favoriteName",core.saves.favoriteName)};control.prototype.setStatus=function(a,b){if(!core.status.hero){return}if(a=="exp"){a="experience"}if(a=="x"||a=="y"||a=="direction"){this.setHeroLoc(a,b)}else{core.status.hero[a]=b}};control.prototype.addStatus=function(a,b){this.setStatus(a,this.getStatus(a)+b)};control.prototype.getStatus=function(a){if(!core.status.hero){return null}if(a=="x"||a=="y"||a=="direction"){return this.getHeroLoc(a)}if(a=="exp"){a="experience"}return core.status.hero[a]};control.prototype.getStatusOrDefault=function(b,a){if(b&&a in b){return Math.floor(b[a])}return Math.floor(this.getStatus(a))};control.prototype.getRealStatus=function(a){return this.getRealStatusOrDefault(null,a)};control.prototype.getRealStatusOrDefault=function(b,a){return Math.floor(this.getStatusOrDefault(b,a)*this.getBuff(a))};control.prototype.setBuff=function(a,b){this.setFlag("__"+a+"_buff__",b)};control.prototype.addBuff=function(a,b){this.setFlag("__"+a+"_buff__",this.getBuff(a)+b)};control.prototype.getBuff=function(a){return core.getFlag("__"+a+"_buff__",1)};control.prototype.setHeroLoc=function(a,c,b){if(!core.status.hero){return}core.status.hero.loc[a]=c;if((a=="x"||a=="y")&&!b){this.gatherFollowers()}};control.prototype.getHeroLoc=function(a){if(!core.status.hero){return}if(a==null){return core.status.hero.loc}return core.status.hero.loc[a]};control.prototype.getStatusName=function(b){var a={name:"名称",lv:"等级",hpmax:"生命上限",hp:"生命",manamax:"魔力上限",mana:"魔力",atk:"攻击",def:"防御",mdef:"魔防",money:"金币",exp:"经验",experience:"经验",steps:"步数"};return a[b]||b};control.prototype.getLvName=function(a){if(!core.status.hero){return null}if(a==null){a=core.status.hero.lv}return((core.firstData.levelUp||[])[a-1]||{}).title||a};control.prototype.setFlag=function(a,b){if(b==null){return this.removeFlag(a)}if(!core.status.hero){return}core.status.hero.flags[a]=b};control.prototype.addFlag=function(a,b){if(!core.status.hero){return}core.setFlag(a,core.getFlag(a,0)+b)};control.prototype.getFlag=function(b,a){if(!core.status.hero){return a}var c=core.status.hero.flags[b];return c!=null?c:a};control.prototype.hasFlag=function(a){return !!core.getFlag(a)};control.prototype.removeFlag=function(a){if(!core.status.hero){return}delete core.status.hero.flags[a]};control.prototype.lockControl=function(){core.status.lockControl=true};control.prototype.unLockControl=function(){core.status.lockControl=false};control.prototype.debug=function(){core.setFlag("debug",true);core.drawText("\t[调试模式开启]此模式下按住Ctrl键（或Ctrl+Shift键）可以穿墙并忽略一切事件。\n此模式下将无法上传成绩。")};control.prototype.getMappedName=function(a){return(main.nameMap||{})[a]||a};control.prototype.setWeather=function(b,a){if(b==null){core.deleteCanvas("weather");core.animateFrame.weather.type=null;core.animateFrame.weather.nodes=[];return}if(b==core.animateFrame.weather.type&&a==null){return}a=core.clamp(parseInt(a)||5,1,10);a*=parseInt(20*core.bigmap.width*core.bigmap.height/(core.__SIZE__*core.__SIZE__));core.createCanvas("weather",0,0,core.__PIXELS__,core.__PIXELS__,80);core.animateFrame.weather.type=b;core.animateFrame.weather.nodes=[];this._setWeather_createNodes(b,a)};control.prototype._setWeather_createNodes=function(d,c){switch(d){case"rain":for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*core.bigmap.width*32,y:Math.random()*core.bigmap.height*32,l:Math.random()*2.5,xs:-4+Math.random()*4+2,ys:Math.random()*10+10})}break;case"snow":for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*core.bigmap.width*32,y:Math.random()*core.bigmap.height*32,r:Math.random()*5+1,d:Math.random()*Math.min(c,200),})}break;case"fog":if(core.animateFrame.weather.fog){for(var b=0;b<c/10;b++){core.animateFrame.weather.nodes.push({x:Math.random()*core.bigmap.width*32-208,y:Math.random()*core.bigmap.height*32-208,xs:Math.random()*4-2,ys:Math.random()*4-2})}}break}};control.prototype.setCurtain=function(b,c,a){if(c==null){c=750}if(c<=0){c=0}if(!core.status.curtainColor){core.status.curtainColor=[0,0,0,0]}if(!b){b=[0,0,0,0]}if(b[3]==null){b[3]=1}b[3]=core.clamp(b[3],0,1);if(c==0){core.clearMap("curtain");core.fillRect("curtain",0,0,core.__PIXELS__,core.__PIXELS__,core.arrayToRGBA(b));core.status.curtainColor=b;if(a){a()}return}this._setCurtain_animate(core.status.curtainColor,b,c,a)};control.prototype._setCurtain_animate=function(d,c,g,b){g/=Math.max(core.status.replay.speed,1);var e=10,f=parseInt(g/e);if(f<=0){f=1}var a=setInterval(function(){d=[(d[0]*(f-1)+c[0])/f,(d[1]*(f-1)+c[1])/f,(d[2]*(f-1)+c[2])/f,(d[3]*(f-1)+c[3])/f,];core.clearMap("curtain");core.fillRect("curtain",0,0,core.__PIXELS__,core.__PIXELS__,core.arrayToRGBA(d));f--;if(f<=0){delete core.animateFrame.asyncId[a];clearInterval(a);core.status.curtainColor=c;if(core.isset(b)){b()}}},e);core.animateFrame.asyncId[a]=true};control.prototype.screenFlash=function(b,d,e,a){e=e||1;d=d/3;var c=core.clone(core.status.curtainColor);core.setCurtain(b,d,function(){core.setCurtain(c,d*2,function(){if(e>1){core.screenFlash(b,d*3,e-1,a)}else{if(a){a()}}})})};control.prototype.playBgm=function(a,c){a=core.getMappedName(a);if(main.mode!="play"||!core.material.bgms[a]){return}if(!core.musicStatus.bgmStatus){try{core.musicStatus.playingBgm=a;core.musicStatus.lastBgm=a;core.material.bgms[a].pause()}catch(b){main.log(b)}return}this.setMusicBtn();try{this._playBgm_play(a,c)}catch(b){console.log("无法播放BGM "+a);main.log(b);core.musicStatus.playingBgm=null}};control.prototype._playBgm_play=function(a,b){if(core.musicStatus.playingBgm==a&&!core.material.bgms[core.musicStatus.playingBgm].paused){return}if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].pause()}core.loader.loadBgm(a);core.material.bgms[a].volume=core.musicStatus.userVolume*core.musicStatus.designVolume;core.material.bgms[a].currentTime=b||0;core.material.bgms[a].play();core.musicStatus.playingBgm=a;core.musicStatus.lastBgm=a};control.prototype.pauseBgm=function(){if(main.mode!="play"){return}try{if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].pause();core.musicStatus.playingBgm=null}}catch(a){console.log("无法暂停BGM");main.log(a)}this.setMusicBtn()};control.prototype.resumeBgm=function(){if(main.mode!="play"){return}try{core.playBgm(core.musicStatus.playingBgm||core.musicStatus.lastBgm||main.startBgm)}catch(a){console.log("无法恢复BGM");main.log(a)}this.setMusicBtn()};control.prototype.setMusicBtn=function(){if(core.musicStatus.bgmStatus){core.dom.musicBtn.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAMAAADzN3VRAAABWVBMVEX///9iYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmL///8AAAC5ubn+/v6xsbEtLS0MDAxmZmZoaGhvb2/c3Nzd3d38/Pz9/f0oKCgpKSl0dHR1dXW6urrb29v7+/v09PTv7+/39/cgICACAgImJibh4eGFhYWGhoaHh4eOjo5paWm7u7vDw8PMzMwyMjI7OztAQEDe3t5FRUVMTEzj4+Pl5eXm5ubp6enr6+tcXFzi4uL19fVeXl74+PgjIyNkZGQGBgaSkpKYmJiampqenp4DAwMwMDBnZ2cICAivr68eHh63t7cLCwsSEhLw8PBhYWEUFBQVFRXNzc3Pz8/Z2dna2toaGhqkpKSlpaWpqamrq6tFOUNAAAAAc3RSTlMAAwQFBhUWGxwkJSYyO0dISVBRUmpvj5CSk5SVoaOlpqiysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKyA0IuUgAAAVdJREFUeF5NkVVbw0AQRTcQrLR4IIEGcidJoaUuQHF3d3d3+P/CkuxCzss8nG++mbnDBJXhNt2CpbeFK1kQpSEKidlc8S9qdATRa6UIdQMoxEpDA0Ov3wUAPfW+qLWACydNv9zMrzkJwPK6FB3oHyOfXfuNxvoBQ+GmBYinhHB77TmiVBxoYUw1AYcEq332AS8OYKosAuTT0nza9uU2USYPRJgGxEiSOFywJ3mNARozgBJJzkfLvfu8JgGDWcC9FEsjWzR+y80gYDEAA8QZ3N6kmP1Fs3fEASB7pob7Hh+Wz5L0ci17Or05J7bH6B6dZv05XWK3rG+myV05Ert592Qo55sPuoIr7hEZHHtieIPWy0RU9DLwc3Mnck/vi8/E8XNrDWQtEVnL/ySKMrv0jPwPp870fprcyYifmiEmqGpHkI5q9ofSFIUk2qiwIGpEMyxYhhZRRcMPz89RJ2s9W8wAAAAASUVORK5CYII="}else{core.dom.musicBtn.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAMAAADzN3VRAAABYlBMVEX///9iYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmL////8/PwAAABmZmZoaGihoaGioqKxsbG5ubnb29vc3Nzd3d3h4eHi4uL9/f3+/v4tLS1nZ2d0dHSUlJSenp66uroMDAz7+/spKSkoKCgUFBRpaWkVFRVvb291dXU7OzuVlZWYmJhkZGQgICAjIyOkpKQCAgK3t7cGBgbv7++pqamrq6seHh4mJiZhYWGamprp6enr6+saGhpeXl7j4+Pl5eXm5uZKSkrw8PD09PT19fW7u7vDw8PMzMwICAgwMDAyMjILCwtAQECGhoaHh4eBgYGFhYUSEhJXV1dZWVlcXFyOjo6SkpLNzc339/fPz8/Z2dna2tqTk5OlpaWxOPeTAAAAdnRSTlMAAwQFBhUWGxwkJSYyO0dISVBRUmpvj5CSk5SVoaOlpqiysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKyNuo+uwAAAWJJREFUeF5NkmV34zAQReUm7WbTuJBNunY3bvXGDjNTkZkZlpn5/9eR5FPfbzr3jGb0RkwRiMQMDm7EIgHmRxtLwMOaHHoQjwz4MUKeCM8AWMrmd7u7f/aXAMyOShHiQD1n04DtN5e5FMBFlSauIsm585dKi4CpuSYKJIv1tBDVmvOSqJgEoowFLSBHaQh10XHWiCgHWEGmAw2blPrvOK/KRJUGoLM4kCVSKrWz7HwgoiwQZyaQJ0+9PvxV23BNATAZB25IqX9b3+jTW9fcApwB6NLgUD5NY3mPXnwmFwBezff1ztzRFzTp94FXMy36HDuCa2RafdnnmZqtL818Gl9/qNnEeyrUk2aTPiKj3qMyWBVi/YSuWq5qiwxkbtX3vYWzdz/l8M0k8ERlvViiB1Ygslb7SbVtJezncj+Cx5bYaeGuonZqhZlieAp+no74/s5EAh6JcY35Cepxk4ObcT3IJPe/1lKsDpFCFQAAAABJRU5ErkJggg=="}};control.prototype.triggerBgm=function(){if(main.mode!="play"){return}core.musicStatus.bgmStatus=!core.musicStatus.bgmStatus;if(core.musicStatus.bgmStatus){this.resumeBgm()}else{this.pauseBgm()}core.setLocalStorage("bgmStatus",core.musicStatus.bgmStatus)};control.prototype.playSound=function(c){c=core.getMappedName(c);if(main.mode!="play"||!core.musicStatus.soundStatus||!core.material.sounds[c]){return}try{if(core.musicStatus.audioContext!=null){var d=core.musicStatus.audioContext.createBufferSource();d.buffer=core.material.sounds[c];d.connect(core.musicStatus.gainNode);var b=setTimeout(null);d.onended=function(){delete core.musicStatus.playingSounds[b]};if(d.start){d.start(0)}else{if(d.noteOn){d.noteOn(0)}}core.musicStatus.playingSounds[b]=d}else{core.material.sounds[c].volume=core.musicStatus.userVolume;core.material.sounds[c].play()}}catch(a){console.log("无法播放SE "+c);main.log(a)}};control.prototype.stopSound=function(){for(var b in core.musicStatus.playingSounds){var c=core.musicStatus.playingSounds[b];try{if(c.stop){c.stop()}else{if(c.noteOff){c.noteOff()}}}catch(a){main.log(a)}}core.musicStatus.playingSounds={}};control.prototype.checkBgm=function(){core.playBgm(core.musicStatus.playingBgm||main.startBgm)};control.prototype.clearStatusBar=function(){core.clearMap("outerUI")};control.prototype.updateStatusBar=function(a){if(!core.isPlaying()){return}this.controldata.updateStatusBar();if(!a){core.checkAutoEvents()}this._updateStatusBar_setToolboxIcon()};control.prototype._updateStatusBar_setToolboxIcon=function(){if(core.isReplaying()){core.statusBar.image.book.src=core.status.replay.pausing?core.statusBar.icons.play.src:core.statusBar.icons.pause.src;core.statusBar.image.book.style.opacity=1;core.statusBar.image.fly.src=core.statusBar.icons.stop.src;core.statusBar.image.fly.style.opacity=1;core.statusBar.image.toolbox.src=core.statusBar.icons.rewind.src;core.statusBar.image.keyboard.src=core.statusBar.icons.book.src;core.statusBar.image.shop.src=core.statusBar.icons.floor.src;core.statusBar.image.save.src=core.statusBar.icons.speedDown.src;core.statusBar.image.load.src=core.statusBar.icons.speedUp.src;core.statusBar.image.settings.src=core.statusBar.icons.save.src}else{core.statusBar.image.book.src=core.statusBar.icons.book.src;core.statusBar.image.book.style.opacity=core.hasItem("book")?1:0.3;if(!core.flags.equipboxButton){core.statusBar.image.fly.src=core.statusBar.icons.fly.src;core.statusBar.image.fly.style.opacity=core.hasItem("fly")?1:0.3}else{core.statusBar.image.fly.src=core.statusBar.icons.equipbox.src;core.statusBar.image.fly.style.opacity=1}core.statusBar.image.toolbox.src=core.statusBar.icons.toolbox.src;core.statusBar.image.keyboard.src=core.statusBar.icons.keyboard.src;core.statusBar.image.shop.src=core.statusBar.icons.shop.src;core.statusBar.image.save.src=core.statusBar.icons.save.src;core.statusBar.image.load.src=core.statusBar.icons.load.src;core.statusBar.image.settings.src=core.statusBar.icons.settings.src}};control.prototype.showStatusBar=function(){if(main.mode=="editor"){return}if(core.domStyle.showStatusBar){return}var b=core.dom.status;core.domStyle.showStatusBar=true;core.removeFlag("hideStatusBar");for(var a=0;a<b.length;++a){b[a].style.opacity=1}this.setToolbarButton(false);core.dom.tools.hard.style.display="block"};control.prototype.hideStatusBar=function(b){if(main.mode=="editor"){return}if(!core.domStyle.showStatusBar){this.showStatusBar()}if(core.isReplaying()){b=true}var c=core.dom.status,d=core.dom.tools;core.domStyle.showStatusBar=false;core.setFlag("hideStatusBar",true);core.setFlag("showToolbox",b||null);for(var a=0;a<c.length;++a){c[a].style.opacity=0}if(!core.domStyle.isVertical||!b){for(var a=0;a<d.length;++a){d[a].style.display="none"}}};control.prototype.updateHeroIcon=function(f){f=f||"hero.png";if(core.statusBar.icons.name==f){return}core.statusBar.icons.name=f;var d=core.material.images.hero;var i=core.material.icons.hero.width||32;var c=core.material.icons.hero.height||48;var g=Math.min(i/c,1),j=32*g,e=16-j/2;var a=document.createElement("canvas");var b=a.getContext("2d");a.width=32;a.height=32;b.drawImage(d,0,0,i,c,e,0,j,32);core.statusBar.image.name.src=a.toDataURL("image/png")};control.prototype.updateGlobalAttribute=function(d){if(d==null){d=Object.keys(core.status.globalAttribute)}if(d instanceof Array){d.forEach(function(f){core.control.updateGlobalAttribute(f)});return}var a=core.status.globalAttribute||core.initStatus.globalAttribute;if(a==null){return}switch(d){case"statusLeftBackground":if(!core.domStyle.isVertical){core.dom.statusBar.style.background=a[d]}break;case"statusTopBackground":if(core.domStyle.isVertical){core.dom.statusBar.style.background=a[d]}break;case"toolsBackground":if(core.domStyle.isVertical){core.dom.toolBar.style.background=a[d]}break;case"borderColor":var b="3px "+a[d]+" solid";core.dom.statusBar.style.borderTop=b;core.dom.statusBar.style.borderLeft=b;core.dom.statusBar.style.borderRight=core.domStyle.isVertical?b:"";core.dom.statusBar.style.borderBottom=core.domStyle.isVertical?"":b;core.dom.gameDraw.style.border=b;core.dom.toolBar.style.borderLeft=b;core.dom.toolBar.style.borderRight=core.domStyle.isVertical?b:"";core.dom.toolBar.style.borderBottom=core.domStyle.isVertical?b:"";break;case"statusBarColor":var e=core.dom.statusTexts;for(var c=0;c<e.length;c++){e[c].style.color=a[d]}break;case"hardLabelColor":core.dom.hard.style.color=a[d];break;case"floorChangingBackground":core.dom.floorMsgGroup.style.background=a[d];break;case"floorChangingTextColor":core.dom.floorMsgGroup.style.color=a[d];break}};control.prototype.setToolbarButton=function(b){if(!core.domStyle.showStatusBar){if(!core.domStyle.isVertical){for(var a=0;a<core.dom.tools.length;++a){core.dom.tools[a].style.display="none"}return}if(!core.hasFlag("showToolbox")){return}else{core.dom.tools.hard.style.display="block"}}if(b==null){b=core.domStyle.toolbarBtn}if(!core.domStyle.isVertical||core.isReplaying()){b=false}core.domStyle.toolbarBtn=b;if(b){["book","fly","toolbox","keyboard","shop","save","load","settings"].forEach(function(c){core.statusBar.image[c].style.display="none"});["btn1","btn2","btn3","btn4","btn5","btn6","btn7","btn8"].forEach(function(c){core.statusBar.image[c].style.display="block"})}else{["btn1","btn2","btn3","btn4","btn5","btn6","btn7","btn8"].forEach(function(c){core.statusBar.image[c].style.display="none"});["book","fly","toolbox","save","load","settings"].forEach(function(c){core.statusBar.image[c].style.display="block"});core.statusBar.image.keyboard.style.display=core.statusBar.image.shop.style.display=core.domStyle.isVertical?"block":"none"}};control.prototype._shouldDisplayStatus=function(c){if(c==null){var f=[],e=core.dom.status;for(var b=0;b<e.length;++b){var a=core.dom.status[b],d=a.id;if(d.indexOf("Col")!=d.length-3){continue}var c=d.substring(0,d.length-3);if(!this._shouldDisplayStatus(c)){continue}f.push(c)}return f}switch(c){case"floor":return core.flags.enableFloor;case"name":return core.flags.enableName;case"lv":return core.flags.enableLv;case"hpmax":return core.flags.enableHPMax;case"mana":return core.flags.enableMana;case"mdef":return core.flags.enableMDef;case"money":return core.flags.enableMoney;case"experience":return core.flags.enableExperience&&!core.flags.levelUpLeftMode;case"up":return core.flags.enableLevelUp;case"skill":return core.flags.enableSkill;case"key":return core.flags.enableKeys;case"pzf":return core.flags.enablePZF;case"debuff":return core.flags.enableDebuff;default:return true}};control.prototype.registerResize=function(b,a){this.unregisterResize(b);this.resizes.push({name:b,func:a})};control.prototype.unregisterResize=function(a){this.resizes=this.resizes.filter(function(c){return c.name!=a})};control.prototype._doResize=function(c){for(var b in this.resizes){try{if(core.doFunc(this.resizes[b].func,this,c)){return true}}catch(a){main.log(a);main.log("ERROR in resizes["+this.resizes[b].name+"]：已自动注销该项。");this.unregisterResize(this.resizes[b].name)}}return false};control.prototype.resize=function(){if(main.mode=="editor"){return}var f=main.dom.body.clientWidth,e=main.dom.body.clientHeight;var d=core.__PIXELS__,a=125;var c=19,b=24,h=22;var k=d+(a+c)*2;var j=d+b*2+h;if(f>=k||(f>e&&e<j)){core.domStyle.isVertical=false;core.domStyle.scale=Math.min(1,e/j)}else{core.domStyle.isVertical=false;core.domStyle.scale=Math.min(1,f/j)}var g=core.status.globalAttribute||core.initStatus.globalAttribute;var i={clientWidth:f,clientHeight:e,CANVAS_WIDTH:d,BAR_WIDTH:a,outerSize:d*core.domStyle.scale,globalAttribute:g,borderWidth:c,borderHeight:b,infoBarHeight:h,totalHeight:j*core.domStyle.scale,totalWidth:k*core.domStyle.scale};this._doResize(i);core.updateStatusBar()};control.prototype._resize_gameGroup=function(b){var a=core.dom.gameGroup;a.style.width=b.totalWidth+"px";a.style.height=b.totalHeight+"px";a.style.left=(b.clientWidth-b.totalWidth)/2+"px";a.style.top=(b.clientHeight-b.totalHeight)/2+"px";if(core.domStyle.isVertical||core.domStyle.scale<1){core.dom.musicBtn.style.right=core.dom.musicBtn.style.bottom="3px"}else{core.dom.musicBtn.style.right=(b.clientWidth-b.totalWidth)/2+"px";core.dom.musicBtn.style.bottom=(b.clientHeight-b.totalHeight)/2-27+"px"}if(core.domStyle.isVertical){core.dom.gameGroup.style.transform="rotate(90deg)"}else{core.dom.gameGroup.style.transform=""}};control.prototype._resize_canvas=function(f){var d=(f.outerSize)+"px";core.dom.data.style.width=f.totalWidth+"px";core.dom.data.style.height=f.totalHeight+"px";document.getElementById("outerBackground").style.width=f.totalWidth+"px";document.getElementById("outerBackground").style.height=f.totalHeight+"px";for(var c=0;c<core.dom.gameCanvas.length;++c){core.dom.gameCanvas[c].style.width=core.dom.gameCanvas[c].style.height=d}core.dom.gif.style.width=core.dom.gif.style.height=d;core.dom.gif2.style.width=core.dom.gif2.style.height=d;core.dom.gameDraw.style.width=core.dom.gameDraw.style.height=d;core.dom.gameDraw.style.top=f.borderHeight*core.domStyle.scale+"px";core.dom.gameDraw.style.right=(f.borderWidth+f.BAR_WIDTH+1)*core.domStyle.scale+"px";core.bigmap.canvas.forEach(function(g){core.canvas[g].canvas.style.width=core.bigmap.width*32*core.domStyle.scale+"px";core.canvas[g].canvas.style.height=core.bigmap.height*32*core.domStyle.scale+"px"});if(core.isPlaying()){this.updateViewport()}for(var e in core.dymCanvas){var b=core.dymCanvas[e],a=b.canvas;a.style.width=a.width*core.domStyle.scale+"px";a.style.height=a.height*core.domStyle.scale+"px";a.style.left=parseFloat(a.getAttribute("_left"))*core.domStyle.scale+"px";a.style.top=parseFloat(a.getAttribute("_top"))*core.domStyle.scale+"px"}main.dom.next.style.width=main.dom.next.style.height=5*core.domStyle.scale+"px";main.dom.next.style.borderBottomWidth=main.dom.next.style.borderRightWidth=4*core.domStyle.scale+"px"};