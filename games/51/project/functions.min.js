var functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a={events:{resetGame:function(d,c,a,f,g){core.clearStatus();core.status=core.clone(core.initStatus);core.status.played=true;core.status.hero=core.clone(d);core.events.setHeroIcon(core.getFlag("heroIcon","hero.png"),true);core.control._initStatistics(core.animateFrame.totalTime);core.status.hero.statistics.totalTime=core.animateFrame.totalTime=Math.max(core.status.hero.statistics.totalTime,core.animateFrame.totalTime);core.status.hero.statistics.start=null;core.status.hard=c||"";core.status.floorId=a;core.status.maps=core.clone(f);core.material.enemys=core.enemys.getEnemys();core.material.items=core.items.getItems();core.items._resetItems();core.values=core.clone(core.data.values);for(var e in g||{}){core.values[e]=g[e]}core.flags=core.clone(core.data.flags);var b=core.getFlag("globalFlags",{});for(var e in b){core.flags[e]=b[e]}core._init_sys_flags();core.resize();core.updateGlobalAttribute();if(core.hasFlag("hideStatusBar")){core.hideStatusBar(core.hasFlag("showToolbox"))}else{core.showStatusBar()}core.dom.musicBtn.style.display="none"},setInitData:function(){if(core.status.hard=="Easy"){core.setFlag("hard",1)}if(core.status.hard=="Normal"){core.setFlag("hard",2)}if(core.status.hard=="Hard"){core.setFlag("hard",3)}if(core.status.hard=="Hell"){core.setFlag("hard",4)}core.setFlag("__visited__",{});core.updateEnemys()},win:function(b,a){core.ui.closePanel();var c=core.isReplaying();if(c){core.stopReplay()}core.waitHeroToStop(function(){core.clearMap("all");core.deleteAllCanvas();core.dom.gif2.innerHTML="";core.drawText(["\t["+(b||"恭喜通关")+"]你的分数是${status:hp}。"],function(){console.log("感谢游玩!");core.events.gameOver(b||"",c,a)})})},lose:function(a){core.ui.closePanel();var b=core.isReplaying();core.stopReplay();core.waitHeroToStop(function(){core.drawText(["\t["+("游戏失败")+"]你不幸死亡了，请重新开始。"],function(){core.events.gameOver(null,b)})})},changingFloor:function(d,f,e){var c=core.status.floorId||null;core.maps.resizeMap(d);if(!e){core.status.maps[d].blocks.forEach(function(h){if(h.disable&&core.enemys.hasSpecial(h.event.id,23)){h.disable=false}})}core.status.hero.loc=f;core.control.gatherFollowers();core.drawMap(d);if(core.status.maps[d].bgm){var a=core.status.maps[d].bgm;if(a instanceof Array){a=a[0]}a=core.getFlag("ScenarioBgm",a);core.playBgm(a)}var b=core.getFlag("__color__",null);if(!b&&core.status.maps[d].color){b=core.status.maps[d].color}core.clearMap("curtain");core.status.curtainColor=b;if(b){core.fillRect("curtain",0,0,core.__PIXELS__,core.__PIXELS__,core.arrayToRGBA(b))}var g=core.getFlag("__weather__",null);if(!g&&core.status.maps[d].weather){g=core.status.maps[d].weather}if(g){core.setWeather(g[0],g[1])}else{core.setWeather()}},afterChangeFloor:function(a,b,c){if(b){core.events.recoverEvents(core.getFlag("__events__"));core.removeFlag("__events__")}else{core.status.hero.loc.direction="down";core.drawHero();core.insertAction(core.floors[a].eachArrive);if(c._floorId==":next"){core.ui.statusBar.print("登上了楼梯")}else{if(c._floorId==":before"){core.ui.statusBar.print("走下了楼梯")}}if(!core.hasVisitedFloor(a)){core.insertAction(core.floors[a].firstArrive);core.visitFloor(a)}}},flyTo:function(e,a){var b=core.status.floorId;if(!core.status.maps[b].canFlyTo||!core.status.maps[e].canFlyTo){core.drawTip("无法飞往"+core.status.maps[e].title+"！");return false}var c=core.floorIds.indexOf(b),f=core.floorIds.indexOf(e);var d=c<=f?"downFloor":"upFloor";if(c==f&&core.status.maps[b].underGround){d="upFloor"}core.status.route.push("fly:"+e);core.ui.closePanel();core.changeFloor(e,d,null,null,a);core.setFlag("talking",0);return true},beforeBattle:function(c,f,g){if(f!=null&&g!=null){var e=f+","+g,b=core.status.checkBlock.cache[e]||{},d=b.guards||[];if(d.length>0){core.setFlag("__guards__"+f+"_"+g,d);var a=[];d.forEach(function(h){core.push(a,{type:"jump",from:[h[0],h[1]],to:[f,g],time:300,keep:false,async:true})});core.push(a,[{type:"waitAsync"},{type:"trigger",loc:[f,g]}]);core.insertAction(a);return false}}return true},afterBattle:function(d,o,p,a){var c=core.material.enemys[d];var e="hand",f=(core.status.hero.equipment||[])[0];if(f&&(core.material.items[f].equip||{}).animate){e=core.material.items[f].equip.animate}if(!(core.material.animates[e]||{}).se){core.playSound("attack.mp3")}core.drawImage("animate",core.statusBar.icons.battle,0,0,32,32,(o-1)*32,(p-1)*32,32,32);setTimeout(function(){core.clearMap("animate",(o-1)*32,(p-1)*32,32,32)},100);var b=core.enemys.getDamage(d,o,p);if(b==null){b=core.status.hero.hp+1}if(core.status.hero.hp<=b){core.status.hero.hp=0;core.updateStatusBar();core.events.lose("战斗失败");return}if(core.getFlag("addhp",0)==1){b*=-1}core.status.hero.hp-=b;core.status.hero.statistics.battleDamage+=b;core.status.hero.statistics.battle++;var h=[];if(o!=null&&p!=null){if(d=="octopus"||d=="magicDragon"){core.removeBlock(o-1,p-2);core.removeBlock(o-1,p-1);core.removeBlock(o-1,p);core.removeBlock(o,p-2);core.removeBlock(o,p-1);core.removeBlock(o,p);core.removeBlock(o+1,p-2);core.removeBlock(o+1,p-1);core.removeBlock(o+1,p)}else{core.removeBlock(o,p)}h=core.getFlag("__guards__"+o+"_"+p,[]);core.removeFlag("__guards__"+o+"_"+p)}var j=h.reduce(function(q,r){return q+core.material.enemys[r[2]].money},c.money);if(core.hasItem("coin")){j*=2}if(core.hasFlag("curse")){j=0}core.status.hero.money+=j;core.status.hero.statistics.money+=j;var g=h.reduce(function(q,r){return q+core.material.enemys[r[2]].experience},c.experience);if(core.hasFlag("curse")){g=0}core.status.hero.experience+=g;core.status.hero.statistics.experience+=g;var i=c.name+" 被打败了 ";if(core.flags.enableMoney){i+="，你获得了 "+j+" 金币"}if(core.flags.enableExperience){i+="，经验+"+g}core.ui.statusBar.print(i,2);var n=[];var m=c.special;if(core.enemys.hasSpecial(m,12)){core.push(n,[{type:"insert",name:"毒衰咒处理",args:[0]}])}if(core.enemys.hasSpecial(m,13)){core.push(n,[{type:"insert",name:"毒衰咒处理",args:[1]}])}if(core.enemys.hasSpecial(m,14)){core.push(n,[{type:"insert",name:"毒衰咒处理",args:[2]}])}if(core.flags.hatredDecrease&&core.enemys.hasSpecial(m,17)){core.setFlag("hatred",Math.floor(core.getFlag("hatred",0)/2))}if(core.enemys.hasSpecial(m,19)){core.status.hero.hp=1}if(core.enemys.hasSpecial(m,21)){core.status.hero.atk-=(c.atkValue||0);core.status.hero.def-=(c.defValue||0);if(core.status.hero.atk<0){core.status.hero.atk=0}if(core.status.hero.def<0){core.status.hero.def=0}}core.setFlag("hatred",core.getFlag("hatred",0)+core.values.hatred);if(core.flags.enableSkill){var l=core.getFlag("skill",0);if(l==1){core.status.hero.mana-=5}core.setFlag("skill",0);core.setFlag("skillName","无")}core.updateStatusBar();var k=core.material.enemys[d].point;if(core.flags.enableAddPoint&&k>0){core.push(n,[{type:"insert",name:"加点事件",args:[k]}])}core.push(n,core.floors[core.status.floorId].afterBattle[o+","+p]);core.setFlag("talking",0);if(n.length>0){core.insertAction(n,o,p)}if(core.status.event.id==null){core.continueAutomaticRoute()}else{core.clearContinueAutomaticRoute()}if(a){a()}},afterOpenDoor:function(b,e,f,a){core.setFlag("talking",0);if(b.endsWith("Wall")){core.ui.statusBar.print("墙壁倒塌了")}else{core.ui.statusBar.print("门被打开了")}var d=[];var c=core.floors[core.status.floorId].afterOpenDoor[e+","+f];if(c){core.unshift(d,c)}if(d.length>0){core.insertAction(d,e,f)}if(core.status.event.id==null){core.continueAutomaticRoute()}else{core.clearContinueAutomaticRoute()}if(a){a()}},afterGetItem:function(c,e,f,a){core.playSound("item.mp3");var d=[];var b=core.floors[core.status.floorId].afterGetItem[e+","+f];if(b){core.unshift(d,b)}if(d.length>0){core.insertAction(d,e,f)}if(a){a()}},afterChangeLight:function(a,b){},afterPushBox:function(){if(core.searchBlock("box").length==0){}},afterUseBomb:function(){if(core.getFlag("bomb")>0){core.status.hero.money+=core.getFlag("bomb")}if(core.status.floorId=="MT44"&&core.terrainExists(6,8,"specialDoor")&&!core.enemyExists(5,9)&&!core.enemyExists(7,9)){core.insertAction([{type:"openDoor",loc:[6,8]},])}if(core.status.floorId=="MT45"&&core.terrainExists(7,10,"specialDoor")&&!core.enemyExists(8,9)&&!core.enemyExists(8,11)){core.insertAction([{type:"openDoor",loc:[7,10]},])}if(core.status.floorId=="MT45"&&core.terrainExists(4,10,"specialDoor")&&!core.enemyExists(5,9)&&!core.enemyExists(5,11)){core.insertAction([{type:"openDoor",loc:[4,10]},])}if(core.status.floorId=="MT49"&&core.terrainExists(6,9,"specialDoor")&&!core.enemyExists(5,10)&&!core.enemyExists(7,10)){core.insertAction([{type:"openDoor",loc:[6,9]},])}if(core.status.floorId=="MT49"&&core.terrainExists(6,7,"specialDoor")&&!core.enemyExists(5,8)&&!core.enemyExists(7,8)){core.insertAction([{type:"if",condition:"(flag:炸弹不开门==1)","true":[],"false":[{type:"openDoor",loc:[6,7]},]},])}},canUseQuickShop:function(a){if(core.status.thisMap.canUseQuickShop===false){return"当前楼层不能使用快捷商店。"}return null}},enemys:{getSpecials:function(){return[[1,"先攻","怪物首先攻击"],[2,"魔攻","怪物无视勇士的防御"],[3,"坚固","勇士每回合最多只能对怪物造成1点伤害"],[4,"2连击","怪物每回合攻击2次"],[5,"3连击","怪物每回合攻击3次"],[6,function(a){return(a.n||4)+"连击"},function(a){return"怪物每回合攻击"+(a.n||4)+"次"}],[7,"破甲","战斗前，怪物附加角色防御的"+Math.floor(100*core.values.breakArmor||0)+"%作为伤害"],[8,"反击","战斗时，怪物每回合附加角色攻击的"+Math.floor(100*core.values.counterAttack||0)+"%作为伤害，无视角色防御"],[9,"净化","战斗前，怪物附加勇士魔防的"+core.values.purify+"倍作为伤害"],[10,"模仿","怪物的攻防和勇士攻防相等"],[11,"吸血",function(a){return"战斗前，怪物首先吸取角色的"+Math.floor(100*a.value||0)+"%生命（约"+Math.floor((a.value||0)*core.getStatus("hp"))+"点）作为伤害"+(a.add?"，并把伤害数值加到自身生命上":"")}],[12,"中毒","战斗后，勇士陷入中毒状态，每一步损失生命"+core.values.poisonDamage+"点"],[13,"衰弱","战斗后，勇士陷入衰弱状态，攻防暂时下降"+(core.values.weakValue>=1?core.values.weakValue+"点":parseInt(core.values.weakValue*100)+"%")],[14,"诅咒","战斗后，勇士陷入诅咒状态，战斗无法获得金币和经验"],[15,"领域",function(a){return"经过怪物周围"+(a.range||1)+"格时自动减生命"+(a.value||0)+"点"}],[16,"夹击","经过两只相同的怪物中间，勇士生命值变成一半"],[17,"仇恨","战斗前，怪物附加之前积累的仇恨值作为伤害"+(core.flags.hatredDecrease?"；战斗后，释放一半的仇恨值":"")+"。（每杀死一个怪物获得"+(core.values.hatred||0)+"点仇恨值）"],[18,"阻击",function(a){return"经过怪物的十字领域时自动减生命"+(a.value||0)+"点，同时怪物后退一格"}],[19,"自爆","战斗后勇士的生命值变成1"],[20,"无敌","勇士无法打败怪物，除非拥有十字架"],[21,"退化",function(a){return"战斗后勇士永久下降"+(a.atkValue||0)+"点攻击和"+(a.defValue||0)+"点防御"}],[22,"固伤",function(a){return"战斗前，怪物对勇士造成"+(a.damage||0)+"点固定伤害，无视勇士魔防。"}],[23,"重生","怪物被击败后，角色转换楼层则怪物将再次出现"],[24,"激光",function(a){return"经过怪物同行或同列时自动减生命"+(a.value||0)+"点"}],[25,"光环",function(a){return"同楼层所有怪物生命提升"+(a.value||0)+"%，攻击提升"+(a.atkValue||0)+"%，防御提升"+(a.defValue||0)+"%，"+(a.add?"可叠加":"不可叠加")}],[26,"支援","当周围一圈的怪物受到攻击时将上前支援，并组成小队战斗。"],[27,"捕捉","当走到怪物周围十字时会强制进行战斗。"]]},getEnemyInfo:function(e,h,v,w,f){f=f||core.status.floorId;var k=core.getRealStatusOrDefault(h,"hp"),i=core.getRealStatusOrDefault(h,"atk"),j=core.getRealStatusOrDefault(h,"def"),l=core.getRealStatusOrDefault(h,"mdef");var r=e.hp,o=e.atk,p=e.def,u=e.special;var s=e.money,q=e.experience,t=e.point;if(core.hasSpecial(u,10)){o=i;p=j}if(core.hasSpecial(u,3)&&p<i-1){p=i-1}var m=0,a=0,d=0,c=0;var g=[];var n=v!=null&&w!=null?(v+","+w):"floor";if(!core.status.checkBlock){core.status.checkBlock={}}if(!core.status.checkBlock.cache){core.status.checkBlock.cache={}}var b=core.status.checkBlock.cache[n];if(!b){core.status.maps[f].blocks.forEach(function(x){if(!x.disable){var z=x.event.id,y=core.material.enemys[z];if(y&&core.hasSpecial(y.special,25)){if(y.add||c==0){m+=y.value||0;a+=y.atkValue||0;d+=y.defValue||0;c++}}if(y&&core.hasSpecial(y.special,26)&&v!=null&&w!=null&&Math.abs(x.x-v)<=1&&Math.abs(x.y-w)<=1&&!(v==x.x&&w==x.y)){g.push([x.x,x.y,z])}}});core.status.checkBlock.cache[n]={hp_buff:m,atk_buff:a,def_buff:d,guards:g}}else{m=b.hp_buff;a=b.atk_buff;d=b.def_buff;g=b.guards}r*=(1+m/100);o*=(1+a/100);p*=(1+d/100);return{hp:Math.floor(r),atk:Math.floor(o),def:Math.floor(p),money:Math.floor(s),experience:Math.floor(q),point:Math.floor(t),special:u,guards:g,}},getDamageInfo:function(c,l,G,H,e){e=e||core.status.floorId;var o=core.getRealStatusOrDefault(l,"hp"),m=core.getRealStatusOrDefault(l,"atk"),n=core.getRealStatusOrDefault(l,"def"),p=core.getRealStatusOrDefault(l,"mdef"),C=o,A=m,B=n;o=Math.max(0,o);m=Math.max(0,m);n=Math.max(0,n);p=Math.max(0,p);var d=core.enemys.getEnemyInfo(c,l,G,H,e);var w=d.hp,u=d.atk,v=d.def,z=d.special;if(core.hasItem("cross")&&[85,120,199].indexOf(c.atk)>=0){m*=2}if(core.hasItem("knife")&&c.atk==600){m*=2}if(core.getFlag("skill",0)==1){m*=2}if(core.hasSpecial(z,20)&&!core.hasItem("cross")){return null}var t=0;if(core.hasSpecial(z,11)){var F=o*c.value;F=Math.floor(F)||0;if(c.add){w+=F}t+=F}var D=u-n;if(core.hasSpecial(z,2)){D=u}if(D<0){D=0}if(core.hasSpecial(z,4)){D*=2}if(core.hasSpecial(z,5)){D*=3}if(core.hasSpecial(z,6)){D*=(c.n||4)}var a=0;if(core.hasSpecial(z,8)){a+=Math.floor(core.values.counterAttack*m)}if(core.hasSpecial(z,1)){t+=D}if(core.hasSpecial(z,7)){t+=Math.floor(core.values.breakArmor*n)}if(core.hasSpecial(z,9)){t+=Math.floor(core.values.purify*p)}var q=Math.max(m-v,0);if(q<=0){return null}var E=Math.ceil(w/q);var h=core.getFlag("__guards__"+G+"_"+H,d.guards);var g=false;E+=core.getFlag("__extraTurn__",0);if(h.length>0){if(!g){core.setFlag("__extraTurn__",E)}for(var r=0;r<h.length;r++){var j=h[r][0],k=h[r][1],f=h[r][2];var s=core.enemys.getDamageInfo(core.material.enemys[f],{hp:C,atk:A,def:B,mdef:0});if(s==null){return null}core.setFlag("__extraTurn__",s.turn);t+=s.damage}if(g){E+=core.getFlag("__extraTurn__",0)}}core.removeFlag("__extraTurn__");var b=t+(E-1)*D+E*a;b-=p;if(!core.flags.enableNegativeDamage){b=Math.max(0,b)}return{mon_hp:Math.floor(w),mon_atk:Math.floor(u),mon_def:Math.floor(v),init_damage:Math.floor(t),per_damage:Math.floor(D),hero_per_damage:Math.floor(q),turn:Math.floor(E),damage:Math.floor(b)}},updateEnemys:function(){if(core.hasFlag("495")){core.material.enemys.redKing.hp=800;core.material.enemys.redKing.atk=500;core.material.enemys.redKing.def=100}else{core.material.enemys.redKing.hp=8000;core.material.enemys.redKing.atk=5000;core.material.enemys.redKing.def=1000}}},actions:{onKeyUp:function(d,a){if(core.isMoving()){return}if(a&&d>=48&&d<=57){core.items.quickLoadEquip(d-48);return}switch(d){case 27:core.openSettings(true);break;case 88:core.openBook(true);break;case 71:core.useFly(true);break;case 65:core.doSL("autoSave","load");break;case 83:core.save(true);break;case 68:core.load(true);break;case 69:core.ui.drawCursor();break;case 90:core.turnHero();break;case 75:case 86:core.openQuickShop(true);break;case 32:core.getNextItem();break;case 82:core.actions._clickSyncSave_replay();break;case 33:case 34:core.ui.drawMaps();break;case 77:core.ui.drawPaint();break;case 66:core.ui.drawStatistics();break;case 72:core.ui.drawHelp();break;case 78:core.confirmRestart();break;case 79:core.actions._clickGameInfo_openProject();break;case 80:core.actions._clickGameInfo_openComments();break;case 49:if(core.hasItem("pickaxe")){if(core.canUseItem("pickaxe")){core.status.route.push("key:49");core.useItem("pickaxe",true)}else{core.drawTip("当前不能使用破墙镐")}}break;case 50:if(core.hasItem("bomb")){if(core.canUseItem("bomb")){core.status.route.push("key:50");core.useItem("bomb",true)}else{core.drawTip("当前不能使用炸弹")}}else{if(core.hasItem("hammer")){if(core.canUseItem("hammer")){core.status.route.push("key:50");core.useItem("hammer",true)}else{core.drawTip("当前不能使用圣锤")}}}break;case 51:if(core.hasItem("centerFly")){core.ui.drawCenterFly()}break;case 52:var e=["icePickaxe","snow","earthquake","upFly","downFly","jumpShoes","lifeWand","poisonWine","weakWine","curseWine","superWine"];for(var b=0;b<e.length;b++){var c=e[b];if(core.canUseItem(c)){core.status.route.push("key:52");core.useItem(c,true);break}}break;case 55:core.getNextItem();break;case 118:core.debug();break;case 87:if(core.hasItem("skill1")){core.status.route.push("key:87");core.useItem("skill1",true)}break}}},control:{saveData:function(){var c=core.clone(core.status.hero),b=core.utils.hashCode(c);var f={};for(var d in core.values){if(!core.same(core.values[d],core.data.values[d])){f[d]=core.clone(core.values[d])}}var a={floorId:core.status.floorId,hero:c,hard:core.status.hard,maps:core.maps.saveMap(),route:core.encodeRoute(core.status.route),values:f,shops:{},version:core.firstData.version,time:new Date().getTime(),hashCode:b};for(var e in core.status.shops){a.shops[e]={times:core.status.shops[e].times||0,visited:core.status.shops[e].visited||false}}return a},loadData:function(b,a){core.resetGame(b.hero,b.hard,b.floorId,core.maps.loadMap(b.maps),b.values);core.status.route=core.decodeRoute(b.route);for(var d in core.status.shops){if(b.shops[d]){core.status.shops[d].times=b.shops[d].times;core.status.shops[d].visited=b.shops[d].visited}}core.status.textAttribute=core.getFlag("textAttribute",core.status.textAttribute);var e=core.getFlag("globalAttribute",core.status.globalAttribute);if(!core.same(e,core.status.globalAttribute)){core.status.globalAttribute=e;core.updateGlobalAttribute()}core.events.setVolume(core.getFlag("__volume__",1),0);var c=core.getFlag("heroIcon","hero.png");if(core.material.images.images[c]){core.material.images.hero=core.material.images.images[c];core.material.icons.hero.height=core.material.images.images[c].height/4}core.updateEnemys();switch(core.getFlag("bgm")){case 1:core.playBgm("xiaoluoli.mp3");break;case 2:core.playBgm("wan.mp3");break;case 3:core.playBgm("huang.mp3");break;case 4:core.playBgm("xian.mp3");break;case 5:core.playBgm("chuanshuo.mp3");break;case 6:core.playBgm("ed.mp3");break;case 7:core.playBgm("hua.mp3");break;case 8:core.playBgm("migong.mp3");break;default:break}core.changeFloor(b.floorId,null,b.hero.loc,0,a,true)},updateStatusBar:function(){core.ui.statusBar.update();core.updateCheckBlock();core.updateDamage()},updateCheckBlock:function(m){m=m||core.status.floorId;if(!m||!core.status.maps){return}var F=core.floors[m].width,n=core.floors[m].height;var c=core.getMapBlocksObj(m);var f={},D={},B={},a={};for(var r in c){var b=c[r],G=b.x,H=b.y,o=b.event.id,j=core.material.enemys[o];if(o=="lavaNet"&&b.event.trigger=="passNet"&&!core.hasItem("shoes")){f[r]=(f[r]||0)+core.values.lavaDamage;D[r]="血网伤害"}if(j&&core.hasSpecial(j.special,15)&&!core.hasFlag("no_zone")){var u=j.range||1;var I=false;if(j.zoneSquare!=null){I=j.zoneSquare}for(var h=-u;h<=u;h++){for(var i=-u;i<=u;i++){if(h==0&&i==0){continue}var s=G+h,t=H+i,e=s+","+t;if(s<0||s>=F||t<0||t>=n){continue}if(!I&&Math.abs(h)+Math.abs(i)>u){continue}f[e]=(f[e]||0)+(j.value||0);if(core.getFlag("shield5")){f[e]=0}D[e]="领域伤害"}}}if(j&&core.hasSpecial(j.special,18)&&!core.hasFlag("shield5")){for(var g in core.utils.scan){var s=G+core.utils.scan[g].x,t=H+core.utils.scan[g].y,e=s+","+t;if(s<0||s>=F||t<0||t>=n){continue}f[e]=(f[e]||0)+(j.value||0);if(core.getFlag("shield5")){f[e]=0}D[e]="阻击伤害";var v=core.reverseDirection(g);var z=G+core.utils.scan[v].x,A=H+core.utils.scan[v].y;if(z>=0&&z<F&&A>=0&&A<n&&core.getBlock(z,A,m)==null){B[e]=(B[e]||[]).concat([[G,H,o,v]])}}}if(j&&core.hasSpecial(j.special,24)&&!core.hasFlag("no_laser")){for(var s=0;s<F;s++){var e=s+","+H;if(s!=G){f[e]=(f[e]||0)+(j.value||0);D[e]="激光伤害"}}for(var t=0;t<n;t++){var e=G+","+t;if(t!=H){f[e]=(f[e]||0)+(j.value||0);D[e]="激光伤害"}}}if(j&&core.enemys.hasSpecial(j.special,27)){for(var g in core.utils.scan){var s=G+core.utils.scan[g].x,t=H+core.utils.scan[g].y,e=s+","+t;if(s<0||s>=F||t<0||t>=n){continue}a[e]=(a[e]||[]).concat([[G,H,o,g]])}}}if(!core.hasFlag("no_betweenAttack")){for(var G=0;G<F;G++){for(var H=0;H<n;H++){var r=G+","+H;var l=null;var p=c[(G-1)+","+H],w=c[(G+1)+","+H];if(p&&w&&p.id==w.id){if(core.hasSpecial(p.event.id,16)){l=p.event.id}}var C=c[G+","+(H-1)],d=c[G+","+(H+1)];if(C&&d&&C.id==d.id){if(core.hasSpecial(C.event.id,16)){l=C.event.id}}if(l!=null){var q=core.status.hero.hp-(f[r]||0);if(q>1){var E=Math.floor((q+(core.flags.betweenAttackCeil?1:0))/2);if(core.getFlag("shield5")){E=0}if(core.flags.betweenAttackMax){var k=core.getDamage(l,G,H,m);if(k!=null&&k<E){E=k}}f[r]=(f[r]||0)+E;D[r]="夹击伤害"}}}}}core.status.checkBlock={damage:f,type:D,snipe:B,ambush:a,cache:{}}},moveOneStep:function(a,b){core.setHeroLoc("x",a,true);core.setHeroLoc("y",b,true);core.status.hero.steps++;core.updateFollowers();core.drawHero();if(core.hasFlag("poison")){core.status.hero.statistics.poisonDamage+=core.values.poisonDamage;core.status.hero.hp-=core.values.poisonDamage;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose();return}}core.addFlag("talking",-1);core.ui.statusBar.clearInfo();core.ui.statusBar.printEnvironmentInfo();core.updateStatusBar()},moveDirectly:function(c,d){var a=core.canMoveDirectly(c,d);if(a>=0){core.clearMap("hero");var b=core.status.route[core.status.route.length-1];if(["left","right","up","down"].indexOf(b)>=0){core.setHeroLoc("direction",b)}core.setHeroLoc("x",c);core.setHeroLoc("y",d);core.drawHero();core.status.route.push("move:"+c+":"+d);core.status.hero.statistics.moveDirectly++;core.status.hero.statistics.ignoreSteps+=a;core.ui.statusBar.clearInfo();core.ui.statusBar.printEnvironmentInfo();core.setFlag("talking",0);return true}return false},parallelDo:function(timestamp){if(!core.isPlaying()){return}if(core.status.floorId){try{eval(core.floors[core.status.floorId].parallelDo)}catch(e){main.log(e)}}}},ui:{drawStatusBar:function(){if(!core.flags.statusCanvas){return}var a=core.dom.statusCanvas,b=core.dom.statusCanvasCtx;b.clearRect(0,0,a.width,a.height);if(!core.domStyle.showStatusBar){return}b.fillStyle=core.status.globalAttribute.statusBarColor||core.initStatus.globalAttribute.statusBarColor;b.font="italic bold 18px Verdana";var d=6,i=9,e=39;if(core.domStyle.isVertical){d=6;i=6;e=32}var h=["floor","hp","atk","def","mdef","money"];for(var c=0;c<h.length;c++){var f=h[c];b.drawImage(core.statusBar.icons[f],d,i,25,25);var g=(core.statusBar[f]||{}).innerText||" ";if(!/^[-a-zA-Z0-9`~!@#$%^&*()_=+\[{\]}\\|;:'",<.>\/?]*$/.test(g)){b.font="bold 18px Verdana"}b.fillText(g,d+36,i+20);b.font="italic bold 18px Verdana";if(core.domStyle.isVertical){if(c%3!=2){d+=131}else{d=6;i+=e}}else{i+=e}}b.fillStyle="#FFCCAA";b.fillText(core.statusBar.yellowKey.innerText,d+5,i+20);b.fillStyle="#AAAADD";b.fillText(core.statusBar.blueKey.innerText,d+40,i+20);b.fillStyle="#FF8888";b.fillText(core.statusBar.redKey.innerText,d+75,i+20)},drawStatistics:function(){return["yellowDoor","blueDoor","redDoor","greenDoor","steelDoor","yellowKey","blueKey","redKey","greenKey","steelKey","redJewel","blueJewel","greenJewel","yellowJewel","redPotion","bluePotion","greenPotion","yellowPotion","superPotion","pickaxe","bomb","centerFly","icePickaxe","snow","earthquake","upFly","downFly","jumpShoes","lifeWand","poisonWine","weakWine","curseWine","superWine","sword1","sword2","sword3","sword4","sword5","shield1","shield2","shield3","shield4","shield5",]},drawAbout:function(){core.ui.closePanel();core.lockControl();core.status.event.id="about";var c=12,f=36,d=core.__PIXELS__-2*c,a=core.__PIXELS__-2*f;core.setAlpha("ui",0.85);core.fillRect("ui",c,f,d,a,"#000000");core.setAlpha("ui",1);core.drawWindowSkin("winskin.png","ui",c-1,f-1,d+1,a+1);var e=c+24;core.setTextAlign("ui","left");var b=(core.status.globalAttribute||core.initStatus.globalAttribute).font;core.fillText("ui","HTML5 魔塔样板",e,f+35,"#FFD700","bold 22px "+b);core.fillText("ui","版本： "+main.__VERSION__,e,f+80,"#FFFFFF","bold 17px "+b);core.fillText("ui","作者： 艾之葵",e,f+112);core.fillText("ui","HTML5魔塔交流群：539113091",e,f+112+32);core.fillText("ui","(C) 1998 - 2000 Oz & Kenichi",e,f+180);core.fillText("ui","(C) 1996 N.W",e,f+180+27);core.fillText("ui","H5版复刻者: 数码宝贝51 艾之葵",e,f+240);core.fillText("ui","花絮 鹿间裕贵",e+105,f+260)}}};